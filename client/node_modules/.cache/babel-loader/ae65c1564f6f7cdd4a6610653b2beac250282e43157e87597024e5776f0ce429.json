{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport * as WebGPUConstants from \"./webgpuConstants.js\";\n/** @internal */\nexport class WebGPUQuerySet {\n  constructor(count, type, device, bufferManager, canUseMultipleBuffers = true) {\n    this._dstBuffers = [];\n    this._device = device;\n    this._bufferManager = bufferManager;\n    this._count = count;\n    this._canUseMultipleBuffers = canUseMultipleBuffers;\n    this._querySet = device.createQuerySet({\n      type,\n      count\n    });\n    this._queryBuffer = bufferManager.createRawBuffer(8 * count, WebGPUConstants.BufferUsage.QueryResolve | WebGPUConstants.BufferUsage.CopySrc);\n    if (!canUseMultipleBuffers) {\n      this._dstBuffers.push(this._bufferManager.createRawBuffer(8 * this._count, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst));\n    }\n  }\n  get querySet() {\n    return this._querySet;\n  }\n  _getBuffer(firstQuery, queryCount) {\n    if (!this._canUseMultipleBuffers && this._dstBuffers.length === 0) {\n      return null;\n    }\n    const encoderResult = this._device.createCommandEncoder();\n    let buffer;\n    if (this._dstBuffers.length === 0) {\n      buffer = this._bufferManager.createRawBuffer(8 * this._count, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst);\n    } else {\n      buffer = this._dstBuffers[this._dstBuffers.length - 1];\n      this._dstBuffers.length--;\n    }\n    encoderResult.resolveQuerySet(this._querySet, firstQuery, queryCount, this._queryBuffer, 0);\n    encoderResult.copyBufferToBuffer(this._queryBuffer, 0, buffer, 0, 8 * queryCount);\n    this._device.queue.submit([encoderResult.finish()]);\n    return buffer;\n  }\n  async readValues(firstQuery = 0, queryCount = 1) {\n    const buffer = this._getBuffer(firstQuery, queryCount);\n    if (buffer === null) {\n      return null;\n    }\n    await buffer.mapAsync(WebGPUConstants.MapMode.Read);\n    const arrayBuf = new BigUint64Array(buffer.getMappedRange()).slice();\n    buffer.unmap();\n    this._dstBuffers[this._dstBuffers.length] = buffer;\n    return arrayBuf;\n  }\n  async readValue(firstQuery = 0) {\n    const buffer = this._getBuffer(firstQuery, 1);\n    if (buffer === null) {\n      return null;\n    }\n    await buffer.mapAsync(WebGPUConstants.MapMode.Read);\n    const arrayBuf = new BigUint64Array(buffer.getMappedRange());\n    const value = Number(arrayBuf[0]);\n    buffer.unmap();\n    this._dstBuffers[this._dstBuffers.length] = buffer;\n    return value;\n  }\n  async readTwoValuesAndSubtract(firstQuery = 0) {\n    const buffer = this._getBuffer(firstQuery, 2);\n    if (buffer === null) {\n      return null;\n    }\n    await buffer.mapAsync(WebGPUConstants.MapMode.Read);\n    const arrayBuf = new BigUint64Array(buffer.getMappedRange());\n    const value = Number(arrayBuf[1] - arrayBuf[0]);\n    buffer.unmap();\n    this._dstBuffers[this._dstBuffers.length] = buffer;\n    return value;\n  }\n  dispose() {\n    this._querySet.destroy();\n    this._bufferManager.releaseBuffer(this._queryBuffer);\n    for (let i = 0; i < this._dstBuffers.length; ++i) {\n      this._bufferManager.releaseBuffer(this._dstBuffers[i]);\n    }\n  }\n}","map":{"version":3,"mappings":"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","names":["WebGPUConstants","WebGPUQuerySet","constructor","count","type","device","bufferManager","canUseMultipleBuffers","_device","_bufferManager","_count","_canUseMultipleBuffers","_querySet","createQuerySet","_queryBuffer","createRawBuffer","BufferUsage","QueryResolve","CopySrc","_dstBuffers","push","MapRead","CopyDst","querySet","_getBuffer","firstQuery","queryCount","length","encoderResult","createCommandEncoder","buffer","resolveQuerySet","copyBufferToBuffer","queue","submit","finish","readValues","mapAsync","MapMode","Read","arrayBuf","BigUint64Array","getMappedRange","slice","unmap","readValue","value","Number","readTwoValuesAndSubtract","dispose","destroy","releaseBuffer","i"],"sourceRoot":"","sources":["../../../../../lts/core/generated/Engines/WebGPU/webgpuQuerySet.ts"],"sourcesContent":["import type { WebGPUBufferManager } from \"./webgpuBufferManager\";\r\nimport * as WebGPUConstants from \"./webgpuConstants\";\r\nimport type { QueryType } from \"./webgpuConstants\";\r\n\r\n/** @internal */\r\nexport class WebGPUQuerySet {\r\n    private _device: GPUDevice;\r\n    private _bufferManager: WebGPUBufferManager;\r\n\r\n    private _count: number;\r\n    private _canUseMultipleBuffers: boolean;\r\n    private _querySet: GPUQuerySet;\r\n    private _queryBuffer: GPUBuffer;\r\n    private _dstBuffers: GPUBuffer[] = [];\r\n\r\n    public get querySet(): GPUQuerySet {\r\n        return this._querySet;\r\n    }\r\n\r\n    constructor(count: number, type: QueryType, device: GPUDevice, bufferManager: WebGPUBufferManager, canUseMultipleBuffers = true) {\r\n        this._device = device;\r\n        this._bufferManager = bufferManager;\r\n        this._count = count;\r\n        this._canUseMultipleBuffers = canUseMultipleBuffers;\r\n\r\n        this._querySet = device.createQuerySet({\r\n            type,\r\n            count,\r\n        });\r\n\r\n        this._queryBuffer = bufferManager.createRawBuffer(8 * count, WebGPUConstants.BufferUsage.QueryResolve | WebGPUConstants.BufferUsage.CopySrc);\r\n\r\n        if (!canUseMultipleBuffers) {\r\n            this._dstBuffers.push(this._bufferManager.createRawBuffer(8 * this._count, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst));\r\n        }\r\n    }\r\n\r\n    private _getBuffer(firstQuery: number, queryCount: number): GPUBuffer | null {\r\n        if (!this._canUseMultipleBuffers && this._dstBuffers.length === 0) {\r\n            return null;\r\n        }\r\n\r\n        const encoderResult = this._device.createCommandEncoder();\r\n\r\n        let buffer: GPUBuffer;\r\n        if (this._dstBuffers.length === 0) {\r\n            buffer = this._bufferManager.createRawBuffer(8 * this._count, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst);\r\n        } else {\r\n            buffer = this._dstBuffers[this._dstBuffers.length - 1];\r\n            this._dstBuffers.length--;\r\n        }\r\n\r\n        encoderResult.resolveQuerySet(this._querySet, firstQuery, queryCount, this._queryBuffer, 0);\r\n        encoderResult.copyBufferToBuffer(this._queryBuffer, 0, buffer, 0, 8 * queryCount);\r\n\r\n        this._device.queue.submit([encoderResult.finish()]);\r\n\r\n        return buffer;\r\n    }\r\n\r\n    public async readValues(firstQuery = 0, queryCount = 1): Promise<BigUint64Array | null> {\r\n        const buffer = this._getBuffer(firstQuery, queryCount);\r\n        if (buffer === null) {\r\n            return null;\r\n        }\r\n\r\n        await buffer.mapAsync(WebGPUConstants.MapMode.Read);\r\n\r\n        const arrayBuf = new BigUint64Array(buffer.getMappedRange()).slice();\r\n\r\n        buffer.unmap();\r\n\r\n        this._dstBuffers[this._dstBuffers.length] = buffer;\r\n\r\n        return arrayBuf;\r\n    }\r\n\r\n    public async readValue(firstQuery = 0): Promise<number | null> {\r\n        const buffer = this._getBuffer(firstQuery, 1);\r\n        if (buffer === null) {\r\n            return null;\r\n        }\r\n\r\n        await buffer.mapAsync(WebGPUConstants.MapMode.Read);\r\n\r\n        const arrayBuf = new BigUint64Array(buffer.getMappedRange());\r\n        const value = Number(arrayBuf[0]);\r\n\r\n        buffer.unmap();\r\n\r\n        this._dstBuffers[this._dstBuffers.length] = buffer;\r\n\r\n        return value;\r\n    }\r\n\r\n    public async readTwoValuesAndSubtract(firstQuery = 0): Promise<number | null> {\r\n        const buffer = this._getBuffer(firstQuery, 2);\r\n        if (buffer === null) {\r\n            return null;\r\n        }\r\n\r\n        await buffer.mapAsync(WebGPUConstants.MapMode.Read);\r\n\r\n        const arrayBuf = new BigUint64Array(buffer.getMappedRange());\r\n        const value = Number(arrayBuf[1] - arrayBuf[0]);\r\n\r\n        buffer.unmap();\r\n\r\n        this._dstBuffers[this._dstBuffers.length] = buffer;\r\n\r\n        return value;\r\n    }\r\n\r\n    public dispose() {\r\n        this._querySet.destroy();\r\n        this._bufferManager.releaseBuffer(this._queryBuffer);\r\n        for (let i = 0; i < this._dstBuffers.length; ++i) {\r\n            this._bufferManager.releaseBuffer(this._dstBuffers[i]);\r\n        }\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { Effect } from \"../Materials/effect.js\";\nimport { CustomParticleEmitter } from \"./EmitterTypes/customParticleEmitter.js\";\nimport { UniformBufferEffectCommonAccessor } from \"../Materials/uniformBufferEffectCommonAccessor.js\";\nimport { RegisterClass } from \"../Misc/typeStore.js\";\nimport \"../Shaders/gpuUpdateParticles.fragment.js\";\nimport \"../Shaders/gpuUpdateParticles.vertex.js\";\n/** @internal */\nexport class WebGL2ParticleSystem {\n  constructor(parent, engine) {\n    this._renderVAO = [];\n    this._updateVAO = [];\n    this.alignDataInBuffer = false;\n    this._parent = parent;\n    this._engine = engine;\n    this._updateEffectOptions = {\n      attributes: [\"position\", \"initialPosition\", \"age\", \"life\", \"seed\", \"size\", \"color\", \"direction\", \"initialDirection\", \"angle\", \"cellIndex\", \"cellStartOffset\", \"noiseCoordinates1\", \"noiseCoordinates2\"],\n      uniformsNames: [\"currentCount\", \"timeDelta\", \"emitterWM\", \"lifeTime\", \"color1\", \"color2\", \"sizeRange\", \"scaleRange\", \"gravity\", \"emitPower\", \"direction1\", \"direction2\", \"minEmitBox\", \"maxEmitBox\", \"radius\", \"directionRandomizer\", \"height\", \"coneAngle\", \"stopFactor\", \"angleRange\", \"radiusRange\", \"cellInfos\", \"noiseStrength\", \"limitVelocityDamping\"],\n      uniformBuffersNames: [],\n      samplers: [\"randomSampler\", \"randomSampler2\", \"sizeGradientSampler\", \"angularSpeedGradientSampler\", \"velocityGradientSampler\", \"limitVelocityGradientSampler\", \"noiseSampler\", \"dragGradientSampler\"],\n      defines: \"\",\n      fallbacks: null,\n      onCompiled: null,\n      onError: null,\n      indexParameters: null,\n      maxSimultaneousLights: 0,\n      transformFeedbackVaryings: []\n    };\n  }\n  isUpdateBufferCreated() {\n    return !!this._updateEffect;\n  }\n  isUpdateBufferReady() {\n    var _a, _b;\n    return (_b = (_a = this._updateEffect) === null || _a === void 0 ? void 0 : _a.isReady()) !== null && _b !== void 0 ? _b : false;\n  }\n  createUpdateBuffer(defines) {\n    this._updateEffectOptions.transformFeedbackVaryings = [\"outPosition\"];\n    this._updateEffectOptions.transformFeedbackVaryings.push(\"outAge\");\n    this._updateEffectOptions.transformFeedbackVaryings.push(\"outSize\");\n    this._updateEffectOptions.transformFeedbackVaryings.push(\"outLife\");\n    this._updateEffectOptions.transformFeedbackVaryings.push(\"outSeed\");\n    this._updateEffectOptions.transformFeedbackVaryings.push(\"outDirection\");\n    if (this._parent.particleEmitterType instanceof CustomParticleEmitter) {\n      this._updateEffectOptions.transformFeedbackVaryings.push(\"outInitialPosition\");\n    }\n    if (!this._parent._colorGradientsTexture) {\n      this._updateEffectOptions.transformFeedbackVaryings.push(\"outColor\");\n    }\n    if (!this._parent._isBillboardBased) {\n      this._updateEffectOptions.transformFeedbackVaryings.push(\"outInitialDirection\");\n    }\n    if (this._parent.noiseTexture) {\n      this._updateEffectOptions.transformFeedbackVaryings.push(\"outNoiseCoordinates1\");\n      this._updateEffectOptions.transformFeedbackVaryings.push(\"outNoiseCoordinates2\");\n    }\n    this._updateEffectOptions.transformFeedbackVaryings.push(\"outAngle\");\n    if (this._parent.isAnimationSheetEnabled) {\n      this._updateEffectOptions.transformFeedbackVaryings.push(\"outCellIndex\");\n      if (this._parent.spriteRandomStartCell) {\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outCellStartOffset\");\n      }\n    }\n    this._updateEffectOptions.defines = defines;\n    this._updateEffect = new Effect(\"gpuUpdateParticles\", this._updateEffectOptions, this._engine);\n    return new UniformBufferEffectCommonAccessor(this._updateEffect);\n  }\n  createVertexBuffers(updateBuffer, renderVertexBuffers) {\n    this._updateVAO.push(this._createUpdateVAO(updateBuffer));\n    this._renderVAO.push(this._engine.recordVertexArrayObject(renderVertexBuffers, null, this._parent._getWrapper(this._parent.blendMode).effect));\n    this._engine.bindArrayBuffer(null);\n  }\n  createParticleBuffer(data) {\n    return data;\n  }\n  bindDrawBuffers(index) {\n    this._engine.bindVertexArrayObject(this._renderVAO[index], null);\n  }\n  preUpdateParticleBuffer() {\n    const engine = this._engine;\n    this._engine.enableEffect(this._updateEffect);\n    if (!engine.setState) {\n      throw new Error(\"GPU particles cannot work without a full Engine. ThinEngine is not supported\");\n    }\n  }\n  updateParticleBuffer(index, targetBuffer, currentActiveCount) {\n    this._updateEffect.setTexture(\"randomSampler\", this._parent._randomTexture);\n    this._updateEffect.setTexture(\"randomSampler2\", this._parent._randomTexture2);\n    if (this._parent._sizeGradientsTexture) {\n      this._updateEffect.setTexture(\"sizeGradientSampler\", this._parent._sizeGradientsTexture);\n    }\n    if (this._parent._angularSpeedGradientsTexture) {\n      this._updateEffect.setTexture(\"angularSpeedGradientSampler\", this._parent._angularSpeedGradientsTexture);\n    }\n    if (this._parent._velocityGradientsTexture) {\n      this._updateEffect.setTexture(\"velocityGradientSampler\", this._parent._velocityGradientsTexture);\n    }\n    if (this._parent._limitVelocityGradientsTexture) {\n      this._updateEffect.setTexture(\"limitVelocityGradientSampler\", this._parent._limitVelocityGradientsTexture);\n    }\n    if (this._parent._dragGradientsTexture) {\n      this._updateEffect.setTexture(\"dragGradientSampler\", this._parent._dragGradientsTexture);\n    }\n    if (this._parent.noiseTexture) {\n      this._updateEffect.setTexture(\"noiseSampler\", this._parent.noiseTexture);\n    }\n    // Bind source VAO\n    this._engine.bindVertexArrayObject(this._updateVAO[index], null);\n    // Update\n    const engine = this._engine;\n    engine.bindTransformFeedbackBuffer(targetBuffer.getBuffer());\n    engine.setRasterizerState(false);\n    engine.beginTransformFeedback(true);\n    engine.drawArraysType(3, 0, currentActiveCount);\n    engine.endTransformFeedback();\n    engine.setRasterizerState(true);\n    engine.bindTransformFeedbackBuffer(null);\n  }\n  releaseBuffers() {}\n  releaseVertexBuffers() {\n    for (let index = 0; index < this._updateVAO.length; index++) {\n      this._engine.releaseVertexArrayObject(this._updateVAO[index]);\n    }\n    this._updateVAO.length = 0;\n    for (let index = 0; index < this._renderVAO.length; index++) {\n      this._engine.releaseVertexArrayObject(this._renderVAO[index]);\n    }\n    this._renderVAO.length = 0;\n  }\n  _createUpdateVAO(source) {\n    const updateVertexBuffers = {};\n    updateVertexBuffers[\"position\"] = source.createVertexBuffer(\"position\", 0, 3);\n    let offset = 3;\n    updateVertexBuffers[\"age\"] = source.createVertexBuffer(\"age\", offset, 1);\n    offset += 1;\n    updateVertexBuffers[\"size\"] = source.createVertexBuffer(\"size\", offset, 3);\n    offset += 3;\n    updateVertexBuffers[\"life\"] = source.createVertexBuffer(\"life\", offset, 1);\n    offset += 1;\n    updateVertexBuffers[\"seed\"] = source.createVertexBuffer(\"seed\", offset, 4);\n    offset += 4;\n    updateVertexBuffers[\"direction\"] = source.createVertexBuffer(\"direction\", offset, 3);\n    offset += 3;\n    if (this._parent.particleEmitterType instanceof CustomParticleEmitter) {\n      updateVertexBuffers[\"initialPosition\"] = source.createVertexBuffer(\"initialPosition\", offset, 3);\n      offset += 3;\n    }\n    if (!this._parent._colorGradientsTexture) {\n      updateVertexBuffers[\"color\"] = source.createVertexBuffer(\"color\", offset, 4);\n      offset += 4;\n    }\n    if (!this._parent._isBillboardBased) {\n      updateVertexBuffers[\"initialDirection\"] = source.createVertexBuffer(\"initialDirection\", offset, 3);\n      offset += 3;\n    }\n    if (this._parent.noiseTexture) {\n      updateVertexBuffers[\"noiseCoordinates1\"] = source.createVertexBuffer(\"noiseCoordinates1\", offset, 3);\n      offset += 3;\n      updateVertexBuffers[\"noiseCoordinates2\"] = source.createVertexBuffer(\"noiseCoordinates2\", offset, 3);\n      offset += 3;\n    }\n    if (this._parent._angularSpeedGradientsTexture) {\n      updateVertexBuffers[\"angle\"] = source.createVertexBuffer(\"angle\", offset, 1);\n      offset += 1;\n    } else {\n      updateVertexBuffers[\"angle\"] = source.createVertexBuffer(\"angle\", offset, 2);\n      offset += 2;\n    }\n    if (this._parent._isAnimationSheetEnabled) {\n      updateVertexBuffers[\"cellIndex\"] = source.createVertexBuffer(\"cellIndex\", offset, 1);\n      offset += 1;\n      if (this._parent.spriteRandomStartCell) {\n        updateVertexBuffers[\"cellStartOffset\"] = source.createVertexBuffer(\"cellStartOffset\", offset, 1);\n        offset += 1;\n      }\n    }\n    const vao = this._engine.recordVertexArrayObject(updateVertexBuffers, null, this._updateEffect);\n    this._engine.bindArrayBuffer(null);\n    return vao;\n  }\n}\nRegisterClass(\"BABYLON.WebGL2ParticleSystem\", WebGL2ParticleSystem);","map":{"version":3,"mappings":"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","names":["Effect","CustomParticleEmitter","UniformBufferEffectCommonAccessor","RegisterClass","WebGL2ParticleSystem","constructor","parent","engine","_parent","_engine","_updateEffectOptions","attributes","uniformsNames","uniformBuffersNames","samplers","defines","fallbacks","onCompiled","onError","indexParameters","maxSimultaneousLights","transformFeedbackVaryings","isUpdateBufferCreated","_updateEffect","isUpdateBufferReady","isReady","createUpdateBuffer","push","particleEmitterType","_colorGradientsTexture","_isBillboardBased","noiseTexture","isAnimationSheetEnabled","spriteRandomStartCell","createVertexBuffers","updateBuffer","renderVertexBuffers","_updateVAO","_createUpdateVAO","_renderVAO","recordVertexArrayObject","_getWrapper","blendMode","effect","bindArrayBuffer","createParticleBuffer","data","bindDrawBuffers","index","bindVertexArrayObject","preUpdateParticleBuffer","enableEffect","setState","Error","updateParticleBuffer","targetBuffer","currentActiveCount","setTexture","_randomTexture","_randomTexture2","_sizeGradientsTexture","_angularSpeedGradientsTexture","_velocityGradientsTexture","_limitVelocityGradientsTexture","_dragGradientsTexture","bindTransformFeedbackBuffer","getBuffer","setRasterizerState","beginTransformFeedback","drawArraysType","endTransformFeedback","releaseBuffers","releaseVertexBuffers","length","releaseVertexArrayObject","source","updateVertexBuffers","createVertexBuffer","offset","_isAnimationSheetEnabled","vao"],"sourceRoot":"","sources":["../../../../lts/core/generated/Particles/webgl2ParticleSystem.ts"],"sourcesContent":["import type { VertexBuffer, Buffer } from \"../Buffers/buffer\";\r\nimport type { ThinEngine } from \"../Engines/thinEngine\";\r\nimport type { IEffectCreationOptions } from \"../Materials/effect\";\r\nimport { Effect } from \"../Materials/effect\";\r\nimport type { IGPUParticleSystemPlatform } from \"./IGPUParticleSystemPlatform\";\r\n\r\nimport { CustomParticleEmitter } from \"./EmitterTypes/customParticleEmitter\";\r\nimport type { GPUParticleSystem } from \"./gpuParticleSystem\";\r\nimport type { DataArray } from \"../types\";\r\nimport type { DataBuffer } from \"../Buffers/dataBuffer\";\r\nimport { UniformBufferEffectCommonAccessor } from \"../Materials/uniformBufferEffectCommonAccessor\";\r\nimport { Constants } from \"../Engines/constants\";\r\nimport { RegisterClass } from \"../Misc/typeStore\";\r\n\r\nimport \"../Shaders/gpuUpdateParticles.fragment\";\r\nimport \"../Shaders/gpuUpdateParticles.vertex\";\r\n\r\ndeclare type Engine = import(\"../Engines/engine\").Engine;\r\n\r\n/** @internal */\r\nexport class WebGL2ParticleSystem implements IGPUParticleSystemPlatform {\r\n    private _parent: GPUParticleSystem;\r\n    private _engine: ThinEngine;\r\n    private _updateEffect: Effect;\r\n    private _updateEffectOptions: IEffectCreationOptions;\r\n    private _renderVAO: WebGLVertexArrayObject[] = [];\r\n    private _updateVAO: WebGLVertexArrayObject[] = [];\r\n\r\n    public readonly alignDataInBuffer = false;\r\n\r\n    constructor(parent: GPUParticleSystem, engine: ThinEngine) {\r\n        this._parent = parent;\r\n        this._engine = engine;\r\n\r\n        this._updateEffectOptions = {\r\n            attributes: [\r\n                \"position\",\r\n                \"initialPosition\",\r\n                \"age\",\r\n                \"life\",\r\n                \"seed\",\r\n                \"size\",\r\n                \"color\",\r\n                \"direction\",\r\n                \"initialDirection\",\r\n                \"angle\",\r\n                \"cellIndex\",\r\n                \"cellStartOffset\",\r\n                \"noiseCoordinates1\",\r\n                \"noiseCoordinates2\",\r\n            ],\r\n            uniformsNames: [\r\n                \"currentCount\",\r\n                \"timeDelta\",\r\n                \"emitterWM\",\r\n                \"lifeTime\",\r\n                \"color1\",\r\n                \"color2\",\r\n                \"sizeRange\",\r\n                \"scaleRange\",\r\n                \"gravity\",\r\n                \"emitPower\",\r\n                \"direction1\",\r\n                \"direction2\",\r\n                \"minEmitBox\",\r\n                \"maxEmitBox\",\r\n                \"radius\",\r\n                \"directionRandomizer\",\r\n                \"height\",\r\n                \"coneAngle\",\r\n                \"stopFactor\",\r\n                \"angleRange\",\r\n                \"radiusRange\",\r\n                \"cellInfos\",\r\n                \"noiseStrength\",\r\n                \"limitVelocityDamping\",\r\n            ],\r\n            uniformBuffersNames: [],\r\n            samplers: [\r\n                \"randomSampler\",\r\n                \"randomSampler2\",\r\n                \"sizeGradientSampler\",\r\n                \"angularSpeedGradientSampler\",\r\n                \"velocityGradientSampler\",\r\n                \"limitVelocityGradientSampler\",\r\n                \"noiseSampler\",\r\n                \"dragGradientSampler\",\r\n            ],\r\n            defines: \"\",\r\n            fallbacks: null,\r\n            onCompiled: null,\r\n            onError: null,\r\n            indexParameters: null,\r\n            maxSimultaneousLights: 0,\r\n            transformFeedbackVaryings: [],\r\n        };\r\n    }\r\n\r\n    public isUpdateBufferCreated(): boolean {\r\n        return !!this._updateEffect;\r\n    }\r\n\r\n    public isUpdateBufferReady(): boolean {\r\n        return this._updateEffect?.isReady() ?? false;\r\n    }\r\n\r\n    public createUpdateBuffer(defines: string): UniformBufferEffectCommonAccessor {\r\n        this._updateEffectOptions.transformFeedbackVaryings = [\"outPosition\"];\r\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outAge\");\r\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outSize\");\r\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outLife\");\r\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outSeed\");\r\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outDirection\");\r\n\r\n        if (this._parent.particleEmitterType instanceof CustomParticleEmitter) {\r\n            this._updateEffectOptions.transformFeedbackVaryings.push(\"outInitialPosition\");\r\n        }\r\n\r\n        if (!this._parent._colorGradientsTexture) {\r\n            this._updateEffectOptions.transformFeedbackVaryings.push(\"outColor\");\r\n        }\r\n\r\n        if (!this._parent._isBillboardBased) {\r\n            this._updateEffectOptions.transformFeedbackVaryings.push(\"outInitialDirection\");\r\n        }\r\n\r\n        if (this._parent.noiseTexture) {\r\n            this._updateEffectOptions.transformFeedbackVaryings.push(\"outNoiseCoordinates1\");\r\n            this._updateEffectOptions.transformFeedbackVaryings.push(\"outNoiseCoordinates2\");\r\n        }\r\n\r\n        this._updateEffectOptions.transformFeedbackVaryings.push(\"outAngle\");\r\n\r\n        if (this._parent.isAnimationSheetEnabled) {\r\n            this._updateEffectOptions.transformFeedbackVaryings.push(\"outCellIndex\");\r\n            if (this._parent.spriteRandomStartCell) {\r\n                this._updateEffectOptions.transformFeedbackVaryings.push(\"outCellStartOffset\");\r\n            }\r\n        }\r\n\r\n        this._updateEffectOptions.defines = defines;\r\n        this._updateEffect = new Effect(\"gpuUpdateParticles\", this._updateEffectOptions, this._engine);\r\n\r\n        return new UniformBufferEffectCommonAccessor(this._updateEffect);\r\n    }\r\n\r\n    public createVertexBuffers(updateBuffer: Buffer, renderVertexBuffers: { [key: string]: VertexBuffer }): void {\r\n        this._updateVAO.push(this._createUpdateVAO(updateBuffer));\r\n\r\n        this._renderVAO.push(this._engine.recordVertexArrayObject(renderVertexBuffers, null, this._parent._getWrapper(this._parent.blendMode).effect!));\r\n        this._engine.bindArrayBuffer(null);\r\n    }\r\n\r\n    public createParticleBuffer(data: number[]): DataArray | DataBuffer {\r\n        return data;\r\n    }\r\n\r\n    public bindDrawBuffers(index: number): void {\r\n        this._engine.bindVertexArrayObject(this._renderVAO[index], null);\r\n    }\r\n\r\n    public preUpdateParticleBuffer(): void {\r\n        const engine = this._engine as Engine;\r\n\r\n        this._engine.enableEffect(this._updateEffect);\r\n\r\n        if (!engine.setState) {\r\n            throw new Error(\"GPU particles cannot work without a full Engine. ThinEngine is not supported\");\r\n        }\r\n    }\r\n\r\n    public updateParticleBuffer(index: number, targetBuffer: Buffer, currentActiveCount: number): void {\r\n        this._updateEffect.setTexture(\"randomSampler\", this._parent._randomTexture);\r\n        this._updateEffect.setTexture(\"randomSampler2\", this._parent._randomTexture2);\r\n\r\n        if (this._parent._sizeGradientsTexture) {\r\n            this._updateEffect.setTexture(\"sizeGradientSampler\", this._parent._sizeGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._angularSpeedGradientsTexture) {\r\n            this._updateEffect.setTexture(\"angularSpeedGradientSampler\", this._parent._angularSpeedGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._velocityGradientsTexture) {\r\n            this._updateEffect.setTexture(\"velocityGradientSampler\", this._parent._velocityGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._limitVelocityGradientsTexture) {\r\n            this._updateEffect.setTexture(\"limitVelocityGradientSampler\", this._parent._limitVelocityGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._dragGradientsTexture) {\r\n            this._updateEffect.setTexture(\"dragGradientSampler\", this._parent._dragGradientsTexture);\r\n        }\r\n\r\n        if (this._parent.noiseTexture) {\r\n            this._updateEffect.setTexture(\"noiseSampler\", this._parent.noiseTexture);\r\n        }\r\n\r\n        // Bind source VAO\r\n        this._engine.bindVertexArrayObject(this._updateVAO[index], null);\r\n\r\n        // Update\r\n        const engine = this._engine as Engine;\r\n\r\n        engine.bindTransformFeedbackBuffer(targetBuffer.getBuffer());\r\n        engine.setRasterizerState(false);\r\n        engine.beginTransformFeedback(true);\r\n        engine.drawArraysType(Constants.MATERIAL_PointListDrawMode, 0, currentActiveCount);\r\n        engine.endTransformFeedback();\r\n        engine.setRasterizerState(true);\r\n        engine.bindTransformFeedbackBuffer(null);\r\n    }\r\n\r\n    public releaseBuffers(): void {}\r\n\r\n    public releaseVertexBuffers(): void {\r\n        for (let index = 0; index < this._updateVAO.length; index++) {\r\n            this._engine.releaseVertexArrayObject(this._updateVAO[index]);\r\n        }\r\n        this._updateVAO.length = 0;\r\n\r\n        for (let index = 0; index < this._renderVAO.length; index++) {\r\n            this._engine.releaseVertexArrayObject(this._renderVAO[index]);\r\n        }\r\n        this._renderVAO.length = 0;\r\n    }\r\n\r\n    private _createUpdateVAO(source: Buffer): WebGLVertexArrayObject {\r\n        const updateVertexBuffers: { [key: string]: VertexBuffer } = {};\r\n        updateVertexBuffers[\"position\"] = source.createVertexBuffer(\"position\", 0, 3);\r\n\r\n        let offset = 3;\r\n        updateVertexBuffers[\"age\"] = source.createVertexBuffer(\"age\", offset, 1);\r\n        offset += 1;\r\n        updateVertexBuffers[\"size\"] = source.createVertexBuffer(\"size\", offset, 3);\r\n        offset += 3;\r\n        updateVertexBuffers[\"life\"] = source.createVertexBuffer(\"life\", offset, 1);\r\n        offset += 1;\r\n        updateVertexBuffers[\"seed\"] = source.createVertexBuffer(\"seed\", offset, 4);\r\n        offset += 4;\r\n        updateVertexBuffers[\"direction\"] = source.createVertexBuffer(\"direction\", offset, 3);\r\n        offset += 3;\r\n\r\n        if (this._parent.particleEmitterType instanceof CustomParticleEmitter) {\r\n            updateVertexBuffers[\"initialPosition\"] = source.createVertexBuffer(\"initialPosition\", offset, 3);\r\n            offset += 3;\r\n        }\r\n\r\n        if (!this._parent._colorGradientsTexture) {\r\n            updateVertexBuffers[\"color\"] = source.createVertexBuffer(\"color\", offset, 4);\r\n            offset += 4;\r\n        }\r\n\r\n        if (!this._parent._isBillboardBased) {\r\n            updateVertexBuffers[\"initialDirection\"] = source.createVertexBuffer(\"initialDirection\", offset, 3);\r\n            offset += 3;\r\n        }\r\n\r\n        if (this._parent.noiseTexture) {\r\n            updateVertexBuffers[\"noiseCoordinates1\"] = source.createVertexBuffer(\"noiseCoordinates1\", offset, 3);\r\n            offset += 3;\r\n            updateVertexBuffers[\"noiseCoordinates2\"] = source.createVertexBuffer(\"noiseCoordinates2\", offset, 3);\r\n            offset += 3;\r\n        }\r\n\r\n        if (this._parent._angularSpeedGradientsTexture) {\r\n            updateVertexBuffers[\"angle\"] = source.createVertexBuffer(\"angle\", offset, 1);\r\n            offset += 1;\r\n        } else {\r\n            updateVertexBuffers[\"angle\"] = source.createVertexBuffer(\"angle\", offset, 2);\r\n            offset += 2;\r\n        }\r\n\r\n        if (this._parent._isAnimationSheetEnabled) {\r\n            updateVertexBuffers[\"cellIndex\"] = source.createVertexBuffer(\"cellIndex\", offset, 1);\r\n            offset += 1;\r\n            if (this._parent.spriteRandomStartCell) {\r\n                updateVertexBuffers[\"cellStartOffset\"] = source.createVertexBuffer(\"cellStartOffset\", offset, 1);\r\n                offset += 1;\r\n            }\r\n        }\r\n\r\n        const vao = this._engine.recordVertexArrayObject(updateVertexBuffers, null, this._updateEffect);\r\n        this._engine.bindArrayBuffer(null);\r\n\r\n        return vao;\r\n    }\r\n}\r\n\r\nRegisterClass(\"BABYLON.WebGL2ParticleSystem\", WebGL2ParticleSystem);\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
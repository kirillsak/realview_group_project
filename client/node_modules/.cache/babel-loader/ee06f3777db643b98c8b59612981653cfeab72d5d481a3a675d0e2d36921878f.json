{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { Observable } from \"../Misc/observable.js\";\nimport { WebXRInputSource } from \"./webXRInputSource.js\";\nimport { WebXRMotionControllerManager } from \"./motionController/webXRMotionControllerManager.js\";\n/**\n * XR input used to track XR inputs such as controllers/rays\n */\nexport class WebXRInput {\n  /**\n   * Initializes the WebXRInput\n   * @param xrSessionManager the xr session manager for this session\n   * @param xrCamera the WebXR camera for this session. Mainly used for teleportation\n   * @param _options = initialization options for this xr input\n   */\n  constructor(\n  /**\n   * the xr session manager for this session\n   */\n  xrSessionManager,\n  /**\n   * the WebXR camera for this session. Mainly used for teleportation\n   */\n  xrCamera, _options = {}) {\n    this.xrSessionManager = xrSessionManager;\n    this.xrCamera = xrCamera;\n    this._options = _options;\n    /**\n     * XR controllers being tracked\n     */\n    this.controllers = [];\n    /**\n     * Event when a controller has been connected/added\n     */\n    this.onControllerAddedObservable = new Observable();\n    /**\n     * Event when a controller has been removed/disconnected\n     */\n    this.onControllerRemovedObservable = new Observable();\n    this._onInputSourcesChange = event => {\n      this._addAndRemoveControllers(event.added, event.removed);\n    };\n    // Remove controllers when exiting XR\n    this._sessionEndedObserver = this.xrSessionManager.onXRSessionEnded.add(() => {\n      this._addAndRemoveControllers([], this.controllers.map(c => {\n        return c.inputSource;\n      }));\n    });\n    this._sessionInitObserver = this.xrSessionManager.onXRSessionInit.add(session => {\n      session.addEventListener(\"inputsourceschange\", this._onInputSourcesChange);\n    });\n    this._frameObserver = this.xrSessionManager.onXRFrameObservable.add(frame => {\n      // Update controller pose info\n      this.controllers.forEach(controller => {\n        controller.updateFromXRFrame(frame, this.xrSessionManager.referenceSpace, this.xrCamera);\n      });\n    });\n    if (this._options.customControllersRepositoryURL) {\n      WebXRMotionControllerManager.BaseRepositoryUrl = this._options.customControllersRepositoryURL;\n    }\n    WebXRMotionControllerManager.UseOnlineRepository = !this._options.disableOnlineControllerRepository;\n    if (WebXRMotionControllerManager.UseOnlineRepository) {\n      // pre-load the profiles list to load the controllers quicker afterwards\n      try {\n        WebXRMotionControllerManager.UpdateProfilesList().catch(() => {\n          WebXRMotionControllerManager.UseOnlineRepository = false;\n        });\n      } catch (e) {\n        WebXRMotionControllerManager.UseOnlineRepository = false;\n      }\n    }\n  }\n  _addAndRemoveControllers(addInputs, removeInputs) {\n    // Add controllers if they don't already exist\n    const sources = this.controllers.map(c => {\n      return c.inputSource;\n    });\n    for (const input of addInputs) {\n      if (sources.indexOf(input) === -1) {\n        const controller = new WebXRInputSource(this.xrSessionManager.scene, input, {\n          ...(this._options.controllerOptions || {}),\n          forceControllerProfile: this._options.forceInputProfile,\n          doNotLoadControllerMesh: this._options.doNotLoadControllerMeshes,\n          disableMotionControllerAnimation: this._options.disableControllerAnimation\n        });\n        this.controllers.push(controller);\n        this.onControllerAddedObservable.notifyObservers(controller);\n      }\n    }\n    // Remove and dispose of controllers to be disposed\n    const keepControllers = [];\n    const removedControllers = [];\n    this.controllers.forEach(c => {\n      if (removeInputs.indexOf(c.inputSource) === -1) {\n        keepControllers.push(c);\n      } else {\n        removedControllers.push(c);\n      }\n    });\n    this.controllers = keepControllers;\n    removedControllers.forEach(c => {\n      this.onControllerRemovedObservable.notifyObservers(c);\n      c.dispose();\n    });\n  }\n  /**\n   * Disposes of the object\n   */\n  dispose() {\n    this.controllers.forEach(c => {\n      c.dispose();\n    });\n    this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver);\n    this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver);\n    this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver);\n    this.onControllerAddedObservable.clear();\n    this.onControllerRemovedObservable.clear();\n    // clear the controller cache\n    WebXRMotionControllerManager.ClearControllerCache();\n  }\n}","map":{"version":3,"mappings":"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","names":["Observable","WebXRInputSource","WebXRMotionControllerManager","WebXRInput","constructor","xrSessionManager","xrCamera","_options","event","_addAndRemoveControllers","added","removed","_sessionEndedObserver","onXRSessionEnded","add","controllers","map","c","inputSource","_sessionInitObserver","onXRSessionInit","session","addEventListener","_onInputSourcesChange","_frameObserver","onXRFrameObservable","frame","forEach","controller","updateFromXRFrame","referenceSpace","customControllersRepositoryURL","BaseRepositoryUrl","UseOnlineRepository","disableOnlineControllerRepository","UpdateProfilesList","catch","e","addInputs","removeInputs","sources","input","indexOf","scene","controllerOptions","forceControllerProfile","forceInputProfile","doNotLoadControllerMesh","doNotLoadControllerMeshes","disableMotionControllerAnimation","disableControllerAnimation","push","onControllerAddedObservable","notifyObservers","keepControllers","removedControllers","onControllerRemovedObservable","dispose","remove","clear","ClearControllerCache"],"sourceRoot":"","sources":["../../../../lts/core/generated/XR/webXRInput.ts"],"sourcesContent":["import type { Nullable } from \"../types\";\r\nimport type { Observer } from \"../Misc/observable\";\r\nimport { Observable } from \"../Misc/observable\";\r\nimport type { IDisposable } from \"../scene\";\r\nimport type { IWebXRControllerOptions } from \"./webXRInputSource\";\r\nimport { WebXRInputSource } from \"./webXRInputSource\";\r\nimport type { WebXRSessionManager } from \"./webXRSessionManager\";\r\nimport type { WebXRCamera } from \"./webXRCamera\";\r\nimport { WebXRMotionControllerManager } from \"./motionController/webXRMotionControllerManager\";\r\n\r\n/**\r\n * The schema for initialization options of the XR Input class\r\n */\r\nexport interface IWebXRInputOptions {\r\n    /**\r\n     * If set to true no model will be automatically loaded\r\n     */\r\n    doNotLoadControllerMeshes?: boolean;\r\n\r\n    /**\r\n     * If set, this profile will be used for all controllers loaded (for example \"microsoft-mixed-reality\")\r\n     * If not found, the xr input profile data will be used.\r\n     * Profiles are defined here - https://github.com/immersive-web/webxr-input-profiles/\r\n     */\r\n    forceInputProfile?: string;\r\n\r\n    /**\r\n     * Do not send a request to the controller repository to load the profile.\r\n     *\r\n     * Instead, use the controllers available in babylon itself.\r\n     */\r\n    disableOnlineControllerRepository?: boolean;\r\n\r\n    /**\r\n     * A custom URL for the controllers repository\r\n     */\r\n    customControllersRepositoryURL?: string;\r\n\r\n    /**\r\n     * Should the controller model's components not move according to the user input\r\n     */\r\n    disableControllerAnimation?: boolean;\r\n\r\n    /**\r\n     * Optional options to pass to the controller. Will be overridden by the Input options where applicable\r\n     */\r\n    controllerOptions?: IWebXRControllerOptions;\r\n}\r\n/**\r\n * XR input used to track XR inputs such as controllers/rays\r\n */\r\nexport class WebXRInput implements IDisposable {\r\n    /**\r\n     * XR controllers being tracked\r\n     */\r\n    public controllers: Array<WebXRInputSource> = [];\r\n    private _frameObserver: Nullable<Observer<any>>;\r\n    private _sessionEndedObserver: Nullable<Observer<any>>;\r\n    private _sessionInitObserver: Nullable<Observer<any>>;\r\n    /**\r\n     * Event when a controller has been connected/added\r\n     */\r\n    public onControllerAddedObservable = new Observable<WebXRInputSource>();\r\n    /**\r\n     * Event when a controller has been removed/disconnected\r\n     */\r\n    public onControllerRemovedObservable = new Observable<WebXRInputSource>();\r\n\r\n    /**\r\n     * Initializes the WebXRInput\r\n     * @param xrSessionManager the xr session manager for this session\r\n     * @param xrCamera the WebXR camera for this session. Mainly used for teleportation\r\n     * @param _options = initialization options for this xr input\r\n     */\r\n    public constructor(\r\n        /**\r\n         * the xr session manager for this session\r\n         */\r\n        public xrSessionManager: WebXRSessionManager,\r\n        /**\r\n         * the WebXR camera for this session. Mainly used for teleportation\r\n         */\r\n        public xrCamera: WebXRCamera,\r\n        private readonly _options: IWebXRInputOptions = {}\r\n    ) {\r\n        // Remove controllers when exiting XR\r\n        this._sessionEndedObserver = this.xrSessionManager.onXRSessionEnded.add(() => {\r\n            this._addAndRemoveControllers(\r\n                [],\r\n                this.controllers.map((c) => {\r\n                    return c.inputSource;\r\n                })\r\n            );\r\n        });\r\n\r\n        this._sessionInitObserver = this.xrSessionManager.onXRSessionInit.add((session) => {\r\n            session.addEventListener(\"inputsourceschange\", this._onInputSourcesChange);\r\n        });\r\n\r\n        this._frameObserver = this.xrSessionManager.onXRFrameObservable.add((frame) => {\r\n            // Update controller pose info\r\n            this.controllers.forEach((controller) => {\r\n                controller.updateFromXRFrame(frame, this.xrSessionManager.referenceSpace, this.xrCamera);\r\n            });\r\n        });\r\n\r\n        if (this._options.customControllersRepositoryURL) {\r\n            WebXRMotionControllerManager.BaseRepositoryUrl = this._options.customControllersRepositoryURL;\r\n        }\r\n\r\n        WebXRMotionControllerManager.UseOnlineRepository = !this._options.disableOnlineControllerRepository;\r\n        if (WebXRMotionControllerManager.UseOnlineRepository) {\r\n            // pre-load the profiles list to load the controllers quicker afterwards\r\n            try {\r\n                WebXRMotionControllerManager.UpdateProfilesList().catch(() => {\r\n                    WebXRMotionControllerManager.UseOnlineRepository = false;\r\n                });\r\n            } catch (e) {\r\n                WebXRMotionControllerManager.UseOnlineRepository = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    private _onInputSourcesChange = (event: XRInputSourceChangeEvent) => {\r\n        this._addAndRemoveControllers(event.added, event.removed);\r\n    };\r\n\r\n    private _addAndRemoveControllers(addInputs: readonly XRInputSource[], removeInputs: readonly XRInputSource[]) {\r\n        // Add controllers if they don't already exist\r\n        const sources = this.controllers.map((c) => {\r\n            return c.inputSource;\r\n        });\r\n        for (const input of addInputs) {\r\n            if (sources.indexOf(input) === -1) {\r\n                const controller = new WebXRInputSource(this.xrSessionManager.scene, input, {\r\n                    ...(this._options.controllerOptions || {}),\r\n                    forceControllerProfile: this._options.forceInputProfile,\r\n                    doNotLoadControllerMesh: this._options.doNotLoadControllerMeshes,\r\n                    disableMotionControllerAnimation: this._options.disableControllerAnimation,\r\n                });\r\n                this.controllers.push(controller);\r\n                this.onControllerAddedObservable.notifyObservers(controller);\r\n            }\r\n        }\r\n\r\n        // Remove and dispose of controllers to be disposed\r\n        const keepControllers: Array<WebXRInputSource> = [];\r\n        const removedControllers: Array<WebXRInputSource> = [];\r\n        this.controllers.forEach((c) => {\r\n            if (removeInputs.indexOf(c.inputSource) === -1) {\r\n                keepControllers.push(c);\r\n            } else {\r\n                removedControllers.push(c);\r\n            }\r\n        });\r\n        this.controllers = keepControllers;\r\n        removedControllers.forEach((c) => {\r\n            this.onControllerRemovedObservable.notifyObservers(c);\r\n            c.dispose();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Disposes of the object\r\n     */\r\n    public dispose() {\r\n        this.controllers.forEach((c) => {\r\n            c.dispose();\r\n        });\r\n        this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver);\r\n        this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver);\r\n        this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver);\r\n        this.onControllerAddedObservable.clear();\r\n        this.onControllerRemovedObservable.clear();\r\n\r\n        // clear the controller cache\r\n        WebXRMotionControllerManager.ClearControllerCache();\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
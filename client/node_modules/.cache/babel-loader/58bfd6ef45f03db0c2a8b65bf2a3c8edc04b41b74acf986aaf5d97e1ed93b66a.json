{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { __decorate } from \"../../../../tslib.es6.js\";\nimport { NodeMaterialBlock } from \"../../nodeMaterialBlock.js\";\nimport { NodeMaterialBlockConnectionPointTypes } from \"../../Enums/nodeMaterialBlockConnectionPointTypes.js\";\nimport { NodeMaterialBlockTargets } from \"../../Enums/nodeMaterialBlockTargets.js\";\nimport { NodeMaterialConnectionPointDirection } from \"../../nodeMaterialBlockConnectionPoint.js\";\nimport { RegisterClass } from \"../../../../Misc/typeStore.js\";\nimport { InputBlock } from \"../Input/inputBlock.js\";\nimport { editableInPropertyPage, PropertyTypeForEdition } from \"../../nodeMaterialDecorator.js\";\nimport { NodeMaterialConnectionPointCustomObject } from \"../../nodeMaterialConnectionPointCustomObject.js\";\nimport { TBNBlock } from \"./TBNBlock.js\";\nimport \"../../../../Shaders/ShadersInclude/bumpFragmentMainFunctions.js\";\nimport \"../../../../Shaders/ShadersInclude/bumpFragmentFunctions.js\";\nimport \"../../../../Shaders/ShadersInclude/bumpFragment.js\";\n/**\n * Block used to perturb normals based on a normal map\n */\nexport class PerturbNormalBlock extends NodeMaterialBlock {\n  /**\n   * Create a new PerturbNormalBlock\n   * @param name defines the block name\n   */\n  constructor(name) {\n    super(name, NodeMaterialBlockTargets.Fragment);\n    this._tangentSpaceParameterName = \"\";\n    this._tangentCorrectionFactorName = \"\";\n    /** Gets or sets a boolean indicating that normal should be inverted on X axis */\n    this.invertX = false;\n    /** Gets or sets a boolean indicating that normal should be inverted on Y axis */\n    this.invertY = false;\n    /** Gets or sets a boolean indicating that parallax occlusion should be enabled */\n    this.useParallaxOcclusion = false;\n    this._isUnique = true;\n    // Vertex\n    this.registerInput(\"worldPosition\", NodeMaterialBlockConnectionPointTypes.Vector4, false);\n    this.registerInput(\"worldNormal\", NodeMaterialBlockConnectionPointTypes.Vector4, false);\n    this.registerInput(\"worldTangent\", NodeMaterialBlockConnectionPointTypes.Vector4, true);\n    this.registerInput(\"uv\", NodeMaterialBlockConnectionPointTypes.Vector2, false);\n    this.registerInput(\"normalMapColor\", NodeMaterialBlockConnectionPointTypes.Color3, false);\n    this.registerInput(\"strength\", NodeMaterialBlockConnectionPointTypes.Float, false);\n    this.registerInput(\"viewDirection\", NodeMaterialBlockConnectionPointTypes.Vector3, true);\n    this.registerInput(\"parallaxScale\", NodeMaterialBlockConnectionPointTypes.Float, true);\n    this.registerInput(\"parallaxHeight\", NodeMaterialBlockConnectionPointTypes.Float, true);\n    this.registerInput(\"TBN\", NodeMaterialBlockConnectionPointTypes.Object, true, NodeMaterialBlockTargets.VertexAndFragment, new NodeMaterialConnectionPointCustomObject(\"TBN\", this, NodeMaterialConnectionPointDirection.Input, TBNBlock, \"TBNBlock\"));\n    // Fragment\n    this.registerOutput(\"output\", NodeMaterialBlockConnectionPointTypes.Vector4);\n    this.registerOutput(\"uvOffset\", NodeMaterialBlockConnectionPointTypes.Vector2);\n  }\n  /**\n   * Gets the current class name\n   * @returns the class name\n   */\n  getClassName() {\n    return \"PerturbNormalBlock\";\n  }\n  /**\n   * Gets the world position input component\n   */\n  get worldPosition() {\n    return this._inputs[0];\n  }\n  /**\n   * Gets the world normal input component\n   */\n  get worldNormal() {\n    return this._inputs[1];\n  }\n  /**\n   * Gets the world tangent input component\n   */\n  get worldTangent() {\n    return this._inputs[2];\n  }\n  /**\n   * Gets the uv input component\n   */\n  get uv() {\n    return this._inputs[3];\n  }\n  /**\n   * Gets the normal map color input component\n   */\n  get normalMapColor() {\n    return this._inputs[4];\n  }\n  /**\n   * Gets the strength input component\n   */\n  get strength() {\n    return this._inputs[5];\n  }\n  /**\n   * Gets the view direction input component\n   */\n  get viewDirection() {\n    return this._inputs[6];\n  }\n  /**\n   * Gets the parallax scale input component\n   */\n  get parallaxScale() {\n    return this._inputs[7];\n  }\n  /**\n   * Gets the parallax height input component\n   */\n  get parallaxHeight() {\n    return this._inputs[8];\n  }\n  /**\n   * Gets the TBN input component\n   */\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  get TBN() {\n    return this._inputs[9];\n  }\n  /**\n   * Gets the output component\n   */\n  get output() {\n    return this._outputs[0];\n  }\n  /**\n   * Gets the uv offset output component\n   */\n  get uvOffset() {\n    return this._outputs[1];\n  }\n  prepareDefines(mesh, nodeMaterial, defines) {\n    const normalSamplerName = this.normalMapColor.connectedPoint._ownerBlock.samplerName;\n    const useParallax = this.viewDirection.isConnected && (this.useParallaxOcclusion && normalSamplerName || !this.useParallaxOcclusion && this.parallaxHeight.isConnected);\n    defines.setValue(\"BUMP\", true);\n    defines.setValue(\"PARALLAX\", useParallax, true);\n    defines.setValue(\"PARALLAXOCCLUSION\", this.useParallaxOcclusion, true);\n  }\n  bind(effect, nodeMaterial, mesh) {\n    if (nodeMaterial.getScene()._mirroredCameraPosition) {\n      effect.setFloat2(this._tangentSpaceParameterName, this.invertX ? 1.0 : -1.0, this.invertY ? 1.0 : -1.0);\n    } else {\n      effect.setFloat2(this._tangentSpaceParameterName, this.invertX ? -1.0 : 1.0, this.invertY ? -1.0 : 1.0);\n    }\n    if (mesh) {\n      effect.setFloat(this._tangentCorrectionFactorName, mesh.getWorldMatrix().determinant() < 0 ? -1 : 1);\n    }\n  }\n  autoConfigure(material) {\n    if (!this.uv.isConnected) {\n      let uvInput = material.getInputBlockByPredicate(b => b.isAttribute && b.name === \"uv\");\n      if (!uvInput) {\n        uvInput = new InputBlock(\"uv\");\n        uvInput.setAsAttribute();\n      }\n      uvInput.output.connectTo(this.uv);\n    }\n    if (!this.strength.isConnected) {\n      const strengthInput = new InputBlock(\"strength\");\n      strengthInput.value = 1.0;\n      strengthInput.output.connectTo(this.strength);\n    }\n  }\n  _buildBlock(state) {\n    super._buildBlock(state);\n    const comments = `//${this.name}`;\n    const uv = this.uv;\n    const worldPosition = this.worldPosition;\n    const worldNormal = this.worldNormal;\n    const worldTangent = this.worldTangent;\n    state.sharedData.blocksWithDefines.push(this);\n    state.sharedData.bindableBlocks.push(this);\n    this._tangentSpaceParameterName = state._getFreeDefineName(\"tangentSpaceParameter\");\n    state._emitUniformFromString(this._tangentSpaceParameterName, \"vec2\");\n    this._tangentCorrectionFactorName = state._getFreeDefineName(\"tangentCorrectionFactor\");\n    state._emitUniformFromString(this._tangentCorrectionFactorName, \"float\");\n    let normalSamplerName = null;\n    if (this.normalMapColor.connectedPoint) {\n      normalSamplerName = this.normalMapColor.connectedPoint._ownerBlock.samplerName;\n    }\n    const useParallax = this.viewDirection.isConnected && (this.useParallaxOcclusion && normalSamplerName || !this.useParallaxOcclusion && this.parallaxHeight.isConnected);\n    const replaceForParallaxInfos = !this.parallaxScale.isConnectedToInputBlock ? \"0.05\" : this.parallaxScale.connectInputBlock.isConstant ? state._emitFloat(this.parallaxScale.connectInputBlock.value) : this.parallaxScale.associatedVariableName;\n    const replaceForBumpInfos = this.strength.isConnectedToInputBlock && this.strength.connectInputBlock.isConstant ? `\\r\\n#if !defined(NORMALXYSCALE)\\r\\n1.0/\\r\\n#endif\\r\\n${state._emitFloat(this.strength.connectInputBlock.value)}` : `\\r\\n#if !defined(NORMALXYSCALE)\\r\\n1.0/\\r\\n#endif\\r\\n${this.strength.associatedVariableName}`;\n    state._emitExtension(\"derivatives\", \"#extension GL_OES_standard_derivatives : enable\");\n    const tangentReplaceString = {\n      search: /defined\\(TANGENT\\)/g,\n      replace: worldTangent.isConnected ? \"defined(TANGENT)\" : \"defined(IGNORE)\"\n    };\n    const tbnVarying = {\n      search: /varying mat3 vTBN/g,\n      replace: \"\"\n    };\n    const TBN = this.TBN;\n    if (TBN.isConnected) {\n      state.compilationString += `\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${TBN.associatedVariableName};\n            #endif\n            `;\n    } else if (worldTangent.isConnected) {\n      state.compilationString += `vec3 tbnNormal = normalize(${worldNormal.associatedVariableName}.xyz);\\r\\n`;\n      state.compilationString += `vec3 tbnTangent = normalize(${worldTangent.associatedVariableName}.xyz);\\r\\n`;\n      state.compilationString += `vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\\r\\n`;\n      state.compilationString += `mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\\r\\n`;\n    }\n    state._emitFunctionFromInclude(\"bumpFragmentMainFunctions\", comments, {\n      replaceStrings: [tangentReplaceString, tbnVarying]\n    });\n    state._emitFunctionFromInclude(\"bumpFragmentFunctions\", comments, {\n      replaceStrings: [{\n        search: /#include<samplerFragmentDeclaration>\\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\\)/g,\n        replace: \"\"\n      }, {\n        search: /uniform sampler2D bumpSampler;/g,\n        replace: \"\"\n      }, {\n        search: /vec2 parallaxOcclusion\\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\\)/g,\n        replace: \"#define inline\\r\\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)\"\n      }, {\n        search: /vec2 parallaxOffset\\(vec3 viewDir,float heightScale\\)/g,\n        replace: \"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)\"\n      }, {\n        search: /texture2D\\(bumpSampler,vBumpUV\\)\\.w/g,\n        replace: \"height_\"\n      }]\n    });\n    const uvForPerturbNormal = !useParallax || !normalSamplerName ? this.normalMapColor.associatedVariableName : `texture2D(${normalSamplerName}, ${uv.associatedVariableName} + uvOffset).xyz`;\n    state.compilationString += this._declareOutput(this.output, state) + \" = vec4(0.);\\r\\n\";\n    state.compilationString += state._emitCodeFromInclude(\"bumpFragment\", comments, {\n      replaceStrings: [{\n        search: /perturbNormal\\(TBN,texture2D\\(bumpSampler,vBumpUV\\+uvOffset\\).xyz,vBumpInfos.y\\)/g,\n        replace: `perturbNormal(TBN, ${uvForPerturbNormal}, vBumpInfos.y)`\n      }, {\n        search: /parallaxOcclusion\\(invTBN\\*-viewDirectionW,invTBN\\*normalW,vBumpUV,vBumpInfos.z\\)/g,\n        replace: `parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${useParallax && this.useParallaxOcclusion ? normalSamplerName : \"bumpSampler\"})`\n      }, {\n        search: /parallaxOffset\\(invTBN\\*viewDirectionW,vBumpInfos\\.z\\)/g,\n        replace: `parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${useParallax ? this.parallaxHeight.associatedVariableName : \"0.\"})`\n      }, {\n        search: /vTangentSpaceParams/g,\n        replace: this._tangentSpaceParameterName\n      }, {\n        search: /vBumpInfos.y/g,\n        replace: replaceForBumpInfos\n      }, {\n        search: /vBumpInfos.z/g,\n        replace: replaceForParallaxInfos\n      }, {\n        search: /vBumpUV/g,\n        replace: uv.associatedVariableName\n      }, {\n        search: /vPositionW/g,\n        replace: worldPosition.associatedVariableName + \".xyz\"\n      }, {\n        search: /normalW=/g,\n        replace: this.output.associatedVariableName + \".xyz = \"\n      }, {\n        search: /mat3\\(normalMatrix\\)\\*normalW/g,\n        replace: \"mat3(normalMatrix) * \" + this.output.associatedVariableName + \".xyz\"\n      }, {\n        search: /normalW/g,\n        replace: worldNormal.associatedVariableName + \".xyz\"\n      }, {\n        search: /viewDirectionW/g,\n        replace: useParallax ? this.viewDirection.associatedVariableName : \"vec3(0.)\"\n      }, tangentReplaceString]\n    });\n    return this;\n  }\n  _dumpPropertiesCode() {\n    let codeString = super._dumpPropertiesCode() + `${this._codeVariableName}.invertX = ${this.invertX};\\r\\n`;\n    codeString += `${this._codeVariableName}.invertY = ${this.invertY};\\r\\n`;\n    codeString += `${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\\r\\n`;\n    return codeString;\n  }\n  serialize() {\n    const serializationObject = super.serialize();\n    serializationObject.invertX = this.invertX;\n    serializationObject.invertY = this.invertY;\n    serializationObject.useParallaxOcclusion = this.useParallaxOcclusion;\n    return serializationObject;\n  }\n  _deserialize(serializationObject, scene, rootUrl) {\n    super._deserialize(serializationObject, scene, rootUrl);\n    this.invertX = serializationObject.invertX;\n    this.invertY = serializationObject.invertY;\n    this.useParallaxOcclusion = !!serializationObject.useParallaxOcclusion;\n  }\n}\n__decorate([editableInPropertyPage(\"Invert X axis\", PropertyTypeForEdition.Boolean, \"PROPERTIES\", {\n  notifiers: {\n    update: false\n  }\n})], PerturbNormalBlock.prototype, \"invertX\", void 0);\n__decorate([editableInPropertyPage(\"Invert Y axis\", PropertyTypeForEdition.Boolean, \"PROPERTIES\", {\n  notifiers: {\n    update: false\n  }\n})], PerturbNormalBlock.prototype, \"invertY\", void 0);\n__decorate([editableInPropertyPage(\"Use parallax occlusion\", PropertyTypeForEdition.Boolean)], PerturbNormalBlock.prototype, \"useParallaxOcclusion\", void 0);\nRegisterClass(\"BABYLON.PerturbNormalBlock\", PerturbNormalBlock);","map":{"version":3,"mappings":"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","names":["NodeMaterialBlock","NodeMaterialBlockConnectionPointTypes","NodeMaterialBlockTargets","NodeMaterialConnectionPointDirection","RegisterClass","InputBlock","editableInPropertyPage","PropertyTypeForEdition","NodeMaterialConnectionPointCustomObject","TBNBlock","PerturbNormalBlock","constructor","name","Fragment","_isUnique","registerInput","Vector4","Vector2","Color3","Float","Vector3","Object","VertexAndFragment","Input","registerOutput","getClassName","worldPosition","_inputs","worldNormal","worldTangent","uv","normalMapColor","strength","viewDirection","parallaxScale","parallaxHeight","TBN","output","_outputs","uvOffset","prepareDefines","mesh","nodeMaterial","defines","normalSamplerName","connectedPoint","_ownerBlock","samplerName","useParallax","isConnected","useParallaxOcclusion","setValue","bind","effect","getScene","_mirroredCameraPosition","setFloat2","_tangentSpaceParameterName","invertX","invertY","setFloat","_tangentCorrectionFactorName","getWorldMatrix","determinant","autoConfigure","material","uvInput","getInputBlockByPredicate","b","isAttribute","setAsAttribute","connectTo","strengthInput","value","_buildBlock","state","comments","sharedData","blocksWithDefines","push","bindableBlocks","_getFreeDefineName","_emitUniformFromString","replaceForParallaxInfos","isConnectedToInputBlock","connectInputBlock","isConstant","_emitFloat","associatedVariableName","replaceForBumpInfos","_emitExtension","tangentReplaceString","search","replace","tbnVarying","compilationString","_emitFunctionFromInclude","replaceStrings","uvForPerturbNormal","_declareOutput","_emitCodeFromInclude","_dumpPropertiesCode","codeString","_codeVariableName","serialize","serializationObject","_deserialize","scene","rootUrl","__decorate","Boolean","notifiers","update"],"sourceRoot":"","sources":["../../../../../../../lts/core/generated/Materials/Node/Blocks/Fragment/perturbNormalBlock.ts"],"sourcesContent":["import { NodeMaterialBlock } from \"../../nodeMaterialBlock\";\r\nimport { NodeMaterialBlockConnectionPointTypes } from \"../../Enums/nodeMaterialBlockConnectionPointTypes\";\r\nimport type { NodeMaterialBuildState } from \"../../nodeMaterialBuildState\";\r\nimport { NodeMaterialBlockTargets } from \"../../Enums/nodeMaterialBlockTargets\";\r\nimport type { NodeMaterialConnectionPoint } from \"../../nodeMaterialBlockConnectionPoint\";\r\nimport { NodeMaterialConnectionPointDirection } from \"../../nodeMaterialBlockConnectionPoint\";\r\nimport { RegisterClass } from \"../../../../Misc/typeStore\";\r\nimport type { NodeMaterial, NodeMaterialDefines } from \"../../nodeMaterial\";\r\nimport type { AbstractMesh } from \"../../../../Meshes/abstractMesh\";\r\nimport type { Mesh } from \"../../../../Meshes/mesh\";\r\nimport { InputBlock } from \"../Input/inputBlock\";\r\nimport type { Effect } from \"../../../effect\";\r\nimport type { Scene } from \"../../../../scene\";\r\nimport { editableInPropertyPage, PropertyTypeForEdition } from \"../../nodeMaterialDecorator\";\r\nimport type { TextureBlock } from \"../Dual/textureBlock\";\r\nimport { NodeMaterialConnectionPointCustomObject } from \"../../nodeMaterialConnectionPointCustomObject\";\r\nimport { TBNBlock } from \"./TBNBlock\";\r\n\r\nimport \"../../../../Shaders/ShadersInclude/bumpFragmentMainFunctions\";\r\nimport \"../../../../Shaders/ShadersInclude/bumpFragmentFunctions\";\r\nimport \"../../../../Shaders/ShadersInclude/bumpFragment\";\r\n\r\n/**\r\n * Block used to perturb normals based on a normal map\r\n */\r\nexport class PerturbNormalBlock extends NodeMaterialBlock {\r\n    private _tangentSpaceParameterName = \"\";\r\n    private _tangentCorrectionFactorName = \"\";\r\n\r\n    /** Gets or sets a boolean indicating that normal should be inverted on X axis */\r\n    @editableInPropertyPage(\"Invert X axis\", PropertyTypeForEdition.Boolean, \"PROPERTIES\", { notifiers: { update: false } })\r\n    public invertX = false;\r\n    /** Gets or sets a boolean indicating that normal should be inverted on Y axis */\r\n    @editableInPropertyPage(\"Invert Y axis\", PropertyTypeForEdition.Boolean, \"PROPERTIES\", { notifiers: { update: false } })\r\n    public invertY = false;\r\n    /** Gets or sets a boolean indicating that parallax occlusion should be enabled */\r\n    @editableInPropertyPage(\"Use parallax occlusion\", PropertyTypeForEdition.Boolean)\r\n    public useParallaxOcclusion = false;\r\n\r\n    /**\r\n     * Create a new PerturbNormalBlock\r\n     * @param name defines the block name\r\n     */\r\n    public constructor(name: string) {\r\n        super(name, NodeMaterialBlockTargets.Fragment);\r\n\r\n        this._isUnique = true;\r\n\r\n        // Vertex\r\n        this.registerInput(\"worldPosition\", NodeMaterialBlockConnectionPointTypes.Vector4, false);\r\n        this.registerInput(\"worldNormal\", NodeMaterialBlockConnectionPointTypes.Vector4, false);\r\n        this.registerInput(\"worldTangent\", NodeMaterialBlockConnectionPointTypes.Vector4, true);\r\n        this.registerInput(\"uv\", NodeMaterialBlockConnectionPointTypes.Vector2, false);\r\n        this.registerInput(\"normalMapColor\", NodeMaterialBlockConnectionPointTypes.Color3, false);\r\n        this.registerInput(\"strength\", NodeMaterialBlockConnectionPointTypes.Float, false);\r\n        this.registerInput(\"viewDirection\", NodeMaterialBlockConnectionPointTypes.Vector3, true);\r\n        this.registerInput(\"parallaxScale\", NodeMaterialBlockConnectionPointTypes.Float, true);\r\n        this.registerInput(\"parallaxHeight\", NodeMaterialBlockConnectionPointTypes.Float, true);\r\n        this.registerInput(\r\n            \"TBN\",\r\n            NodeMaterialBlockConnectionPointTypes.Object,\r\n            true,\r\n            NodeMaterialBlockTargets.VertexAndFragment,\r\n            new NodeMaterialConnectionPointCustomObject(\"TBN\", this, NodeMaterialConnectionPointDirection.Input, TBNBlock, \"TBNBlock\")\r\n        );\r\n\r\n        // Fragment\r\n        this.registerOutput(\"output\", NodeMaterialBlockConnectionPointTypes.Vector4);\r\n        this.registerOutput(\"uvOffset\", NodeMaterialBlockConnectionPointTypes.Vector2);\r\n    }\r\n\r\n    /**\r\n     * Gets the current class name\r\n     * @returns the class name\r\n     */\r\n    public getClassName() {\r\n        return \"PerturbNormalBlock\";\r\n    }\r\n\r\n    /**\r\n     * Gets the world position input component\r\n     */\r\n    public get worldPosition(): NodeMaterialConnectionPoint {\r\n        return this._inputs[0];\r\n    }\r\n\r\n    /**\r\n     * Gets the world normal input component\r\n     */\r\n    public get worldNormal(): NodeMaterialConnectionPoint {\r\n        return this._inputs[1];\r\n    }\r\n\r\n    /**\r\n     * Gets the world tangent input component\r\n     */\r\n    public get worldTangent(): NodeMaterialConnectionPoint {\r\n        return this._inputs[2];\r\n    }\r\n\r\n    /**\r\n     * Gets the uv input component\r\n     */\r\n    public get uv(): NodeMaterialConnectionPoint {\r\n        return this._inputs[3];\r\n    }\r\n\r\n    /**\r\n     * Gets the normal map color input component\r\n     */\r\n    public get normalMapColor(): NodeMaterialConnectionPoint {\r\n        return this._inputs[4];\r\n    }\r\n\r\n    /**\r\n     * Gets the strength input component\r\n     */\r\n    public get strength(): NodeMaterialConnectionPoint {\r\n        return this._inputs[5];\r\n    }\r\n\r\n    /**\r\n     * Gets the view direction input component\r\n     */\r\n    public get viewDirection(): NodeMaterialConnectionPoint {\r\n        return this._inputs[6];\r\n    }\r\n\r\n    /**\r\n     * Gets the parallax scale input component\r\n     */\r\n    public get parallaxScale(): NodeMaterialConnectionPoint {\r\n        return this._inputs[7];\r\n    }\r\n\r\n    /**\r\n     * Gets the parallax height input component\r\n     */\r\n    public get parallaxHeight(): NodeMaterialConnectionPoint {\r\n        return this._inputs[8];\r\n    }\r\n\r\n    /**\r\n     * Gets the TBN input component\r\n     */\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    public get TBN(): NodeMaterialConnectionPoint {\r\n        return this._inputs[9];\r\n    }\r\n\r\n    /**\r\n     * Gets the output component\r\n     */\r\n    public get output(): NodeMaterialConnectionPoint {\r\n        return this._outputs[0];\r\n    }\r\n\r\n    /**\r\n     * Gets the uv offset output component\r\n     */\r\n    public get uvOffset(): NodeMaterialConnectionPoint {\r\n        return this._outputs[1];\r\n    }\r\n\r\n    public prepareDefines(mesh: AbstractMesh, nodeMaterial: NodeMaterial, defines: NodeMaterialDefines) {\r\n        const normalSamplerName = (this.normalMapColor.connectedPoint!._ownerBlock as TextureBlock).samplerName;\r\n        const useParallax = this.viewDirection.isConnected && ((this.useParallaxOcclusion && normalSamplerName) || (!this.useParallaxOcclusion && this.parallaxHeight.isConnected));\r\n\r\n        defines.setValue(\"BUMP\", true);\r\n        defines.setValue(\"PARALLAX\", useParallax, true);\r\n        defines.setValue(\"PARALLAXOCCLUSION\", this.useParallaxOcclusion, true);\r\n    }\r\n\r\n    public bind(effect: Effect, nodeMaterial: NodeMaterial, mesh?: Mesh) {\r\n        if (nodeMaterial.getScene()._mirroredCameraPosition) {\r\n            effect.setFloat2(this._tangentSpaceParameterName, this.invertX ? 1.0 : -1.0, this.invertY ? 1.0 : -1.0);\r\n        } else {\r\n            effect.setFloat2(this._tangentSpaceParameterName, this.invertX ? -1.0 : 1.0, this.invertY ? -1.0 : 1.0);\r\n        }\r\n        if (mesh) {\r\n            effect.setFloat(this._tangentCorrectionFactorName, mesh.getWorldMatrix().determinant() < 0 ? -1 : 1);\r\n        }\r\n    }\r\n\r\n    public autoConfigure(material: NodeMaterial) {\r\n        if (!this.uv.isConnected) {\r\n            let uvInput = material.getInputBlockByPredicate((b) => b.isAttribute && b.name === \"uv\");\r\n\r\n            if (!uvInput) {\r\n                uvInput = new InputBlock(\"uv\");\r\n                uvInput.setAsAttribute();\r\n            }\r\n            uvInput.output.connectTo(this.uv);\r\n        }\r\n\r\n        if (!this.strength.isConnected) {\r\n            const strengthInput = new InputBlock(\"strength\");\r\n            strengthInput.value = 1.0;\r\n            strengthInput.output.connectTo(this.strength);\r\n        }\r\n    }\r\n\r\n    protected _buildBlock(state: NodeMaterialBuildState) {\r\n        super._buildBlock(state);\r\n\r\n        const comments = `//${this.name}`;\r\n        const uv = this.uv;\r\n        const worldPosition = this.worldPosition;\r\n        const worldNormal = this.worldNormal;\r\n        const worldTangent = this.worldTangent;\r\n\r\n        state.sharedData.blocksWithDefines.push(this);\r\n        state.sharedData.bindableBlocks.push(this);\r\n\r\n        this._tangentSpaceParameterName = state._getFreeDefineName(\"tangentSpaceParameter\");\r\n\r\n        state._emitUniformFromString(this._tangentSpaceParameterName, \"vec2\");\r\n\r\n        this._tangentCorrectionFactorName = state._getFreeDefineName(\"tangentCorrectionFactor\");\r\n\r\n        state._emitUniformFromString(this._tangentCorrectionFactorName, \"float\");\r\n\r\n        let normalSamplerName = null;\r\n        if (this.normalMapColor.connectedPoint) {\r\n            normalSamplerName = (this.normalMapColor.connectedPoint!._ownerBlock as TextureBlock).samplerName;\r\n        }\r\n        const useParallax = this.viewDirection.isConnected && ((this.useParallaxOcclusion && normalSamplerName) || (!this.useParallaxOcclusion && this.parallaxHeight.isConnected));\r\n\r\n        const replaceForParallaxInfos = !this.parallaxScale.isConnectedToInputBlock\r\n            ? \"0.05\"\r\n            : this.parallaxScale.connectInputBlock!.isConstant\r\n            ? state._emitFloat(this.parallaxScale.connectInputBlock!.value)\r\n            : this.parallaxScale.associatedVariableName;\r\n\r\n        const replaceForBumpInfos =\r\n            this.strength.isConnectedToInputBlock && this.strength.connectInputBlock!.isConstant\r\n                ? `\\r\\n#if !defined(NORMALXYSCALE)\\r\\n1.0/\\r\\n#endif\\r\\n${state._emitFloat(this.strength.connectInputBlock!.value)}`\r\n                : `\\r\\n#if !defined(NORMALXYSCALE)\\r\\n1.0/\\r\\n#endif\\r\\n${this.strength.associatedVariableName}`;\r\n\r\n        state._emitExtension(\"derivatives\", \"#extension GL_OES_standard_derivatives : enable\");\r\n\r\n        const tangentReplaceString = { search: /defined\\(TANGENT\\)/g, replace: worldTangent.isConnected ? \"defined(TANGENT)\" : \"defined(IGNORE)\" };\r\n        const tbnVarying = { search: /varying mat3 vTBN/g, replace: \"\" };\r\n\r\n        const TBN = this.TBN;\r\n        if (TBN.isConnected) {\r\n            state.compilationString += `\r\n            #ifdef TBNBLOCK\r\n            mat3 vTBN = ${TBN.associatedVariableName};\r\n            #endif\r\n            `;\r\n        } else if (worldTangent.isConnected) {\r\n            state.compilationString += `vec3 tbnNormal = normalize(${worldNormal.associatedVariableName}.xyz);\\r\\n`;\r\n            state.compilationString += `vec3 tbnTangent = normalize(${worldTangent.associatedVariableName}.xyz);\\r\\n`;\r\n            state.compilationString += `vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\\r\\n`;\r\n            state.compilationString += `mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\\r\\n`;\r\n        }\r\n\r\n        state._emitFunctionFromInclude(\"bumpFragmentMainFunctions\", comments, {\r\n            replaceStrings: [tangentReplaceString, tbnVarying],\r\n        });\r\n\r\n        state._emitFunctionFromInclude(\"bumpFragmentFunctions\", comments, {\r\n            replaceStrings: [\r\n                { search: /#include<samplerFragmentDeclaration>\\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\\)/g, replace: \"\" },\r\n                { search: /uniform sampler2D bumpSampler;/g, replace: \"\" },\r\n                {\r\n                    search: /vec2 parallaxOcclusion\\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\\)/g,\r\n                    replace: \"#define inline\\r\\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)\",\r\n                },\r\n                { search: /vec2 parallaxOffset\\(vec3 viewDir,float heightScale\\)/g, replace: \"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)\" },\r\n                { search: /texture2D\\(bumpSampler,vBumpUV\\)\\.w/g, replace: \"height_\" },\r\n            ],\r\n        });\r\n\r\n        const uvForPerturbNormal =\r\n            !useParallax || !normalSamplerName ? this.normalMapColor.associatedVariableName : `texture2D(${normalSamplerName}, ${uv.associatedVariableName} + uvOffset).xyz`;\r\n\r\n        state.compilationString += this._declareOutput(this.output, state) + \" = vec4(0.);\\r\\n\";\r\n        state.compilationString += state._emitCodeFromInclude(\"bumpFragment\", comments, {\r\n            replaceStrings: [\r\n                { search: /perturbNormal\\(TBN,texture2D\\(bumpSampler,vBumpUV\\+uvOffset\\).xyz,vBumpInfos.y\\)/g, replace: `perturbNormal(TBN, ${uvForPerturbNormal}, vBumpInfos.y)` },\r\n                {\r\n                    search: /parallaxOcclusion\\(invTBN\\*-viewDirectionW,invTBN\\*normalW,vBumpUV,vBumpInfos.z\\)/g,\r\n                    replace: `parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${\r\n                        useParallax && this.useParallaxOcclusion ? normalSamplerName : \"bumpSampler\"\r\n                    })`,\r\n                },\r\n                {\r\n                    search: /parallaxOffset\\(invTBN\\*viewDirectionW,vBumpInfos\\.z\\)/g,\r\n                    replace: `parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${useParallax ? this.parallaxHeight.associatedVariableName : \"0.\"})`,\r\n                },\r\n                { search: /vTangentSpaceParams/g, replace: this._tangentSpaceParameterName },\r\n                { search: /vBumpInfos.y/g, replace: replaceForBumpInfos },\r\n                { search: /vBumpInfos.z/g, replace: replaceForParallaxInfos },\r\n                { search: /vBumpUV/g, replace: uv.associatedVariableName },\r\n                { search: /vPositionW/g, replace: worldPosition.associatedVariableName + \".xyz\" },\r\n                { search: /normalW=/g, replace: this.output.associatedVariableName + \".xyz = \" },\r\n                { search: /mat3\\(normalMatrix\\)\\*normalW/g, replace: \"mat3(normalMatrix) * \" + this.output.associatedVariableName + \".xyz\" },\r\n                { search: /normalW/g, replace: worldNormal.associatedVariableName + \".xyz\" },\r\n                { search: /viewDirectionW/g, replace: useParallax ? this.viewDirection.associatedVariableName : \"vec3(0.)\" },\r\n                tangentReplaceString,\r\n            ],\r\n        });\r\n\r\n        return this;\r\n    }\r\n\r\n    protected _dumpPropertiesCode() {\r\n        let codeString = super._dumpPropertiesCode() + `${this._codeVariableName}.invertX = ${this.invertX};\\r\\n`;\r\n\r\n        codeString += `${this._codeVariableName}.invertY = ${this.invertY};\\r\\n`;\r\n        codeString += `${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\\r\\n`;\r\n\r\n        return codeString;\r\n    }\r\n\r\n    public serialize(): any {\r\n        const serializationObject = super.serialize();\r\n\r\n        serializationObject.invertX = this.invertX;\r\n        serializationObject.invertY = this.invertY;\r\n        serializationObject.useParallaxOcclusion = this.useParallaxOcclusion;\r\n\r\n        return serializationObject;\r\n    }\r\n\r\n    public _deserialize(serializationObject: any, scene: Scene, rootUrl: string) {\r\n        super._deserialize(serializationObject, scene, rootUrl);\r\n\r\n        this.invertX = serializationObject.invertX;\r\n        this.invertY = serializationObject.invertY;\r\n        this.useParallaxOcclusion = !!serializationObject.useParallaxOcclusion;\r\n    }\r\n}\r\n\r\nRegisterClass(\"BABYLON.PerturbNormalBlock\", PerturbNormalBlock);\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import * as WebGPUConstants from \"./webgpuConstants.js\";\nimport { PerfCounter } from \"../../Misc/perfCounter.js\";\nimport { WebGPUQuerySet } from \"./webgpuQuerySet.js\";\n/** @internal */\nexport class WebGPUTimestampQuery {\n  constructor(device, bufferManager) {\n    this._enabled = false;\n    this._gpuFrameTimeCounter = new PerfCounter();\n    this._measureDurationState = 0;\n    this._device = device;\n    this._bufferManager = bufferManager;\n  }\n  get gpuFrameTimeCounter() {\n    return this._gpuFrameTimeCounter;\n  }\n  get enable() {\n    return this._enabled;\n  }\n  set enable(value) {\n    if (this._enabled === value) {\n      return;\n    }\n    this._enabled = value;\n    this._measureDurationState = 0;\n    if (value) {\n      this._measureDuration = new WebGPUDurationMeasure(this._device, this._bufferManager);\n    } else {\n      this._measureDuration.dispose();\n    }\n  }\n  startFrame(commandEncoder) {\n    if (this._enabled && this._measureDurationState === 0) {\n      this._measureDuration.start(commandEncoder);\n      this._measureDurationState = 1;\n    }\n  }\n  endFrame(commandEncoder) {\n    if (this._measureDurationState === 1) {\n      this._measureDurationState = 2;\n      this._measureDuration.stop(commandEncoder).then(duration => {\n        if (duration !== null && duration >= 0) {\n          this._gpuFrameTimeCounter.fetchNewFrame();\n          this._gpuFrameTimeCounter.addCount(duration, true);\n        }\n        this._measureDurationState = 0;\n      });\n    }\n  }\n}\n/** @internal */\nexport class WebGPUDurationMeasure {\n  constructor(device, bufferManager) {\n    this._querySet = new WebGPUQuerySet(2, WebGPUConstants.QueryType.Timestamp, device, bufferManager);\n  }\n  start(encoder) {\n    encoder.writeTimestamp(this._querySet.querySet, 0);\n  }\n  async stop(encoder) {\n    encoder.writeTimestamp(this._querySet.querySet, 1);\n    return this._querySet.readTwoValuesAndSubtract(0);\n  }\n  dispose() {\n    this._querySet.dispose();\n  }\n}","map":{"version":3,"mappings":"AACA,OAAO,KAAKA,eAAe,MAAM,sBAAoB;AACrD,SAASC,WAAW,QAAQ,2BAAyB;AACrD,SAASC,cAAc,QAAQ,qBAAmB;AAElD;AACA,OAAM,MAAOC,oBAAoB;EAa7BC,YAAYC,MAAiB,EAAEC,aAAkC;IATzD,aAAQ,GAAG,KAAK;IAChB,yBAAoB,GAAgB,IAAIL,WAAW,EAAE;IAErD,0BAAqB,GAAG,CAAC;IAO7B,IAAI,CAACM,OAAO,GAAGF,MAAM;IACrB,IAAI,CAACG,cAAc,GAAGF,aAAa;EACvC;EAPA,IAAWG,mBAAmB;IAC1B,OAAO,IAAI,CAACC,oBAAoB;EACpC;EAOA,IAAWC,MAAM;IACb,OAAO,IAAI,CAACC,QAAQ;EACxB;EAEA,IAAWD,MAAM,CAACE,KAAc;IAC5B,IAAI,IAAI,CAACD,QAAQ,KAAKC,KAAK,EAAE;MACzB;;IAGJ,IAAI,CAACD,QAAQ,GAAGC,KAAK;IACrB,IAAI,CAACC,qBAAqB,GAAG,CAAC;IAC9B,IAAID,KAAK,EAAE;MACP,IAAI,CAACE,gBAAgB,GAAG,IAAIC,qBAAqB,CAAC,IAAI,CAACT,OAAO,EAAE,IAAI,CAACC,cAAc,CAAC;KACvF,MAAM;MACH,IAAI,CAACO,gBAAgB,CAACE,OAAO,EAAE;;EAEvC;EAEOC,UAAU,CAACC,cAAiC;IAC/C,IAAI,IAAI,CAACP,QAAQ,IAAI,IAAI,CAACE,qBAAqB,KAAK,CAAC,EAAE;MACnD,IAAI,CAACC,gBAAgB,CAACK,KAAK,CAACD,cAAc,CAAC;MAC3C,IAAI,CAACL,qBAAqB,GAAG,CAAC;;EAEtC;EAEOO,QAAQ,CAACF,cAAiC;IAC7C,IAAI,IAAI,CAACL,qBAAqB,KAAK,CAAC,EAAE;MAClC,IAAI,CAACA,qBAAqB,GAAG,CAAC;MAC9B,IAAI,CAACC,gBAAgB,CAACO,IAAI,CAACH,cAAc,CAAC,CAACI,IAAI,CAAEC,QAAQ,IAAI;QACzD,IAAIA,QAAQ,KAAK,IAAI,IAAIA,QAAQ,IAAI,CAAC,EAAE;UACpC,IAAI,CAACd,oBAAoB,CAACe,aAAa,EAAE;UACzC,IAAI,CAACf,oBAAoB,CAACgB,QAAQ,CAACF,QAAQ,EAAE,IAAI,CAAC;;QAEtD,IAAI,CAACV,qBAAqB,GAAG,CAAC;MAClC,CAAC,CAAC;;EAEV;;AAGJ;AACA,OAAM,MAAOE,qBAAqB;EAG9BZ,YAAYC,MAAiB,EAAEC,aAAkC;IAC7D,IAAI,CAACqB,SAAS,GAAG,IAAIzB,cAAc,CAAC,CAAC,EAAEF,eAAe,CAAC4B,SAAS,CAACC,SAAS,EAAExB,MAAM,EAAEC,aAAa,CAAC;EACtG;EAEOc,KAAK,CAACU,OAA0B;IACnCA,OAAO,CAACC,cAAc,CAAC,IAAI,CAACJ,SAAS,CAACK,QAAQ,EAAE,CAAC,CAAC;EACtD;EAEO,MAAMV,IAAI,CAACQ,OAA0B;IACxCA,OAAO,CAACC,cAAc,CAAC,IAAI,CAACJ,SAAS,CAACK,QAAQ,EAAE,CAAC,CAAC;IAElD,OAAO,IAAI,CAACL,SAAS,CAACM,wBAAwB,CAAC,CAAC,CAAC;EACrD;EAEOhB,OAAO;IACV,IAAI,CAACU,SAAS,CAACV,OAAO,EAAE;EAC5B","names":["WebGPUConstants","PerfCounter","WebGPUQuerySet","WebGPUTimestampQuery","constructor","device","bufferManager","_device","_bufferManager","gpuFrameTimeCounter","_gpuFrameTimeCounter","enable","_enabled","value","_measureDurationState","_measureDuration","WebGPUDurationMeasure","dispose","startFrame","commandEncoder","start","endFrame","stop","then","duration","fetchNewFrame","addCount","_querySet","QueryType","Timestamp","encoder","writeTimestamp","querySet","readTwoValuesAndSubtract"],"sourceRoot":"","sources":["../../../../../lts/core/generated/Engines/WebGPU/webgpuTimestampQuery.ts"],"sourcesContent":["import type { WebGPUBufferManager } from \"./webgpuBufferManager\";\r\nimport * as WebGPUConstants from \"./webgpuConstants\";\r\nimport { PerfCounter } from \"../../Misc/perfCounter\";\r\nimport { WebGPUQuerySet } from \"./webgpuQuerySet\";\r\n\r\n/** @internal */\r\nexport class WebGPUTimestampQuery {\r\n    private _device: GPUDevice;\r\n    private _bufferManager: WebGPUBufferManager;\r\n\r\n    private _enabled = false;\r\n    private _gpuFrameTimeCounter: PerfCounter = new PerfCounter();\r\n    private _measureDuration: WebGPUDurationMeasure;\r\n    private _measureDurationState = 0;\r\n\r\n    public get gpuFrameTimeCounter() {\r\n        return this._gpuFrameTimeCounter;\r\n    }\r\n\r\n    constructor(device: GPUDevice, bufferManager: WebGPUBufferManager) {\r\n        this._device = device;\r\n        this._bufferManager = bufferManager;\r\n    }\r\n\r\n    public get enable(): boolean {\r\n        return this._enabled;\r\n    }\r\n\r\n    public set enable(value: boolean) {\r\n        if (this._enabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._enabled = value;\r\n        this._measureDurationState = 0;\r\n        if (value) {\r\n            this._measureDuration = new WebGPUDurationMeasure(this._device, this._bufferManager);\r\n        } else {\r\n            this._measureDuration.dispose();\r\n        }\r\n    }\r\n\r\n    public startFrame(commandEncoder: GPUCommandEncoder): void {\r\n        if (this._enabled && this._measureDurationState === 0) {\r\n            this._measureDuration.start(commandEncoder);\r\n            this._measureDurationState = 1;\r\n        }\r\n    }\r\n\r\n    public endFrame(commandEncoder: GPUCommandEncoder): void {\r\n        if (this._measureDurationState === 1) {\r\n            this._measureDurationState = 2;\r\n            this._measureDuration.stop(commandEncoder).then((duration) => {\r\n                if (duration !== null && duration >= 0) {\r\n                    this._gpuFrameTimeCounter.fetchNewFrame();\r\n                    this._gpuFrameTimeCounter.addCount(duration, true);\r\n                }\r\n                this._measureDurationState = 0;\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\n/** @internal */\r\nexport class WebGPUDurationMeasure {\r\n    private _querySet: WebGPUQuerySet;\r\n\r\n    constructor(device: GPUDevice, bufferManager: WebGPUBufferManager) {\r\n        this._querySet = new WebGPUQuerySet(2, WebGPUConstants.QueryType.Timestamp, device, bufferManager);\r\n    }\r\n\r\n    public start(encoder: GPUCommandEncoder): void {\r\n        encoder.writeTimestamp(this._querySet.querySet, 0);\r\n    }\r\n\r\n    public async stop(encoder: GPUCommandEncoder): Promise<number | null> {\r\n        encoder.writeTimestamp(this._querySet.querySet, 1);\r\n\r\n        return this._querySet.readTwoValuesAndSubtract(0);\r\n    }\r\n\r\n    public dispose() {\r\n        this._querySet.dispose();\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
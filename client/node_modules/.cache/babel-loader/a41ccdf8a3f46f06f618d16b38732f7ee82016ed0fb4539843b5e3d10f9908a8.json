{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { StorageBuffer } from \"../Buffers/storageBuffer.js\";\nimport { ComputeShader } from \"../Compute/computeShader.js\";\nimport { UniformBuffer } from \"../Materials/uniformBuffer.js\";\nimport { UniformBufferEffectCommonAccessor } from \"../Materials/uniformBufferEffectCommonAccessor.js\";\nimport { RegisterClass } from \"../Misc/typeStore.js\";\nimport \"../ShadersWGSL/gpuUpdateParticles.compute.js\";\n/** @internal */\nexport class ComputeShaderParticleSystem {\n  constructor(parent, engine) {\n    this._bufferComputeShader = [];\n    this._renderVertexBuffers = [];\n    this.alignDataInBuffer = true;\n    this._parent = parent;\n    this._engine = engine;\n  }\n  isUpdateBufferCreated() {\n    return !!this._updateComputeShader;\n  }\n  isUpdateBufferReady() {\n    var _a, _b;\n    return (_b = (_a = this._updateComputeShader) === null || _a === void 0 ? void 0 : _a.isReady()) !== null && _b !== void 0 ? _b : false;\n  }\n  createUpdateBuffer(defines) {\n    var _a;\n    const bindingsMapping = {\n      params: {\n        group: 0,\n        binding: 0\n      },\n      particlesIn: {\n        group: 0,\n        binding: 1\n      },\n      particlesOut: {\n        group: 0,\n        binding: 2\n      },\n      randomTexture: {\n        group: 0,\n        binding: 3\n      },\n      randomTexture2: {\n        group: 0,\n        binding: 4\n      }\n    };\n    if (this._parent._sizeGradientsTexture) {\n      bindingsMapping[\"sizeGradientTexture\"] = {\n        group: 1,\n        binding: 1\n      };\n    }\n    if (this._parent._angularSpeedGradientsTexture) {\n      bindingsMapping[\"angularSpeedGradientTexture\"] = {\n        group: 1,\n        binding: 3\n      };\n    }\n    if (this._parent._velocityGradientsTexture) {\n      bindingsMapping[\"velocityGradientTexture\"] = {\n        group: 1,\n        binding: 5\n      };\n    }\n    if (this._parent._limitVelocityGradientsTexture) {\n      bindingsMapping[\"limitVelocityGradientTexture\"] = {\n        group: 1,\n        binding: 7\n      };\n    }\n    if (this._parent._dragGradientsTexture) {\n      bindingsMapping[\"dragGradientTexture\"] = {\n        group: 1,\n        binding: 9\n      };\n    }\n    if (this._parent.noiseTexture) {\n      bindingsMapping[\"noiseTexture\"] = {\n        group: 1,\n        binding: 11\n      };\n    }\n    this._updateComputeShader = new ComputeShader(\"updateParticles\", this._engine, \"gpuUpdateParticles\", {\n      bindingsMapping,\n      defines: defines.split(\"\\n\")\n    });\n    (_a = this._simParamsComputeShader) === null || _a === void 0 ? void 0 : _a.dispose();\n    this._simParamsComputeShader = new UniformBuffer(this._engine);\n    this._simParamsComputeShader.addUniform(\"currentCount\", 1);\n    this._simParamsComputeShader.addUniform(\"timeDelta\", 1);\n    this._simParamsComputeShader.addUniform(\"stopFactor\", 1);\n    this._simParamsComputeShader.addUniform(\"randomTextureSize\", 1);\n    this._simParamsComputeShader.addUniform(\"lifeTime\", 2);\n    this._simParamsComputeShader.addUniform(\"emitPower\", 2);\n    if (!this._parent._colorGradientsTexture) {\n      this._simParamsComputeShader.addUniform(\"color1\", 4);\n      this._simParamsComputeShader.addUniform(\"color2\", 4);\n    }\n    this._simParamsComputeShader.addUniform(\"sizeRange\", 2);\n    this._simParamsComputeShader.addUniform(\"scaleRange\", 4);\n    this._simParamsComputeShader.addUniform(\"angleRange\", 4);\n    this._simParamsComputeShader.addUniform(\"gravity\", 3);\n    if (this._parent._limitVelocityGradientsTexture) {\n      this._simParamsComputeShader.addUniform(\"limitVelocityDamping\", 1);\n    }\n    if (this._parent.isAnimationSheetEnabled) {\n      this._simParamsComputeShader.addUniform(\"cellInfos\", 4);\n    }\n    if (this._parent.noiseTexture) {\n      this._simParamsComputeShader.addUniform(\"noiseStrength\", 3);\n    }\n    if (!this._parent.isLocal) {\n      this._simParamsComputeShader.addUniform(\"emitterWM\", 16);\n    }\n    if (this._parent.particleEmitterType) {\n      this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader);\n    }\n    this._updateComputeShader.setUniformBuffer(\"params\", this._simParamsComputeShader);\n    return new UniformBufferEffectCommonAccessor(this._simParamsComputeShader);\n  }\n  createVertexBuffers(updateBuffer, renderVertexBuffers) {\n    this._renderVertexBuffers.push(renderVertexBuffers);\n  }\n  createParticleBuffer(data) {\n    const buffer = new StorageBuffer(this._engine, data.length * 4, 3 | 8);\n    buffer.update(data);\n    this._bufferComputeShader.push(buffer);\n    return buffer.getBuffer();\n  }\n  bindDrawBuffers(index, effect) {\n    this._engine.bindBuffers(this._renderVertexBuffers[index], null, effect);\n  }\n  preUpdateParticleBuffer() {}\n  updateParticleBuffer(index, targetBuffer, currentActiveCount) {\n    this._simParamsComputeShader.update();\n    this._updateComputeShader.setTexture(\"randomTexture\", this._parent._randomTexture, false);\n    this._updateComputeShader.setTexture(\"randomTexture2\", this._parent._randomTexture2, false);\n    if (this._parent._sizeGradientsTexture) {\n      this._updateComputeShader.setTexture(\"sizeGradientTexture\", this._parent._sizeGradientsTexture);\n    }\n    if (this._parent._angularSpeedGradientsTexture) {\n      this._updateComputeShader.setTexture(\"angularSpeedGradientTexture\", this._parent._angularSpeedGradientsTexture);\n    }\n    if (this._parent._velocityGradientsTexture) {\n      this._updateComputeShader.setTexture(\"velocityGradientTexture\", this._parent._velocityGradientsTexture);\n    }\n    if (this._parent._limitVelocityGradientsTexture) {\n      this._updateComputeShader.setTexture(\"limitVelocityGradientTexture\", this._parent._limitVelocityGradientsTexture);\n    }\n    if (this._parent._dragGradientsTexture) {\n      this._updateComputeShader.setTexture(\"dragGradientTexture\", this._parent._dragGradientsTexture);\n    }\n    if (this._parent.noiseTexture) {\n      this._updateComputeShader.setTexture(\"noiseTexture\", this._parent.noiseTexture);\n    }\n    this._updateComputeShader.setStorageBuffer(\"particlesIn\", this._bufferComputeShader[index]);\n    this._updateComputeShader.setStorageBuffer(\"particlesOut\", this._bufferComputeShader[index ^ 1]);\n    this._updateComputeShader.dispatch(Math.ceil(currentActiveCount / 64));\n  }\n  releaseBuffers() {\n    var _a;\n    for (let i = 0; i < this._bufferComputeShader.length; ++i) {\n      this._bufferComputeShader[i].dispose();\n    }\n    this._bufferComputeShader.length = 0;\n    (_a = this._simParamsComputeShader) === null || _a === void 0 ? void 0 : _a.dispose();\n    this._simParamsComputeShader = null;\n    this._updateComputeShader = null;\n  }\n  releaseVertexBuffers() {\n    this._renderVertexBuffers.length = 0;\n  }\n}\nRegisterClass(\"BABYLON.ComputeShaderParticleSystem\", ComputeShaderParticleSystem);","map":{"version":3,"mappings":"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","names":["StorageBuffer","ComputeShader","UniformBuffer","UniformBufferEffectCommonAccessor","RegisterClass","ComputeShaderParticleSystem","constructor","parent","engine","_parent","_engine","isUpdateBufferCreated","_updateComputeShader","isUpdateBufferReady","isReady","createUpdateBuffer","defines","bindingsMapping","params","group","binding","particlesIn","particlesOut","randomTexture","randomTexture2","_sizeGradientsTexture","_angularSpeedGradientsTexture","_velocityGradientsTexture","_limitVelocityGradientsTexture","_dragGradientsTexture","noiseTexture","split","_simParamsComputeShader","dispose","addUniform","_colorGradientsTexture","isAnimationSheetEnabled","isLocal","particleEmitterType","buildUniformLayout","setUniformBuffer","createVertexBuffers","updateBuffer","renderVertexBuffers","_renderVertexBuffers","push","createParticleBuffer","data","buffer","length","update","_bufferComputeShader","getBuffer","bindDrawBuffers","index","effect","bindBuffers","preUpdateParticleBuffer","updateParticleBuffer","targetBuffer","currentActiveCount","setTexture","_randomTexture","_randomTexture2","setStorageBuffer","dispatch","Math","ceil","releaseBuffers","i","releaseVertexBuffers"],"sourceRoot":"","sources":["../../../../lts/core/generated/Particles/computeShaderParticleSystem.ts"],"sourcesContent":["import type { ThinEngine } from \"../Engines/thinEngine\";\r\nimport { StorageBuffer } from \"../Buffers/storageBuffer\";\r\nimport { ComputeShader } from \"../Compute/computeShader\";\r\nimport { UniformBuffer } from \"../Materials/uniformBuffer\";\r\nimport type { IGPUParticleSystemPlatform } from \"./IGPUParticleSystemPlatform\";\r\nimport type { Buffer, VertexBuffer } from \"../Buffers/buffer\";\r\nimport type { GPUParticleSystem } from \"./gpuParticleSystem\";\r\n\r\nimport type { DataArray } from \"../types\";\r\nimport type { DataBuffer } from \"../Buffers/dataBuffer\";\r\nimport { Constants } from \"../Engines/constants\";\r\nimport { UniformBufferEffectCommonAccessor } from \"../Materials/uniformBufferEffectCommonAccessor\";\r\nimport type { ComputeBindingMapping } from \"../Engines/Extensions/engine.computeShader\";\r\nimport type { Effect } from \"../Materials/effect\";\r\nimport { RegisterClass } from \"../Misc/typeStore\";\r\n\r\nimport \"../ShadersWGSL/gpuUpdateParticles.compute\";\r\n\r\n/** @internal */\r\nexport class ComputeShaderParticleSystem implements IGPUParticleSystemPlatform {\r\n    private _parent: GPUParticleSystem;\r\n    private _engine: ThinEngine;\r\n    private _updateComputeShader: ComputeShader;\r\n    private _simParamsComputeShader: UniformBuffer;\r\n    private _bufferComputeShader: StorageBuffer[] = [];\r\n    private _renderVertexBuffers: Array<{ [key: string]: VertexBuffer }> = [];\r\n\r\n    public readonly alignDataInBuffer = true;\r\n\r\n    constructor(parent: GPUParticleSystem, engine: ThinEngine) {\r\n        this._parent = parent;\r\n        this._engine = engine;\r\n    }\r\n\r\n    public isUpdateBufferCreated(): boolean {\r\n        return !!this._updateComputeShader;\r\n    }\r\n\r\n    public isUpdateBufferReady(): boolean {\r\n        return this._updateComputeShader?.isReady() ?? false;\r\n    }\r\n\r\n    public createUpdateBuffer(defines: string): UniformBufferEffectCommonAccessor {\r\n        const bindingsMapping: ComputeBindingMapping = {\r\n            params: { group: 0, binding: 0 },\r\n            particlesIn: { group: 0, binding: 1 },\r\n            particlesOut: { group: 0, binding: 2 },\r\n            randomTexture: { group: 0, binding: 3 },\r\n            randomTexture2: { group: 0, binding: 4 },\r\n        };\r\n        if (this._parent._sizeGradientsTexture) {\r\n            bindingsMapping[\"sizeGradientTexture\"] = { group: 1, binding: 1 };\r\n        }\r\n        if (this._parent._angularSpeedGradientsTexture) {\r\n            bindingsMapping[\"angularSpeedGradientTexture\"] = { group: 1, binding: 3 };\r\n        }\r\n        if (this._parent._velocityGradientsTexture) {\r\n            bindingsMapping[\"velocityGradientTexture\"] = { group: 1, binding: 5 };\r\n        }\r\n        if (this._parent._limitVelocityGradientsTexture) {\r\n            bindingsMapping[\"limitVelocityGradientTexture\"] = { group: 1, binding: 7 };\r\n        }\r\n        if (this._parent._dragGradientsTexture) {\r\n            bindingsMapping[\"dragGradientTexture\"] = { group: 1, binding: 9 };\r\n        }\r\n        if (this._parent.noiseTexture) {\r\n            bindingsMapping[\"noiseTexture\"] = { group: 1, binding: 11 };\r\n        }\r\n\r\n        this._updateComputeShader = new ComputeShader(\"updateParticles\", this._engine, \"gpuUpdateParticles\", { bindingsMapping, defines: defines.split(\"\\n\") });\r\n\r\n        this._simParamsComputeShader?.dispose();\r\n        this._simParamsComputeShader = new UniformBuffer(this._engine);\r\n\r\n        this._simParamsComputeShader.addUniform(\"currentCount\", 1);\r\n        this._simParamsComputeShader.addUniform(\"timeDelta\", 1);\r\n        this._simParamsComputeShader.addUniform(\"stopFactor\", 1);\r\n        this._simParamsComputeShader.addUniform(\"randomTextureSize\", 1);\r\n        this._simParamsComputeShader.addUniform(\"lifeTime\", 2);\r\n        this._simParamsComputeShader.addUniform(\"emitPower\", 2);\r\n        if (!this._parent._colorGradientsTexture) {\r\n            this._simParamsComputeShader.addUniform(\"color1\", 4);\r\n            this._simParamsComputeShader.addUniform(\"color2\", 4);\r\n        }\r\n        this._simParamsComputeShader.addUniform(\"sizeRange\", 2);\r\n        this._simParamsComputeShader.addUniform(\"scaleRange\", 4);\r\n        this._simParamsComputeShader.addUniform(\"angleRange\", 4);\r\n        this._simParamsComputeShader.addUniform(\"gravity\", 3);\r\n        if (this._parent._limitVelocityGradientsTexture) {\r\n            this._simParamsComputeShader.addUniform(\"limitVelocityDamping\", 1);\r\n        }\r\n        if (this._parent.isAnimationSheetEnabled) {\r\n            this._simParamsComputeShader.addUniform(\"cellInfos\", 4);\r\n        }\r\n        if (this._parent.noiseTexture) {\r\n            this._simParamsComputeShader.addUniform(\"noiseStrength\", 3);\r\n        }\r\n        if (!this._parent.isLocal) {\r\n            this._simParamsComputeShader.addUniform(\"emitterWM\", 16);\r\n        }\r\n        if (this._parent.particleEmitterType) {\r\n            this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader);\r\n        }\r\n\r\n        this._updateComputeShader.setUniformBuffer(\"params\", this._simParamsComputeShader);\r\n\r\n        return new UniformBufferEffectCommonAccessor(this._simParamsComputeShader);\r\n    }\r\n\r\n    public createVertexBuffers(updateBuffer: Buffer, renderVertexBuffers: { [key: string]: VertexBuffer }): void {\r\n        this._renderVertexBuffers.push(renderVertexBuffers);\r\n    }\r\n\r\n    public createParticleBuffer(data: number[]): DataArray | DataBuffer {\r\n        const buffer = new StorageBuffer(this._engine, data.length * 4, Constants.BUFFER_CREATIONFLAG_READWRITE | Constants.BUFFER_CREATIONFLAG_VERTEX);\r\n\r\n        buffer.update(data);\r\n        this._bufferComputeShader.push(buffer);\r\n\r\n        return buffer.getBuffer();\r\n    }\r\n\r\n    public bindDrawBuffers(index: number, effect: Effect): void {\r\n        this._engine.bindBuffers(this._renderVertexBuffers[index], null, effect);\r\n    }\r\n\r\n    public preUpdateParticleBuffer(): void {}\r\n\r\n    public updateParticleBuffer(index: number, targetBuffer: Buffer, currentActiveCount: number): void {\r\n        this._simParamsComputeShader.update();\r\n\r\n        this._updateComputeShader.setTexture(\"randomTexture\", this._parent._randomTexture, false);\r\n        this._updateComputeShader.setTexture(\"randomTexture2\", this._parent._randomTexture2, false);\r\n        if (this._parent._sizeGradientsTexture) {\r\n            this._updateComputeShader.setTexture(\"sizeGradientTexture\", this._parent._sizeGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._angularSpeedGradientsTexture) {\r\n            this._updateComputeShader.setTexture(\"angularSpeedGradientTexture\", this._parent._angularSpeedGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._velocityGradientsTexture) {\r\n            this._updateComputeShader.setTexture(\"velocityGradientTexture\", this._parent._velocityGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._limitVelocityGradientsTexture) {\r\n            this._updateComputeShader.setTexture(\"limitVelocityGradientTexture\", this._parent._limitVelocityGradientsTexture);\r\n        }\r\n\r\n        if (this._parent._dragGradientsTexture) {\r\n            this._updateComputeShader.setTexture(\"dragGradientTexture\", this._parent._dragGradientsTexture);\r\n        }\r\n\r\n        if (this._parent.noiseTexture) {\r\n            this._updateComputeShader.setTexture(\"noiseTexture\", this._parent.noiseTexture);\r\n        }\r\n\r\n        this._updateComputeShader.setStorageBuffer(\"particlesIn\", this._bufferComputeShader[index]);\r\n        this._updateComputeShader.setStorageBuffer(\"particlesOut\", this._bufferComputeShader[index ^ 1]);\r\n\r\n        this._updateComputeShader.dispatch(Math.ceil(currentActiveCount / 64));\r\n    }\r\n\r\n    public releaseBuffers(): void {\r\n        for (let i = 0; i < this._bufferComputeShader.length; ++i) {\r\n            this._bufferComputeShader[i].dispose();\r\n        }\r\n\r\n        this._bufferComputeShader.length = 0;\r\n\r\n        this._simParamsComputeShader?.dispose();\r\n        (<any>this._simParamsComputeShader) = null;\r\n\r\n        (<any>this._updateComputeShader) = null;\r\n    }\r\n\r\n    public releaseVertexBuffers(): void {\r\n        this._renderVertexBuffers.length = 0;\r\n    }\r\n}\r\n\r\nRegisterClass(\"BABYLON.ComputeShaderParticleSystem\", ComputeShaderParticleSystem);\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
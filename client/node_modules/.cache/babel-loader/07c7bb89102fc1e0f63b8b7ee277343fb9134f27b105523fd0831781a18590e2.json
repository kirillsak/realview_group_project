{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { __decorate } from \"../tslib.es6.js\";\n/* eslint-disable @typescript-eslint/naming-convention */\nimport { serialize, SerializationHelper, serializeAsTexture, serializeAsColorCurves, serializeAsColor4 } from \"../Misc/decorators.js\";\nimport { Observable } from \"../Misc/observable.js\";\nimport { Tools } from \"../Misc/tools.js\";\nimport { Color4 } from \"../Maths/math.color.js\";\nimport { MaterialDefines } from \"../Materials/materialDefines.js\";\nimport { ColorCurves } from \"../Materials/colorCurves.js\";\n/**\n * @internal\n */\nexport class ImageProcessingConfigurationDefines extends MaterialDefines {\n  constructor() {\n    super();\n    this.IMAGEPROCESSING = false;\n    this.VIGNETTE = false;\n    this.VIGNETTEBLENDMODEMULTIPLY = false;\n    this.VIGNETTEBLENDMODEOPAQUE = false;\n    this.TONEMAPPING = false;\n    this.TONEMAPPING_ACES = false;\n    this.CONTRAST = false;\n    this.COLORCURVES = false;\n    this.COLORGRADING = false;\n    this.COLORGRADING3D = false;\n    this.SAMPLER3DGREENDEPTH = false;\n    this.SAMPLER3DBGRMAP = false;\n    this.DITHER = false;\n    this.IMAGEPROCESSINGPOSTPROCESS = false;\n    this.EXPOSURE = false;\n    this.SKIPFINALCOLORCLAMP = false;\n    this.rebuild();\n  }\n}\n/**\n * This groups together the common properties used for image processing either in direct forward pass\n * or through post processing effect depending on the use of the image processing pipeline in your scene\n * or not.\n */\nexport class ImageProcessingConfiguration {\n  constructor() {\n    /**\n     * Color curves setup used in the effect if colorCurvesEnabled is set to true\n     */\n    this.colorCurves = new ColorCurves();\n    this._colorCurvesEnabled = false;\n    this._colorGradingEnabled = false;\n    this._colorGradingWithGreenDepth = true;\n    this._colorGradingBGR = true;\n    /** @internal */\n    this._exposure = 1.0;\n    this._toneMappingEnabled = false;\n    this._toneMappingType = ImageProcessingConfiguration.TONEMAPPING_STANDARD;\n    this._contrast = 1.0;\n    /**\n     * Vignette stretch size.\n     */\n    this.vignetteStretch = 0;\n    /**\n     * Vignette center X Offset.\n     */\n    this.vignetteCenterX = 0;\n    /**\n     * Vignette center Y Offset.\n     */\n    this.vignetteCenterY = 0;\n    /**\n     * Vignette weight or intensity of the vignette effect.\n     */\n    this.vignetteWeight = 1.5;\n    /**\n     * Color of the vignette applied on the screen through the chosen blend mode (vignetteBlendMode)\n     * if vignetteEnabled is set to true.\n     */\n    this.vignetteColor = new Color4(0, 0, 0, 0);\n    /**\n     * Camera field of view used by the Vignette effect.\n     */\n    this.vignetteCameraFov = 0.5;\n    this._vignetteBlendMode = ImageProcessingConfiguration.VIGNETTEMODE_MULTIPLY;\n    this._vignetteEnabled = false;\n    this._ditheringEnabled = false;\n    this._ditheringIntensity = 1.0 / 255.0;\n    /** @internal */\n    this._skipFinalColorClamp = false;\n    /** @internal */\n    this._applyByPostProcess = false;\n    this._isEnabled = true;\n    /**\n     * An event triggered when the configuration changes and requires Shader to Update some parameters.\n     */\n    this.onUpdateParameters = new Observable();\n  }\n  /**\n   * Gets whether the color curves effect is enabled.\n   */\n  get colorCurvesEnabled() {\n    return this._colorCurvesEnabled;\n  }\n  /**\n   * Sets whether the color curves effect is enabled.\n   */\n  set colorCurvesEnabled(value) {\n    if (this._colorCurvesEnabled === value) {\n      return;\n    }\n    this._colorCurvesEnabled = value;\n    this._updateParameters();\n  }\n  /**\n   * Color grading LUT texture used in the effect if colorGradingEnabled is set to true\n   */\n  get colorGradingTexture() {\n    return this._colorGradingTexture;\n  }\n  /**\n   * Color grading LUT texture used in the effect if colorGradingEnabled is set to true\n   */\n  set colorGradingTexture(value) {\n    if (this._colorGradingTexture === value) {\n      return;\n    }\n    this._colorGradingTexture = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the color grading effect is enabled.\n   */\n  get colorGradingEnabled() {\n    return this._colorGradingEnabled;\n  }\n  /**\n   * Sets whether the color grading effect is enabled.\n   */\n  set colorGradingEnabled(value) {\n    if (this._colorGradingEnabled === value) {\n      return;\n    }\n    this._colorGradingEnabled = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the color grading effect is using a green depth for the 3d Texture.\n   */\n  get colorGradingWithGreenDepth() {\n    return this._colorGradingWithGreenDepth;\n  }\n  /**\n   * Sets whether the color grading effect is using a green depth for the 3d Texture.\n   */\n  set colorGradingWithGreenDepth(value) {\n    if (this._colorGradingWithGreenDepth === value) {\n      return;\n    }\n    this._colorGradingWithGreenDepth = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the color grading texture contains BGR values.\n   */\n  get colorGradingBGR() {\n    return this._colorGradingBGR;\n  }\n  /**\n   * Sets whether the color grading texture contains BGR values.\n   */\n  set colorGradingBGR(value) {\n    if (this._colorGradingBGR === value) {\n      return;\n    }\n    this._colorGradingBGR = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets the Exposure used in the effect.\n   */\n  get exposure() {\n    return this._exposure;\n  }\n  /**\n   * Sets the Exposure used in the effect.\n   */\n  set exposure(value) {\n    if (this._exposure === value) {\n      return;\n    }\n    this._exposure = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the tone mapping effect is enabled.\n   */\n  get toneMappingEnabled() {\n    return this._toneMappingEnabled;\n  }\n  /**\n   * Sets whether the tone mapping effect is enabled.\n   */\n  set toneMappingEnabled(value) {\n    if (this._toneMappingEnabled === value) {\n      return;\n    }\n    this._toneMappingEnabled = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets the type of tone mapping effect.\n   */\n  get toneMappingType() {\n    return this._toneMappingType;\n  }\n  /**\n   * Sets the type of tone mapping effect used in BabylonJS.\n   */\n  set toneMappingType(value) {\n    if (this._toneMappingType === value) {\n      return;\n    }\n    this._toneMappingType = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets the contrast used in the effect.\n   */\n  get contrast() {\n    return this._contrast;\n  }\n  /**\n   * Sets the contrast used in the effect.\n   */\n  set contrast(value) {\n    if (this._contrast === value) {\n      return;\n    }\n    this._contrast = value;\n    this._updateParameters();\n  }\n  /**\n   * Back Compat: Vignette center Y Offset.\n   * @deprecated use vignetteCenterY instead\n   */\n  get vignetteCentreY() {\n    return this.vignetteCenterY;\n  }\n  set vignetteCentreY(value) {\n    this.vignetteCenterY = value;\n  }\n  /**\n   * Back Compat: Vignette center X Offset.\n   * @deprecated use vignetteCenterX instead\n   */\n  get vignetteCentreX() {\n    return this.vignetteCenterX;\n  }\n  set vignetteCentreX(value) {\n    this.vignetteCenterX = value;\n  }\n  /**\n   * Gets the vignette blend mode allowing different kind of effect.\n   */\n  get vignetteBlendMode() {\n    return this._vignetteBlendMode;\n  }\n  /**\n   * Sets the vignette blend mode allowing different kind of effect.\n   */\n  set vignetteBlendMode(value) {\n    if (this._vignetteBlendMode === value) {\n      return;\n    }\n    this._vignetteBlendMode = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the vignette effect is enabled.\n   */\n  get vignetteEnabled() {\n    return this._vignetteEnabled;\n  }\n  /**\n   * Sets whether the vignette effect is enabled.\n   */\n  set vignetteEnabled(value) {\n    if (this._vignetteEnabled === value) {\n      return;\n    }\n    this._vignetteEnabled = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the dithering effect is enabled.\n   * The dithering effect can be used to reduce banding.\n   */\n  get ditheringEnabled() {\n    return this._ditheringEnabled;\n  }\n  /**\n   * Sets whether the dithering effect is enabled.\n   * The dithering effect can be used to reduce banding.\n   */\n  set ditheringEnabled(value) {\n    if (this._ditheringEnabled === value) {\n      return;\n    }\n    this._ditheringEnabled = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets the dithering intensity. 0 is no dithering. Default is 1.0 / 255.0.\n   */\n  get ditheringIntensity() {\n    return this._ditheringIntensity;\n  }\n  /**\n   * Sets the dithering intensity. 0 is no dithering. Default is 1.0 / 255.0.\n   */\n  set ditheringIntensity(value) {\n    if (this._ditheringIntensity === value) {\n      return;\n    }\n    this._ditheringIntensity = value;\n    this._updateParameters();\n  }\n  /**\n   * If apply by post process is set to true, setting this to true will skip the the final color clamp step in the fragment shader\n   * Applies to PBR materials.\n   */\n  get skipFinalColorClamp() {\n    return this._skipFinalColorClamp;\n  }\n  /**\n   * If apply by post process is set to true, setting this to true will skip the the final color clamp step in the fragment shader\n   * Applies to PBR materials.\n   */\n  set skipFinalColorClamp(value) {\n    if (this._skipFinalColorClamp === value) {\n      return;\n    }\n    this._skipFinalColorClamp = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the image processing is applied through a post process or not.\n   */\n  get applyByPostProcess() {\n    return this._applyByPostProcess;\n  }\n  /**\n   * Sets whether the image processing is applied through a post process or not.\n   */\n  set applyByPostProcess(value) {\n    if (this._applyByPostProcess === value) {\n      return;\n    }\n    this._applyByPostProcess = value;\n    this._updateParameters();\n  }\n  /**\n   * Gets whether the image processing is enabled or not.\n   */\n  get isEnabled() {\n    return this._isEnabled;\n  }\n  /**\n   * Sets whether the image processing is enabled or not.\n   */\n  set isEnabled(value) {\n    if (this._isEnabled === value) {\n      return;\n    }\n    this._isEnabled = value;\n    this._updateParameters();\n  }\n  /**\n   * Method called each time the image processing information changes requires to recompile the effect.\n   */\n  _updateParameters() {\n    this.onUpdateParameters.notifyObservers(this);\n  }\n  /**\n   * Gets the current class name.\n   * @returns \"ImageProcessingConfiguration\"\n   */\n  getClassName() {\n    return \"ImageProcessingConfiguration\";\n  }\n  /**\n   * Prepare the list of uniforms associated with the Image Processing effects.\n   * @param uniforms The list of uniforms used in the effect\n   * @param defines the list of defines currently in use\n   */\n  static PrepareUniforms(uniforms, defines) {\n    if (defines.EXPOSURE) {\n      uniforms.push(\"exposureLinear\");\n    }\n    if (defines.CONTRAST) {\n      uniforms.push(\"contrast\");\n    }\n    if (defines.COLORGRADING) {\n      uniforms.push(\"colorTransformSettings\");\n    }\n    if (defines.VIGNETTE || defines.DITHER) {\n      uniforms.push(\"vInverseScreenSize\");\n    }\n    if (defines.VIGNETTE) {\n      uniforms.push(\"vignetteSettings1\");\n      uniforms.push(\"vignetteSettings2\");\n    }\n    if (defines.COLORCURVES) {\n      ColorCurves.PrepareUniforms(uniforms);\n    }\n    if (defines.DITHER) {\n      uniforms.push(\"ditherIntensity\");\n    }\n  }\n  /**\n   * Prepare the list of samplers associated with the Image Processing effects.\n   * @param samplersList The list of uniforms used in the effect\n   * @param defines the list of defines currently in use\n   */\n  static PrepareSamplers(samplersList, defines) {\n    if (defines.COLORGRADING) {\n      samplersList.push(\"txColorTransform\");\n    }\n  }\n  /**\n   * Prepare the list of defines associated to the shader.\n   * @param defines the list of defines to complete\n   * @param forPostProcess Define if we are currently in post process mode or not\n   */\n  prepareDefines(defines, forPostProcess = false) {\n    if (forPostProcess !== this.applyByPostProcess || !this._isEnabled) {\n      defines.VIGNETTE = false;\n      defines.TONEMAPPING = false;\n      defines.TONEMAPPING_ACES = false;\n      defines.CONTRAST = false;\n      defines.EXPOSURE = false;\n      defines.COLORCURVES = false;\n      defines.COLORGRADING = false;\n      defines.COLORGRADING3D = false;\n      defines.DITHER = false;\n      defines.IMAGEPROCESSING = false;\n      defines.SKIPFINALCOLORCLAMP = this.skipFinalColorClamp;\n      defines.IMAGEPROCESSINGPOSTPROCESS = this.applyByPostProcess && this._isEnabled;\n      return;\n    }\n    defines.VIGNETTE = this.vignetteEnabled;\n    defines.VIGNETTEBLENDMODEMULTIPLY = this.vignetteBlendMode === ImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY;\n    defines.VIGNETTEBLENDMODEOPAQUE = !defines.VIGNETTEBLENDMODEMULTIPLY;\n    defines.TONEMAPPING = this.toneMappingEnabled;\n    switch (this._toneMappingType) {\n      case ImageProcessingConfiguration.TONEMAPPING_ACES:\n        defines.TONEMAPPING_ACES = true;\n        break;\n      default:\n        defines.TONEMAPPING_ACES = false;\n        break;\n    }\n    defines.CONTRAST = this.contrast !== 1.0;\n    defines.EXPOSURE = this.exposure !== 1.0;\n    defines.COLORCURVES = this.colorCurvesEnabled && !!this.colorCurves;\n    defines.COLORGRADING = this.colorGradingEnabled && !!this.colorGradingTexture;\n    if (defines.COLORGRADING) {\n      defines.COLORGRADING3D = this.colorGradingTexture.is3D;\n    } else {\n      defines.COLORGRADING3D = false;\n    }\n    defines.SAMPLER3DGREENDEPTH = this.colorGradingWithGreenDepth;\n    defines.SAMPLER3DBGRMAP = this.colorGradingBGR;\n    defines.DITHER = this._ditheringEnabled;\n    defines.IMAGEPROCESSINGPOSTPROCESS = this.applyByPostProcess;\n    defines.SKIPFINALCOLORCLAMP = this.skipFinalColorClamp;\n    defines.IMAGEPROCESSING = defines.VIGNETTE || defines.TONEMAPPING || defines.CONTRAST || defines.EXPOSURE || defines.COLORCURVES || defines.COLORGRADING || defines.DITHER;\n  }\n  /**\n   * Returns true if all the image processing information are ready.\n   * @returns True if ready, otherwise, false\n   */\n  isReady() {\n    // Color Grading texture can not be none blocking.\n    return !this.colorGradingEnabled || !this.colorGradingTexture || this.colorGradingTexture.isReady();\n  }\n  /**\n   * Binds the image processing to the shader.\n   * @param effect The effect to bind to\n   * @param overrideAspectRatio Override the aspect ratio of the effect\n   */\n  bind(effect, overrideAspectRatio) {\n    // Color Curves\n    if (this._colorCurvesEnabled && this.colorCurves) {\n      ColorCurves.Bind(this.colorCurves, effect);\n    }\n    // Vignette and dither handled together due to common uniform.\n    if (this._vignetteEnabled || this._ditheringEnabled) {\n      const inverseWidth = 1 / effect.getEngine().getRenderWidth();\n      const inverseHeight = 1 / effect.getEngine().getRenderHeight();\n      effect.setFloat2(\"vInverseScreenSize\", inverseWidth, inverseHeight);\n      if (this._ditheringEnabled) {\n        effect.setFloat(\"ditherIntensity\", 0.5 * this._ditheringIntensity);\n      }\n      if (this._vignetteEnabled) {\n        const aspectRatio = overrideAspectRatio != null ? overrideAspectRatio : inverseHeight / inverseWidth;\n        let vignetteScaleY = Math.tan(this.vignetteCameraFov * 0.5);\n        let vignetteScaleX = vignetteScaleY * aspectRatio;\n        const vignetteScaleGeometricMean = Math.sqrt(vignetteScaleX * vignetteScaleY);\n        vignetteScaleX = Tools.Mix(vignetteScaleX, vignetteScaleGeometricMean, this.vignetteStretch);\n        vignetteScaleY = Tools.Mix(vignetteScaleY, vignetteScaleGeometricMean, this.vignetteStretch);\n        effect.setFloat4(\"vignetteSettings1\", vignetteScaleX, vignetteScaleY, -vignetteScaleX * this.vignetteCenterX, -vignetteScaleY * this.vignetteCenterY);\n        const vignettePower = -2.0 * this.vignetteWeight;\n        effect.setFloat4(\"vignetteSettings2\", this.vignetteColor.r, this.vignetteColor.g, this.vignetteColor.b, vignettePower);\n      }\n    }\n    // Exposure\n    effect.setFloat(\"exposureLinear\", this.exposure);\n    // Contrast\n    effect.setFloat(\"contrast\", this.contrast);\n    // Color transform settings\n    if (this.colorGradingTexture) {\n      effect.setTexture(\"txColorTransform\", this.colorGradingTexture);\n      const textureSize = this.colorGradingTexture.getSize().height;\n      effect.setFloat4(\"colorTransformSettings\", (textureSize - 1) / textureSize,\n      // textureScale\n      0.5 / textureSize,\n      // textureOffset\n      textureSize,\n      // textureSize\n      this.colorGradingTexture.level // weight\n      );\n    }\n  }\n  /**\n   * Clones the current image processing instance.\n   * @returns The cloned image processing\n   */\n  clone() {\n    return SerializationHelper.Clone(() => new ImageProcessingConfiguration(), this);\n  }\n  /**\n   * Serializes the current image processing instance to a json representation.\n   * @returns a JSON representation\n   */\n  serialize() {\n    return SerializationHelper.Serialize(this);\n  }\n  /**\n   * Parses the image processing from a json representation.\n   * @param source the JSON source to parse\n   * @returns The parsed image processing\n   */\n  static Parse(source) {\n    const parsed = SerializationHelper.Parse(() => new ImageProcessingConfiguration(), source, null, null);\n    // Backward compatibility\n    if (source.vignetteCentreX !== undefined) {\n      parsed.vignetteCenterX = source.vignetteCentreX;\n    }\n    if (source.vignetteCentreY !== undefined) {\n      parsed.vignetteCenterY = source.vignetteCentreY;\n    }\n    return parsed;\n  }\n  /**\n   * Used to apply the vignette as a mix with the pixel color.\n   */\n  static get VIGNETTEMODE_MULTIPLY() {\n    return this._VIGNETTEMODE_MULTIPLY;\n  }\n  /**\n   * Used to apply the vignette as a replacement of the pixel color.\n   */\n  static get VIGNETTEMODE_OPAQUE() {\n    return this._VIGNETTEMODE_OPAQUE;\n  }\n}\n/**\n * Default tone mapping applied in BabylonJS.\n */\nImageProcessingConfiguration.TONEMAPPING_STANDARD = 0;\n/**\n * ACES Tone mapping (used by default in unreal and unity). This can help getting closer\n * to other engines rendering to increase portability.\n */\nImageProcessingConfiguration.TONEMAPPING_ACES = 1;\n// Static constants associated to the image processing.\nImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY = 0;\nImageProcessingConfiguration._VIGNETTEMODE_OPAQUE = 1;\n__decorate([serializeAsColorCurves()], ImageProcessingConfiguration.prototype, \"colorCurves\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_colorCurvesEnabled\", void 0);\n__decorate([serializeAsTexture(\"colorGradingTexture\")], ImageProcessingConfiguration.prototype, \"_colorGradingTexture\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_colorGradingEnabled\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_colorGradingWithGreenDepth\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_colorGradingBGR\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_exposure\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_toneMappingEnabled\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_toneMappingType\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_contrast\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"vignetteStretch\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"vignetteCenterX\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"vignetteCenterY\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"vignetteWeight\", void 0);\n__decorate([serializeAsColor4()], ImageProcessingConfiguration.prototype, \"vignetteColor\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"vignetteCameraFov\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_vignetteBlendMode\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_vignetteEnabled\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_ditheringEnabled\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_ditheringIntensity\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_skipFinalColorClamp\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_applyByPostProcess\", void 0);\n__decorate([serialize()], ImageProcessingConfiguration.prototype, \"_isEnabled\", void 0);\n// References the dependencies.\nSerializationHelper._ImageProcessingConfigurationParser = ImageProcessingConfiguration.Parse;","map":{"version":3,"mappings":"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","names":["serialize","SerializationHelper","serializeAsTexture","serializeAsColorCurves","serializeAsColor4","Observable","Tools","Color4","MaterialDefines","ColorCurves","ImageProcessingConfigurationDefines","constructor","rebuild","ImageProcessingConfiguration","TONEMAPPING_STANDARD","VIGNETTEMODE_MULTIPLY","colorCurvesEnabled","_colorCurvesEnabled","value","_updateParameters","colorGradingTexture","_colorGradingTexture","colorGradingEnabled","_colorGradingEnabled","colorGradingWithGreenDepth","_colorGradingWithGreenDepth","colorGradingBGR","_colorGradingBGR","exposure","_exposure","toneMappingEnabled","_toneMappingEnabled","toneMappingType","_toneMappingType","contrast","_contrast","vignetteCentreY","vignetteCenterY","vignetteCentreX","vignetteCenterX","vignetteBlendMode","_vignetteBlendMode","vignetteEnabled","_vignetteEnabled","ditheringEnabled","_ditheringEnabled","ditheringIntensity","_ditheringIntensity","skipFinalColorClamp","_skipFinalColorClamp","applyByPostProcess","_applyByPostProcess","isEnabled","_isEnabled","onUpdateParameters","notifyObservers","getClassName","PrepareUniforms","uniforms","defines","EXPOSURE","push","CONTRAST","COLORGRADING","VIGNETTE","DITHER","COLORCURVES","PrepareSamplers","samplersList","prepareDefines","forPostProcess","TONEMAPPING","TONEMAPPING_ACES","COLORGRADING3D","IMAGEPROCESSING","SKIPFINALCOLORCLAMP","IMAGEPROCESSINGPOSTPROCESS","VIGNETTEBLENDMODEMULTIPLY","_VIGNETTEMODE_MULTIPLY","VIGNETTEBLENDMODEOPAQUE","colorCurves","is3D","SAMPLER3DGREENDEPTH","SAMPLER3DBGRMAP","isReady","bind","effect","overrideAspectRatio","Bind","inverseWidth","getEngine","getRenderWidth","inverseHeight","getRenderHeight","setFloat2","setFloat","aspectRatio","vignetteScaleY","Math","tan","vignetteCameraFov","vignetteScaleX","vignetteScaleGeometricMean","sqrt","Mix","vignetteStretch","setFloat4","vignettePower","vignetteWeight","vignetteColor","r","g","b","setTexture","textureSize","getSize","height","level","clone","Clone","Serialize","Parse","source","parsed","undefined","VIGNETTEMODE_OPAQUE","_VIGNETTEMODE_OPAQUE","__decorate","_ImageProcessingConfigurationParser"],"sourceRoot":"","sources":["../../../../lts/core/generated/Materials/imageProcessingConfiguration.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\r\nimport { serialize, SerializationHelper, serializeAsTexture, serializeAsColorCurves, serializeAsColor4 } from \"../Misc/decorators\";\r\nimport { Observable } from \"../Misc/observable\";\r\nimport { Tools } from \"../Misc/tools\";\r\nimport type { Nullable } from \"../types\";\r\nimport { Color4 } from \"../Maths/math.color\";\r\nimport { MaterialDefines } from \"../Materials/materialDefines\";\r\nimport { ColorCurves } from \"../Materials/colorCurves\";\r\n\r\ndeclare type BaseTexture = import(\"../Materials/Textures/baseTexture\").BaseTexture;\r\ndeclare type Effect = import(\"../Materials/effect\").Effect;\r\n\r\n/**\r\n * Interface to follow in your material defines to integrate easily the\r\n * Image processing functions.\r\n * @internal\r\n */\r\nexport interface IImageProcessingConfigurationDefines {\r\n    IMAGEPROCESSING: boolean;\r\n    VIGNETTE: boolean;\r\n    VIGNETTEBLENDMODEMULTIPLY: boolean;\r\n    VIGNETTEBLENDMODEOPAQUE: boolean;\r\n    TONEMAPPING: boolean;\r\n    TONEMAPPING_ACES: boolean;\r\n    CONTRAST: boolean;\r\n    EXPOSURE: boolean;\r\n    COLORCURVES: boolean;\r\n    COLORGRADING: boolean;\r\n    COLORGRADING3D: boolean;\r\n    SAMPLER3DGREENDEPTH: boolean;\r\n    SAMPLER3DBGRMAP: boolean;\r\n    DITHER: boolean;\r\n    IMAGEPROCESSINGPOSTPROCESS: boolean;\r\n    SKIPFINALCOLORCLAMP: boolean;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class ImageProcessingConfigurationDefines extends MaterialDefines implements IImageProcessingConfigurationDefines {\r\n    public IMAGEPROCESSING = false;\r\n    public VIGNETTE = false;\r\n    public VIGNETTEBLENDMODEMULTIPLY = false;\r\n    public VIGNETTEBLENDMODEOPAQUE = false;\r\n    public TONEMAPPING = false;\r\n    public TONEMAPPING_ACES = false;\r\n    public CONTRAST = false;\r\n    public COLORCURVES = false;\r\n    public COLORGRADING = false;\r\n    public COLORGRADING3D = false;\r\n    public SAMPLER3DGREENDEPTH = false;\r\n    public SAMPLER3DBGRMAP = false;\r\n    public DITHER = false;\r\n    public IMAGEPROCESSINGPOSTPROCESS = false;\r\n    public EXPOSURE = false;\r\n    public SKIPFINALCOLORCLAMP = false;\r\n\r\n    constructor() {\r\n        super();\r\n        this.rebuild();\r\n    }\r\n}\r\n\r\n/**\r\n * This groups together the common properties used for image processing either in direct forward pass\r\n * or through post processing effect depending on the use of the image processing pipeline in your scene\r\n * or not.\r\n */\r\nexport class ImageProcessingConfiguration {\r\n    /**\r\n     * Default tone mapping applied in BabylonJS.\r\n     */\r\n    public static readonly TONEMAPPING_STANDARD = 0;\r\n\r\n    /**\r\n     * ACES Tone mapping (used by default in unreal and unity). This can help getting closer\r\n     * to other engines rendering to increase portability.\r\n     */\r\n    public static readonly TONEMAPPING_ACES = 1;\r\n\r\n    /**\r\n     * Color curves setup used in the effect if colorCurvesEnabled is set to true\r\n     */\r\n    @serializeAsColorCurves()\r\n    public colorCurves: Nullable<ColorCurves> = new ColorCurves();\r\n\r\n    @serialize()\r\n    private _colorCurvesEnabled = false;\r\n    /**\r\n     * Gets whether the color curves effect is enabled.\r\n     */\r\n    public get colorCurvesEnabled(): boolean {\r\n        return this._colorCurvesEnabled;\r\n    }\r\n    /**\r\n     * Sets whether the color curves effect is enabled.\r\n     */\r\n    public set colorCurvesEnabled(value: boolean) {\r\n        if (this._colorCurvesEnabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._colorCurvesEnabled = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serializeAsTexture(\"colorGradingTexture\")\r\n    private _colorGradingTexture: Nullable<BaseTexture>;\r\n    /**\r\n     * Color grading LUT texture used in the effect if colorGradingEnabled is set to true\r\n     */\r\n    public get colorGradingTexture(): Nullable<BaseTexture> {\r\n        return this._colorGradingTexture;\r\n    }\r\n    /**\r\n     * Color grading LUT texture used in the effect if colorGradingEnabled is set to true\r\n     */\r\n    public set colorGradingTexture(value: Nullable<BaseTexture>) {\r\n        if (this._colorGradingTexture === value) {\r\n            return;\r\n        }\r\n\r\n        this._colorGradingTexture = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _colorGradingEnabled = false;\r\n    /**\r\n     * Gets whether the color grading effect is enabled.\r\n     */\r\n    public get colorGradingEnabled(): boolean {\r\n        return this._colorGradingEnabled;\r\n    }\r\n    /**\r\n     * Sets whether the color grading effect is enabled.\r\n     */\r\n    public set colorGradingEnabled(value: boolean) {\r\n        if (this._colorGradingEnabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._colorGradingEnabled = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _colorGradingWithGreenDepth = true;\r\n    /**\r\n     * Gets whether the color grading effect is using a green depth for the 3d Texture.\r\n     */\r\n    public get colorGradingWithGreenDepth(): boolean {\r\n        return this._colorGradingWithGreenDepth;\r\n    }\r\n    /**\r\n     * Sets whether the color grading effect is using a green depth for the 3d Texture.\r\n     */\r\n    public set colorGradingWithGreenDepth(value: boolean) {\r\n        if (this._colorGradingWithGreenDepth === value) {\r\n            return;\r\n        }\r\n\r\n        this._colorGradingWithGreenDepth = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _colorGradingBGR = true;\r\n    /**\r\n     * Gets whether the color grading texture contains BGR values.\r\n     */\r\n    public get colorGradingBGR(): boolean {\r\n        return this._colorGradingBGR;\r\n    }\r\n    /**\r\n     * Sets whether the color grading texture contains BGR values.\r\n     */\r\n    public set colorGradingBGR(value: boolean) {\r\n        if (this._colorGradingBGR === value) {\r\n            return;\r\n        }\r\n\r\n        this._colorGradingBGR = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    /** @internal */\r\n    @serialize()\r\n    public _exposure = 1.0;\r\n    /**\r\n     * Gets the Exposure used in the effect.\r\n     */\r\n    public get exposure(): number {\r\n        return this._exposure;\r\n    }\r\n    /**\r\n     * Sets the Exposure used in the effect.\r\n     */\r\n    public set exposure(value: number) {\r\n        if (this._exposure === value) {\r\n            return;\r\n        }\r\n\r\n        this._exposure = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _toneMappingEnabled = false;\r\n    /**\r\n     * Gets whether the tone mapping effect is enabled.\r\n     */\r\n    public get toneMappingEnabled(): boolean {\r\n        return this._toneMappingEnabled;\r\n    }\r\n    /**\r\n     * Sets whether the tone mapping effect is enabled.\r\n     */\r\n    public set toneMappingEnabled(value: boolean) {\r\n        if (this._toneMappingEnabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._toneMappingEnabled = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _toneMappingType = ImageProcessingConfiguration.TONEMAPPING_STANDARD;\r\n    /**\r\n     * Gets the type of tone mapping effect.\r\n     */\r\n    public get toneMappingType(): number {\r\n        return this._toneMappingType;\r\n    }\r\n    /**\r\n     * Sets the type of tone mapping effect used in BabylonJS.\r\n     */\r\n    public set toneMappingType(value: number) {\r\n        if (this._toneMappingType === value) {\r\n            return;\r\n        }\r\n\r\n        this._toneMappingType = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    protected _contrast = 1.0;\r\n    /**\r\n     * Gets the contrast used in the effect.\r\n     */\r\n    public get contrast(): number {\r\n        return this._contrast;\r\n    }\r\n    /**\r\n     * Sets the contrast used in the effect.\r\n     */\r\n    public set contrast(value: number) {\r\n        if (this._contrast === value) {\r\n            return;\r\n        }\r\n\r\n        this._contrast = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    /**\r\n     * Vignette stretch size.\r\n     */\r\n    @serialize()\r\n    public vignetteStretch = 0;\r\n\r\n    /**\r\n     * Vignette center X Offset.\r\n     */\r\n    @serialize()\r\n    public vignetteCenterX = 0;\r\n\r\n    /**\r\n     * Vignette center Y Offset.\r\n     */\r\n    @serialize()\r\n    public vignetteCenterY = 0;\r\n\r\n    /**\r\n     * Back Compat: Vignette center Y Offset.\r\n     * @deprecated use vignetteCenterY instead\r\n     */\r\n    public get vignetteCentreY(): number {\r\n        return this.vignetteCenterY;\r\n    }\r\n    public set vignetteCentreY(value: number) {\r\n        this.vignetteCenterY = value;\r\n    }\r\n\r\n    /**\r\n     * Back Compat: Vignette center X Offset.\r\n     * @deprecated use vignetteCenterX instead\r\n     */\r\n    public get vignetteCentreX(): number {\r\n        return this.vignetteCenterX;\r\n    }\r\n    public set vignetteCentreX(value: number) {\r\n        this.vignetteCenterX = value;\r\n    }\r\n\r\n    /**\r\n     * Vignette weight or intensity of the vignette effect.\r\n     */\r\n    @serialize()\r\n    public vignetteWeight = 1.5;\r\n\r\n    /**\r\n     * Color of the vignette applied on the screen through the chosen blend mode (vignetteBlendMode)\r\n     * if vignetteEnabled is set to true.\r\n     */\r\n    @serializeAsColor4()\r\n    public vignetteColor: Color4 = new Color4(0, 0, 0, 0);\r\n\r\n    /**\r\n     * Camera field of view used by the Vignette effect.\r\n     */\r\n    @serialize()\r\n    public vignetteCameraFov = 0.5;\r\n\r\n    @serialize()\r\n    private _vignetteBlendMode = ImageProcessingConfiguration.VIGNETTEMODE_MULTIPLY;\r\n    /**\r\n     * Gets the vignette blend mode allowing different kind of effect.\r\n     */\r\n    public get vignetteBlendMode(): number {\r\n        return this._vignetteBlendMode;\r\n    }\r\n    /**\r\n     * Sets the vignette blend mode allowing different kind of effect.\r\n     */\r\n    public set vignetteBlendMode(value: number) {\r\n        if (this._vignetteBlendMode === value) {\r\n            return;\r\n        }\r\n\r\n        this._vignetteBlendMode = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _vignetteEnabled = false;\r\n    /**\r\n     * Gets whether the vignette effect is enabled.\r\n     */\r\n    public get vignetteEnabled(): boolean {\r\n        return this._vignetteEnabled;\r\n    }\r\n    /**\r\n     * Sets whether the vignette effect is enabled.\r\n     */\r\n    public set vignetteEnabled(value: boolean) {\r\n        if (this._vignetteEnabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._vignetteEnabled = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _ditheringEnabled = false;\r\n    /**\r\n     * Gets whether the dithering effect is enabled.\r\n     * The dithering effect can be used to reduce banding.\r\n     */\r\n    public get ditheringEnabled(): boolean {\r\n        return this._ditheringEnabled;\r\n    }\r\n    /**\r\n     * Sets whether the dithering effect is enabled.\r\n     * The dithering effect can be used to reduce banding.\r\n     */\r\n    public set ditheringEnabled(value: boolean) {\r\n        if (this._ditheringEnabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._ditheringEnabled = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _ditheringIntensity = 1.0 / 255.0;\r\n    /**\r\n     * Gets the dithering intensity. 0 is no dithering. Default is 1.0 / 255.0.\r\n     */\r\n    public get ditheringIntensity(): number {\r\n        return this._ditheringIntensity;\r\n    }\r\n    /**\r\n     * Sets the dithering intensity. 0 is no dithering. Default is 1.0 / 255.0.\r\n     */\r\n    public set ditheringIntensity(value: number) {\r\n        if (this._ditheringIntensity === value) {\r\n            return;\r\n        }\r\n\r\n        this._ditheringIntensity = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    /** @internal */\r\n    @serialize()\r\n    public _skipFinalColorClamp = false;\r\n    /**\r\n     * If apply by post process is set to true, setting this to true will skip the the final color clamp step in the fragment shader\r\n     * Applies to PBR materials.\r\n     */\r\n    public get skipFinalColorClamp(): boolean {\r\n        return this._skipFinalColorClamp;\r\n    }\r\n    /**\r\n     * If apply by post process is set to true, setting this to true will skip the the final color clamp step in the fragment shader\r\n     * Applies to PBR materials.\r\n     */\r\n    public set skipFinalColorClamp(value: boolean) {\r\n        if (this._skipFinalColorClamp === value) {\r\n            return;\r\n        }\r\n\r\n        this._skipFinalColorClamp = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    /** @internal */\r\n    @serialize()\r\n    public _applyByPostProcess = false;\r\n    /**\r\n     * Gets whether the image processing is applied through a post process or not.\r\n     */\r\n    public get applyByPostProcess(): boolean {\r\n        return this._applyByPostProcess;\r\n    }\r\n    /**\r\n     * Sets whether the image processing is applied through a post process or not.\r\n     */\r\n    public set applyByPostProcess(value: boolean) {\r\n        if (this._applyByPostProcess === value) {\r\n            return;\r\n        }\r\n\r\n        this._applyByPostProcess = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    @serialize()\r\n    private _isEnabled = true;\r\n    /**\r\n     * Gets whether the image processing is enabled or not.\r\n     */\r\n    public get isEnabled(): boolean {\r\n        return this._isEnabled;\r\n    }\r\n    /**\r\n     * Sets whether the image processing is enabled or not.\r\n     */\r\n    public set isEnabled(value: boolean) {\r\n        if (this._isEnabled === value) {\r\n            return;\r\n        }\r\n\r\n        this._isEnabled = value;\r\n        this._updateParameters();\r\n    }\r\n\r\n    /**\r\n     * An event triggered when the configuration changes and requires Shader to Update some parameters.\r\n     */\r\n    public onUpdateParameters = new Observable<ImageProcessingConfiguration>();\r\n\r\n    /**\r\n     * Method called each time the image processing information changes requires to recompile the effect.\r\n     */\r\n    protected _updateParameters(): void {\r\n        this.onUpdateParameters.notifyObservers(this);\r\n    }\r\n\r\n    /**\r\n     * Gets the current class name.\r\n     * @returns \"ImageProcessingConfiguration\"\r\n     */\r\n    public getClassName(): string {\r\n        return \"ImageProcessingConfiguration\";\r\n    }\r\n\r\n    /**\r\n     * Prepare the list of uniforms associated with the Image Processing effects.\r\n     * @param uniforms The list of uniforms used in the effect\r\n     * @param defines the list of defines currently in use\r\n     */\r\n    public static PrepareUniforms(uniforms: string[], defines: IImageProcessingConfigurationDefines): void {\r\n        if (defines.EXPOSURE) {\r\n            uniforms.push(\"exposureLinear\");\r\n        }\r\n        if (defines.CONTRAST) {\r\n            uniforms.push(\"contrast\");\r\n        }\r\n        if (defines.COLORGRADING) {\r\n            uniforms.push(\"colorTransformSettings\");\r\n        }\r\n        if (defines.VIGNETTE || defines.DITHER) {\r\n            uniforms.push(\"vInverseScreenSize\");\r\n        }\r\n        if (defines.VIGNETTE) {\r\n            uniforms.push(\"vignetteSettings1\");\r\n            uniforms.push(\"vignetteSettings2\");\r\n        }\r\n        if (defines.COLORCURVES) {\r\n            ColorCurves.PrepareUniforms(uniforms);\r\n        }\r\n        if (defines.DITHER) {\r\n            uniforms.push(\"ditherIntensity\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Prepare the list of samplers associated with the Image Processing effects.\r\n     * @param samplersList The list of uniforms used in the effect\r\n     * @param defines the list of defines currently in use\r\n     */\r\n    public static PrepareSamplers(samplersList: string[], defines: IImageProcessingConfigurationDefines): void {\r\n        if (defines.COLORGRADING) {\r\n            samplersList.push(\"txColorTransform\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Prepare the list of defines associated to the shader.\r\n     * @param defines the list of defines to complete\r\n     * @param forPostProcess Define if we are currently in post process mode or not\r\n     */\r\n    public prepareDefines(defines: IImageProcessingConfigurationDefines, forPostProcess = false): void {\r\n        if (forPostProcess !== this.applyByPostProcess || !this._isEnabled) {\r\n            defines.VIGNETTE = false;\r\n            defines.TONEMAPPING = false;\r\n            defines.TONEMAPPING_ACES = false;\r\n            defines.CONTRAST = false;\r\n            defines.EXPOSURE = false;\r\n            defines.COLORCURVES = false;\r\n            defines.COLORGRADING = false;\r\n            defines.COLORGRADING3D = false;\r\n            defines.DITHER = false;\r\n            defines.IMAGEPROCESSING = false;\r\n            defines.SKIPFINALCOLORCLAMP = this.skipFinalColorClamp;\r\n            defines.IMAGEPROCESSINGPOSTPROCESS = this.applyByPostProcess && this._isEnabled;\r\n            return;\r\n        }\r\n\r\n        defines.VIGNETTE = this.vignetteEnabled;\r\n        defines.VIGNETTEBLENDMODEMULTIPLY = this.vignetteBlendMode === ImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY;\r\n        defines.VIGNETTEBLENDMODEOPAQUE = !defines.VIGNETTEBLENDMODEMULTIPLY;\r\n\r\n        defines.TONEMAPPING = this.toneMappingEnabled;\r\n        switch (this._toneMappingType) {\r\n            case ImageProcessingConfiguration.TONEMAPPING_ACES:\r\n                defines.TONEMAPPING_ACES = true;\r\n                break;\r\n            default:\r\n                defines.TONEMAPPING_ACES = false;\r\n                break;\r\n        }\r\n\r\n        defines.CONTRAST = this.contrast !== 1.0;\r\n        defines.EXPOSURE = this.exposure !== 1.0;\r\n        defines.COLORCURVES = this.colorCurvesEnabled && !!this.colorCurves;\r\n        defines.COLORGRADING = this.colorGradingEnabled && !!this.colorGradingTexture;\r\n        if (defines.COLORGRADING) {\r\n            defines.COLORGRADING3D = this.colorGradingTexture!.is3D;\r\n        } else {\r\n            defines.COLORGRADING3D = false;\r\n        }\r\n        defines.SAMPLER3DGREENDEPTH = this.colorGradingWithGreenDepth;\r\n        defines.SAMPLER3DBGRMAP = this.colorGradingBGR;\r\n        defines.DITHER = this._ditheringEnabled;\r\n        defines.IMAGEPROCESSINGPOSTPROCESS = this.applyByPostProcess;\r\n        defines.SKIPFINALCOLORCLAMP = this.skipFinalColorClamp;\r\n        defines.IMAGEPROCESSING = defines.VIGNETTE || defines.TONEMAPPING || defines.CONTRAST || defines.EXPOSURE || defines.COLORCURVES || defines.COLORGRADING || defines.DITHER;\r\n    }\r\n\r\n    /**\r\n     * Returns true if all the image processing information are ready.\r\n     * @returns True if ready, otherwise, false\r\n     */\r\n    public isReady() {\r\n        // Color Grading texture can not be none blocking.\r\n        return !this.colorGradingEnabled || !this.colorGradingTexture || this.colorGradingTexture.isReady();\r\n    }\r\n\r\n    /**\r\n     * Binds the image processing to the shader.\r\n     * @param effect The effect to bind to\r\n     * @param overrideAspectRatio Override the aspect ratio of the effect\r\n     */\r\n    public bind(effect: Effect, overrideAspectRatio?: number): void {\r\n        // Color Curves\r\n        if (this._colorCurvesEnabled && this.colorCurves) {\r\n            ColorCurves.Bind(this.colorCurves, effect);\r\n        }\r\n\r\n        // Vignette and dither handled together due to common uniform.\r\n        if (this._vignetteEnabled || this._ditheringEnabled) {\r\n            const inverseWidth = 1 / effect.getEngine().getRenderWidth();\r\n            const inverseHeight = 1 / effect.getEngine().getRenderHeight();\r\n            effect.setFloat2(\"vInverseScreenSize\", inverseWidth, inverseHeight);\r\n\r\n            if (this._ditheringEnabled) {\r\n                effect.setFloat(\"ditherIntensity\", 0.5 * this._ditheringIntensity);\r\n            }\r\n\r\n            if (this._vignetteEnabled) {\r\n                const aspectRatio = overrideAspectRatio != null ? overrideAspectRatio : inverseHeight / inverseWidth;\r\n\r\n                let vignetteScaleY = Math.tan(this.vignetteCameraFov * 0.5);\r\n                let vignetteScaleX = vignetteScaleY * aspectRatio;\r\n\r\n                const vignetteScaleGeometricMean = Math.sqrt(vignetteScaleX * vignetteScaleY);\r\n                vignetteScaleX = Tools.Mix(vignetteScaleX, vignetteScaleGeometricMean, this.vignetteStretch);\r\n                vignetteScaleY = Tools.Mix(vignetteScaleY, vignetteScaleGeometricMean, this.vignetteStretch);\r\n\r\n                effect.setFloat4(\"vignetteSettings1\", vignetteScaleX, vignetteScaleY, -vignetteScaleX * this.vignetteCenterX, -vignetteScaleY * this.vignetteCenterY);\r\n\r\n                const vignettePower = -2.0 * this.vignetteWeight;\r\n                effect.setFloat4(\"vignetteSettings2\", this.vignetteColor.r, this.vignetteColor.g, this.vignetteColor.b, vignettePower);\r\n            }\r\n        }\r\n\r\n        // Exposure\r\n        effect.setFloat(\"exposureLinear\", this.exposure);\r\n\r\n        // Contrast\r\n        effect.setFloat(\"contrast\", this.contrast);\r\n\r\n        // Color transform settings\r\n        if (this.colorGradingTexture) {\r\n            effect.setTexture(\"txColorTransform\", this.colorGradingTexture);\r\n            const textureSize = this.colorGradingTexture.getSize().height;\r\n\r\n            effect.setFloat4(\r\n                \"colorTransformSettings\",\r\n                (textureSize - 1) / textureSize, // textureScale\r\n                0.5 / textureSize, // textureOffset\r\n                textureSize, // textureSize\r\n                this.colorGradingTexture.level // weight\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clones the current image processing instance.\r\n     * @returns The cloned image processing\r\n     */\r\n    public clone(): ImageProcessingConfiguration {\r\n        return SerializationHelper.Clone(() => new ImageProcessingConfiguration(), this);\r\n    }\r\n\r\n    /**\r\n     * Serializes the current image processing instance to a json representation.\r\n     * @returns a JSON representation\r\n     */\r\n    public serialize(): any {\r\n        return SerializationHelper.Serialize(this);\r\n    }\r\n\r\n    /**\r\n     * Parses the image processing from a json representation.\r\n     * @param source the JSON source to parse\r\n     * @returns The parsed image processing\r\n     */\r\n    public static Parse(source: any): ImageProcessingConfiguration {\r\n        const parsed = SerializationHelper.Parse(() => new ImageProcessingConfiguration(), source, null, null);\r\n        // Backward compatibility\r\n        if (source.vignetteCentreX !== undefined) {\r\n            parsed.vignetteCenterX = source.vignetteCentreX;\r\n        }\r\n        if (source.vignetteCentreY !== undefined) {\r\n            parsed.vignetteCenterY = source.vignetteCentreY;\r\n        }\r\n\r\n        return parsed;\r\n    }\r\n\r\n    // Static constants associated to the image processing.\r\n    private static _VIGNETTEMODE_MULTIPLY = 0;\r\n    private static _VIGNETTEMODE_OPAQUE = 1;\r\n\r\n    /**\r\n     * Used to apply the vignette as a mix with the pixel color.\r\n     */\r\n    public static get VIGNETTEMODE_MULTIPLY(): number {\r\n        return this._VIGNETTEMODE_MULTIPLY;\r\n    }\r\n\r\n    /**\r\n     * Used to apply the vignette as a replacement of the pixel color.\r\n     */\r\n    public static get VIGNETTEMODE_OPAQUE(): number {\r\n        return this._VIGNETTEMODE_OPAQUE;\r\n    }\r\n}\r\n\r\n// References the dependencies.\r\nSerializationHelper._ImageProcessingConfigurationParser = ImageProcessingConfiguration.Parse;\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}
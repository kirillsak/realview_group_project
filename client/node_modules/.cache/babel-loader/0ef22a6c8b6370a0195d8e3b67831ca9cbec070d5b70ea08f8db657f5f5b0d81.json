{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { Logger } from \"../../Misc/logger.js\";\nimport { ArrayTools } from \"../../Misc/arrayTools.js\";\nimport { Vector3, Quaternion } from \"../../Maths/math.vector.js\";\nimport { AbstractMesh } from \"../../Meshes/abstractMesh.js\";\nimport { Mesh } from \"../../Meshes/mesh.js\";\nimport { PhysicsJoint } from \"./physicsJoint.js\";\nimport { Space } from \"../../Maths/math.axis.js\";\nMesh._PhysicsImpostorParser = function (scene, physicObject, jsonObject) {\n  return new PhysicsImpostor(physicObject, jsonObject.physicsImpostor, {\n    mass: jsonObject.physicsMass,\n    friction: jsonObject.physicsFriction,\n    restitution: jsonObject.physicsRestitution\n  }, scene);\n};\n/**\n * Represents a physics imposter\n * @see https://doc.babylonjs.com/features/featuresDeepDive/physics/usingPhysicsEngine\n */\nexport class PhysicsImpostor {\n  /**\n   * Initializes the physics imposter\n   * @param object The physics-enabled object used as the physics imposter\n   * @param type The type of the physics imposter. Types are available as static members of this class.\n   * @param _options The options for the physics imposter\n   * @param _scene The Babylon scene\n   */\n  constructor(\n  /**\n   * The physics-enabled object used as the physics imposter\n   */\n  object,\n  /**\n   * The type of the physics imposter\n   */\n  type, _options = {\n    mass: 0\n  }, _scene) {\n    this.object = object;\n    this.type = type;\n    this._options = _options;\n    this._scene = _scene;\n    /** @internal */\n    this._pluginData = {};\n    this._bodyUpdateRequired = false;\n    this._onBeforePhysicsStepCallbacks = new Array();\n    this._onAfterPhysicsStepCallbacks = new Array();\n    /** @internal */\n    this._onPhysicsCollideCallbacks = [];\n    this._deltaPosition = Vector3.Zero();\n    this._isDisposed = false;\n    /**\n     * @internal\n     */\n    this.soft = false;\n    /**\n     * @internal\n     */\n    this.segments = 0;\n    //temp variables for parent rotation calculations\n    //private _mats: Array<Matrix> = [new Matrix(), new Matrix()];\n    this._tmpQuat = new Quaternion();\n    this._tmpQuat2 = new Quaternion();\n    /**\n     * this function is executed by the physics engine.\n     */\n    this.beforeStep = () => {\n      if (!this._physicsEngine) {\n        return;\n      }\n      this.object.translate(this._deltaPosition, -1);\n      this._deltaRotationConjugated && this.object.rotationQuaternion && this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated, this.object.rotationQuaternion);\n      this.object.computeWorldMatrix(false);\n      if (this.object.parent && this.object.rotationQuaternion) {\n        this.getParentsRotation();\n        this._tmpQuat.multiplyToRef(this.object.rotationQuaternion, this._tmpQuat);\n      } else {\n        this._tmpQuat.copyFrom(this.object.rotationQuaternion || new Quaternion());\n      }\n      if (!this._options.disableBidirectionalTransformation) {\n        this.object.rotationQuaternion && this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this, /*bInfo.boundingBox.centerWorld*/this.object.getAbsolutePosition(), this._tmpQuat);\n      }\n      this._onBeforePhysicsStepCallbacks.forEach(func => {\n        func(this);\n      });\n    };\n    /**\n     * this function is executed by the physics engine\n     */\n    this.afterStep = () => {\n      if (!this._physicsEngine) {\n        return;\n      }\n      this._onAfterPhysicsStepCallbacks.forEach(func => {\n        func(this);\n      });\n      this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this);\n      // object has now its world rotation. needs to be converted to local.\n      if (this.object.parent && this.object.rotationQuaternion) {\n        this.getParentsRotation();\n        this._tmpQuat.conjugateInPlace();\n        this._tmpQuat.multiplyToRef(this.object.rotationQuaternion, this.object.rotationQuaternion);\n      }\n      // take the position set and make it the absolute position of this object.\n      this.object.setAbsolutePosition(this.object.position);\n      if (this._deltaRotation) {\n        this.object.rotationQuaternion && this.object.rotationQuaternion.multiplyToRef(this._deltaRotation, this.object.rotationQuaternion);\n        this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation, PhysicsImpostor._TmpVecs[0]);\n        this.object.translate(PhysicsImpostor._TmpVecs[0], 1);\n      } else {\n        this.object.translate(this._deltaPosition, 1);\n      }\n      this.object.computeWorldMatrix(true);\n    };\n    /**\n     * Legacy collision detection event support\n     */\n    this.onCollideEvent = null;\n    /**\n     *\n     * @param e\n     * @returns\n     */\n    this.onCollide = e => {\n      if (!this._onPhysicsCollideCallbacks.length && !this.onCollideEvent) {\n        return;\n      }\n      if (!this._physicsEngine) {\n        return;\n      }\n      const otherImpostor = this._physicsEngine.getImpostorWithPhysicsBody(e.body);\n      if (otherImpostor) {\n        // Legacy collision detection event support\n        if (this.onCollideEvent) {\n          this.onCollideEvent(this, otherImpostor);\n        }\n        this._onPhysicsCollideCallbacks.filter(obj => {\n          return obj.otherImpostors.indexOf(otherImpostor) !== -1;\n        }).forEach(obj => {\n          obj.callback(this, otherImpostor, e.point, e.distance, e.impulse, e.normal);\n        });\n      }\n    };\n    //sanity check!\n    if (!this.object) {\n      Logger.Error(\"No object was provided. A physics object is obligatory\");\n      return;\n    }\n    if (this.object.parent && _options.mass !== 0) {\n      Logger.Warn(\"A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur.\");\n    }\n    // Legacy support for old syntax.\n    if (!this._scene && object.getScene) {\n      this._scene = object.getScene();\n    }\n    if (!this._scene) {\n      return;\n    }\n    if (this.type > 100) {\n      this.soft = true;\n    }\n    this._physicsEngine = this._scene.getPhysicsEngine();\n    if (!this._physicsEngine) {\n      Logger.Error(\"Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.\");\n    } else {\n      //set the object's quaternion, if not set\n      if (!this.object.rotationQuaternion) {\n        if (this.object.rotation) {\n          this.object.rotationQuaternion = Quaternion.RotationYawPitchRoll(this.object.rotation.y, this.object.rotation.x, this.object.rotation.z);\n        } else {\n          this.object.rotationQuaternion = new Quaternion();\n        }\n      }\n      //default options params\n      this._options.mass = _options.mass === void 0 ? 0 : _options.mass;\n      this._options.friction = _options.friction === void 0 ? 0.2 : _options.friction;\n      this._options.restitution = _options.restitution === void 0 ? 0.2 : _options.restitution;\n      if (this.soft) {\n        //softbody mass must be above 0;\n        this._options.mass = this._options.mass > 0 ? this._options.mass : 1;\n        this._options.pressure = _options.pressure === void 0 ? 200 : _options.pressure;\n        this._options.stiffness = _options.stiffness === void 0 ? 1 : _options.stiffness;\n        this._options.velocityIterations = _options.velocityIterations === void 0 ? 20 : _options.velocityIterations;\n        this._options.positionIterations = _options.positionIterations === void 0 ? 20 : _options.positionIterations;\n        this._options.fixedPoints = _options.fixedPoints === void 0 ? 0 : _options.fixedPoints;\n        this._options.margin = _options.margin === void 0 ? 0 : _options.margin;\n        this._options.damping = _options.damping === void 0 ? 0 : _options.damping;\n        this._options.path = _options.path === void 0 ? null : _options.path;\n        this._options.shape = _options.shape === void 0 ? null : _options.shape;\n      }\n      this._joints = [];\n      //If the mesh has a parent, don't initialize the physicsBody. Instead wait for the parent to do that.\n      if (!this.object.parent || this._options.ignoreParent) {\n        this._init();\n      } else if (this.object.parent.physicsImpostor) {\n        Logger.Warn(\"You must affect impostors to children before affecting impostor to parent.\");\n      }\n    }\n  }\n  /**\n   * Specifies if the physics imposter is disposed\n   */\n  get isDisposed() {\n    return this._isDisposed;\n  }\n  /**\n   * Gets the mass of the physics imposter\n   */\n  get mass() {\n    return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getBodyMass(this) : 0;\n  }\n  set mass(value) {\n    this.setMass(value);\n  }\n  /**\n   * Gets the coefficient of friction\n   */\n  get friction() {\n    return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getBodyFriction(this) : 0;\n  }\n  /**\n   * Sets the coefficient of friction\n   */\n  set friction(value) {\n    if (!this._physicsEngine) {\n      return;\n    }\n    this._physicsEngine.getPhysicsPlugin().setBodyFriction(this, value);\n  }\n  /**\n   * Gets the coefficient of restitution\n   */\n  get restitution() {\n    return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this) : 0;\n  }\n  /**\n   * Sets the coefficient of restitution\n   */\n  set restitution(value) {\n    if (!this._physicsEngine) {\n      return;\n    }\n    this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this, value);\n  }\n  /**\n   * Gets the pressure of a soft body; only supported by the AmmoJSPlugin\n   */\n  get pressure() {\n    if (!this._physicsEngine) {\n      return 0;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.setBodyPressure) {\n      return 0;\n    }\n    return plugin.getBodyPressure(this);\n  }\n  /**\n   * Sets the pressure of a soft body; only supported by the AmmoJSPlugin\n   */\n  set pressure(value) {\n    if (!this._physicsEngine) {\n      return;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.setBodyPressure) {\n      return;\n    }\n    plugin.setBodyPressure(this, value);\n  }\n  /**\n   * Gets the stiffness of a soft body; only supported by the AmmoJSPlugin\n   */\n  get stiffness() {\n    if (!this._physicsEngine) {\n      return 0;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.getBodyStiffness) {\n      return 0;\n    }\n    return plugin.getBodyStiffness(this);\n  }\n  /**\n   * Sets the stiffness of a soft body; only supported by the AmmoJSPlugin\n   */\n  set stiffness(value) {\n    if (!this._physicsEngine) {\n      return;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.setBodyStiffness) {\n      return;\n    }\n    plugin.setBodyStiffness(this, value);\n  }\n  /**\n   * Gets the velocityIterations of a soft body; only supported by the AmmoJSPlugin\n   */\n  get velocityIterations() {\n    if (!this._physicsEngine) {\n      return 0;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.getBodyVelocityIterations) {\n      return 0;\n    }\n    return plugin.getBodyVelocityIterations(this);\n  }\n  /**\n   * Sets the velocityIterations of a soft body; only supported by the AmmoJSPlugin\n   */\n  set velocityIterations(value) {\n    if (!this._physicsEngine) {\n      return;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.setBodyVelocityIterations) {\n      return;\n    }\n    plugin.setBodyVelocityIterations(this, value);\n  }\n  /**\n   * Gets the positionIterations of a soft body; only supported by the AmmoJSPlugin\n   */\n  get positionIterations() {\n    if (!this._physicsEngine) {\n      return 0;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.getBodyPositionIterations) {\n      return 0;\n    }\n    return plugin.getBodyPositionIterations(this);\n  }\n  /**\n   * Sets the positionIterations of a soft body; only supported by the AmmoJSPlugin\n   */\n  set positionIterations(value) {\n    if (!this._physicsEngine) {\n      return;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.setBodyPositionIterations) {\n      return;\n    }\n    plugin.setBodyPositionIterations(this, value);\n  }\n  /**\n   * This function will completely initialize this impostor.\n   * It will create a new body - but only if this mesh has no parent.\n   * If it has, this impostor will not be used other than to define the impostor\n   * of the child mesh.\n   * @internal\n   */\n  _init() {\n    if (!this._physicsEngine) {\n      return;\n    }\n    this._physicsEngine.removeImpostor(this);\n    this.physicsBody = null;\n    this._parent = this._parent || this._getPhysicsParent();\n    if (!this._isDisposed && (!this.parent || this._options.ignoreParent)) {\n      this._physicsEngine.addImpostor(this);\n    }\n  }\n  _getPhysicsParent() {\n    if (this.object.parent instanceof AbstractMesh) {\n      const parentMesh = this.object.parent;\n      return parentMesh.physicsImpostor;\n    }\n    return null;\n  }\n  /**\n   * Should a new body be generated.\n   * @returns boolean specifying if body initialization is required\n   */\n  isBodyInitRequired() {\n    return this._bodyUpdateRequired || !this._physicsBody && (!this._parent || !!this._options.ignoreParent);\n  }\n  /**\n   * Sets the updated scaling\n   */\n  setScalingUpdated() {\n    this.forceUpdate();\n  }\n  /**\n   * Force a regeneration of this or the parent's impostor's body.\n   * Use with caution - This will remove all previously-instantiated joints.\n   */\n  forceUpdate() {\n    this._init();\n    if (this.parent && !this._options.ignoreParent) {\n      this.parent.forceUpdate();\n    }\n  }\n  /*public get mesh(): AbstractMesh {\n      return this._mesh;\n  }*/\n  /**\n   * Gets the body that holds this impostor. Either its own, or its parent.\n   */\n  get physicsBody() {\n    return this._parent && !this._options.ignoreParent ? this._parent.physicsBody : this._physicsBody;\n  }\n  /**\n   * Get the parent of the physics imposter\n   * @returns Physics imposter or null\n   */\n  get parent() {\n    return !this._options.ignoreParent && this._parent ? this._parent : null;\n  }\n  /**\n   * Sets the parent of the physics imposter\n   */\n  set parent(value) {\n    this._parent = value;\n  }\n  /**\n   * Set the physics body. Used mainly by the physics engine/plugin\n   */\n  set physicsBody(physicsBody) {\n    if (this._physicsBody && this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this);\n    }\n    this._physicsBody = physicsBody;\n    this.resetUpdateFlags();\n  }\n  /**\n   * Resets the update flags\n   */\n  resetUpdateFlags() {\n    this._bodyUpdateRequired = false;\n  }\n  /**\n   * Gets the object extents\n   * @returns the object extents\n   */\n  getObjectExtents() {\n    if (this.object.getBoundingInfo) {\n      const q = this.object.rotationQuaternion;\n      const scaling = this.object.scaling.clone();\n      //reset rotation\n      this.object.rotationQuaternion = PhysicsImpostor.IDENTITY_QUATERNION;\n      //calculate the world matrix with no rotation\n      const worldMatrix = this.object.computeWorldMatrix && this.object.computeWorldMatrix(true);\n      if (worldMatrix) {\n        worldMatrix.decompose(scaling, undefined, undefined);\n      }\n      const boundingInfo = this.object.getBoundingInfo();\n      // get the global scaling of the object\n      const size = boundingInfo.boundingBox.extendSize.scale(2).multiplyInPlace(scaling);\n      size.x = Math.abs(size.x);\n      size.y = Math.abs(size.y);\n      size.z = Math.abs(size.z);\n      //bring back the rotation\n      this.object.rotationQuaternion = q;\n      //calculate the world matrix with the new rotation\n      this.object.computeWorldMatrix && this.object.computeWorldMatrix(true);\n      return size;\n    } else {\n      return PhysicsImpostor.DEFAULT_OBJECT_SIZE;\n    }\n  }\n  /**\n   * Gets the object center\n   * @returns The object center\n   */\n  getObjectCenter() {\n    if (this.object.getBoundingInfo) {\n      const boundingInfo = this.object.getBoundingInfo();\n      return boundingInfo.boundingBox.centerWorld;\n    } else {\n      return this.object.position;\n    }\n  }\n  /**\n   * Get a specific parameter from the options parameters\n   * @param paramName The object parameter name\n   * @returns The object parameter\n   */\n  getParam(paramName) {\n    return this._options[paramName];\n  }\n  /**\n   * Sets a specific parameter in the options given to the physics plugin\n   * @param paramName The parameter name\n   * @param value The value of the parameter\n   */\n  setParam(paramName, value) {\n    this._options[paramName] = value;\n    this._bodyUpdateRequired = true;\n  }\n  /**\n   * Specifically change the body's mass. Won't recreate the physics body object\n   * @param mass The mass of the physics imposter\n   */\n  setMass(mass) {\n    if (this.getParam(\"mass\") !== mass) {\n      this.setParam(\"mass\", mass);\n    }\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().setBodyMass(this, mass);\n    }\n  }\n  /**\n   * Gets the linear velocity\n   * @returns  linear velocity or null\n   */\n  getLinearVelocity() {\n    return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this) : Vector3.Zero();\n  }\n  /**\n   * Sets the linear velocity\n   * @param velocity  linear velocity or null\n   */\n  setLinearVelocity(velocity) {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this, velocity);\n    }\n  }\n  /**\n   * Gets the angular velocity\n   * @returns angular velocity or null\n   */\n  getAngularVelocity() {\n    return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this) : Vector3.Zero();\n  }\n  /**\n   * Sets the angular velocity\n   * @param velocity The velocity or null\n   */\n  setAngularVelocity(velocity) {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this, velocity);\n    }\n  }\n  /**\n   * Execute a function with the physics plugin native code\n   * Provide a function the will have two variables - the world object and the physics body object\n   * @param func The function to execute with the physics plugin native code\n   */\n  executeNativeFunction(func) {\n    if (this._physicsEngine) {\n      func(this._physicsEngine.getPhysicsPlugin().world, this.physicsBody);\n    }\n  }\n  /**\n   * Register a function that will be executed before the physics world is stepping forward\n   * @param func The function to execute before the physics world is stepped forward\n   */\n  registerBeforePhysicsStep(func) {\n    this._onBeforePhysicsStepCallbacks.push(func);\n  }\n  /**\n   * Unregister a function that will be executed before the physics world is stepping forward\n   * @param func The function to execute before the physics world is stepped forward\n   */\n  unregisterBeforePhysicsStep(func) {\n    const index = this._onBeforePhysicsStepCallbacks.indexOf(func);\n    if (index > -1) {\n      this._onBeforePhysicsStepCallbacks.splice(index, 1);\n    } else {\n      Logger.Warn(\"Function to remove was not found\");\n    }\n  }\n  /**\n   * Register a function that will be executed after the physics step\n   * @param func The function to execute after physics step\n   */\n  registerAfterPhysicsStep(func) {\n    this._onAfterPhysicsStepCallbacks.push(func);\n  }\n  /**\n   * Unregisters a function that will be executed after the physics step\n   * @param func The function to execute after physics step\n   */\n  unregisterAfterPhysicsStep(func) {\n    const index = this._onAfterPhysicsStepCallbacks.indexOf(func);\n    if (index > -1) {\n      this._onAfterPhysicsStepCallbacks.splice(index, 1);\n    } else {\n      Logger.Warn(\"Function to remove was not found\");\n    }\n  }\n  /**\n   * register a function that will be executed when this impostor collides against a different body\n   * @param collideAgainst Physics imposter, or array of physics imposters to collide against\n   * @param func Callback that is executed on collision\n   */\n  registerOnPhysicsCollide(collideAgainst, func) {\n    const collidedAgainstList = collideAgainst instanceof Array ? collideAgainst : [collideAgainst];\n    this._onPhysicsCollideCallbacks.push({\n      callback: func,\n      otherImpostors: collidedAgainstList\n    });\n  }\n  /**\n   * Unregisters the physics imposter's collision callback\n   * @param collideAgainst The physics object to collide against\n   * @param func Callback to execute on collision\n   */\n  unregisterOnPhysicsCollide(collideAgainst, func) {\n    const collidedAgainstList = collideAgainst instanceof Array ? collideAgainst : [collideAgainst];\n    let index = -1;\n    const found = this._onPhysicsCollideCallbacks.some((cbDef, idx) => {\n      if (cbDef.callback === func && cbDef.otherImpostors.length === collidedAgainstList.length) {\n        // chcek the arrays match\n        const sameList = cbDef.otherImpostors.every(impostor => {\n          return collidedAgainstList.indexOf(impostor) > -1;\n        });\n        if (sameList) {\n          index = idx;\n        }\n        return sameList;\n      }\n      return false;\n    });\n    if (found) {\n      this._onPhysicsCollideCallbacks.splice(index, 1);\n    } else {\n      Logger.Warn(\"Function to remove was not found\");\n    }\n  }\n  /**\n   * Get the parent rotation\n   * @returns The parent rotation\n   */\n  getParentsRotation() {\n    let parent = this.object.parent;\n    this._tmpQuat.copyFromFloats(0, 0, 0, 1);\n    while (parent) {\n      if (parent.rotationQuaternion) {\n        this._tmpQuat2.copyFrom(parent.rotationQuaternion);\n      } else {\n        Quaternion.RotationYawPitchRollToRef(parent.rotation.y, parent.rotation.x, parent.rotation.z, this._tmpQuat2);\n      }\n      this._tmpQuat.multiplyToRef(this._tmpQuat2, this._tmpQuat);\n      parent = parent.parent;\n    }\n    return this._tmpQuat;\n  }\n  /**\n   * Apply a force\n   * @param force The force to apply\n   * @param contactPoint The contact point for the force\n   * @returns The physics imposter\n   */\n  applyForce(force, contactPoint) {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().applyForce(this, force, contactPoint);\n    }\n    return this;\n  }\n  /**\n   * Apply an impulse\n   * @param force The impulse force\n   * @param contactPoint The contact point for the impulse force\n   * @returns The physics imposter\n   */\n  applyImpulse(force, contactPoint) {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().applyImpulse(this, force, contactPoint);\n    }\n    return this;\n  }\n  /**\n   * A help function to create a joint\n   * @param otherImpostor A physics imposter used to create a joint\n   * @param jointType The type of joint\n   * @param jointData The data for the joint\n   * @returns The physics imposter\n   */\n  createJoint(otherImpostor, jointType, jointData) {\n    const joint = new PhysicsJoint(jointType, jointData);\n    this.addJoint(otherImpostor, joint);\n    return this;\n  }\n  /**\n   * Add a joint to this impostor with a different impostor\n   * @param otherImpostor A physics imposter used to add a joint\n   * @param joint The joint to add\n   * @returns The physics imposter\n   */\n  addJoint(otherImpostor, joint) {\n    this._joints.push({\n      otherImpostor: otherImpostor,\n      joint: joint\n    });\n    if (this._physicsEngine) {\n      this._physicsEngine.addJoint(this, otherImpostor, joint);\n    }\n    return this;\n  }\n  /**\n   * Add an anchor to a cloth impostor\n   * @param otherImpostor rigid impostor to anchor to\n   * @param width ratio across width from 0 to 1\n   * @param height ratio up height from 0 to 1\n   * @param influence the elasticity between cloth impostor and anchor from 0, very stretchy to 1, little stretch\n   * @param noCollisionBetweenLinkedBodies when true collisions between cloth impostor and anchor are ignored; default false\n   * @returns impostor the soft imposter\n   */\n  addAnchor(otherImpostor, width, height, influence, noCollisionBetweenLinkedBodies) {\n    if (!this._physicsEngine) {\n      return this;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.appendAnchor) {\n      return this;\n    }\n    if (this._physicsEngine) {\n      plugin.appendAnchor(this, otherImpostor, width, height, influence, noCollisionBetweenLinkedBodies);\n    }\n    return this;\n  }\n  /**\n   * Add a hook to a rope impostor\n   * @param otherImpostor rigid impostor to anchor to\n   * @param length ratio across rope from 0 to 1\n   * @param influence the elasticity between rope impostor and anchor from 0, very stretchy to 1, little stretch\n   * @param noCollisionBetweenLinkedBodies when true collisions between soft impostor and anchor are ignored; default false\n   * @returns impostor the rope imposter\n   */\n  addHook(otherImpostor, length, influence, noCollisionBetweenLinkedBodies) {\n    if (!this._physicsEngine) {\n      return this;\n    }\n    const plugin = this._physicsEngine.getPhysicsPlugin();\n    if (!plugin.appendAnchor) {\n      return this;\n    }\n    if (this._physicsEngine) {\n      plugin.appendHook(this, otherImpostor, length, influence, noCollisionBetweenLinkedBodies);\n    }\n    return this;\n  }\n  /**\n   * Will keep this body still, in a sleep mode.\n   * @returns the physics imposter\n   */\n  sleep() {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().sleepBody(this);\n    }\n    return this;\n  }\n  /**\n   * Wake the body up.\n   * @returns The physics imposter\n   */\n  wakeUp() {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().wakeUpBody(this);\n    }\n    return this;\n  }\n  /**\n   * Clones the physics imposter\n   * @param newObject The physics imposter clones to this physics-enabled object\n   * @returns A nullable physics imposter\n   */\n  clone(newObject) {\n    if (!newObject) {\n      return null;\n    }\n    return new PhysicsImpostor(newObject, this.type, this._options, this._scene);\n  }\n  /**\n   * Disposes the physics imposter\n   */\n  dispose( /*disposeChildren: boolean = true*/\n  ) {\n    //no dispose if no physics engine is available.\n    if (!this._physicsEngine) {\n      return;\n    }\n    this._joints.forEach(j => {\n      if (this._physicsEngine) {\n        this._physicsEngine.removeJoint(this, j.otherImpostor, j.joint);\n      }\n    });\n    //dispose the physics body\n    this._physicsEngine.removeImpostor(this);\n    if (this.parent) {\n      this.parent.forceUpdate();\n    } else {\n      /*this._object.getChildMeshes().forEach(function(mesh) {\n          if (mesh.physicsImpostor) {\n              if (disposeChildren) {\n                  mesh.physicsImpostor.dispose();\n                  mesh.physicsImpostor = null;\n              }\n          }\n      })*/\n    }\n    this._isDisposed = true;\n  }\n  /**\n   * Sets the delta position\n   * @param position The delta position amount\n   */\n  setDeltaPosition(position) {\n    this._deltaPosition.copyFrom(position);\n  }\n  /**\n   * Sets the delta rotation\n   * @param rotation The delta rotation amount\n   */\n  setDeltaRotation(rotation) {\n    if (!this._deltaRotation) {\n      this._deltaRotation = new Quaternion();\n    }\n    this._deltaRotation.copyFrom(rotation);\n    this._deltaRotationConjugated = this._deltaRotation.conjugate();\n  }\n  /**\n   * Gets the box size of the physics imposter and stores the result in the input parameter\n   * @param result Stores the box size\n   * @returns The physics imposter\n   */\n  getBoxSizeToRef(result) {\n    if (this._physicsEngine) {\n      this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this, result);\n    }\n    return this;\n  }\n  /**\n   * Gets the radius of the physics imposter\n   * @returns Radius of the physics imposter\n   */\n  getRadius() {\n    return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getRadius(this) : 0;\n  }\n  /**\n   * Sync a bone with this impostor\n   * @param bone The bone to sync to the impostor.\n   * @param boneMesh The mesh that the bone is influencing.\n   * @param jointPivot The pivot of the joint / bone in local space.\n   * @param distToJoint Optional distance from the impostor to the joint.\n   * @param adjustRotation Optional quaternion for adjusting the local rotation of the bone.\n   */\n  syncBoneWithImpostor(bone, boneMesh, jointPivot, distToJoint, adjustRotation) {\n    const tempVec = PhysicsImpostor._TmpVecs[0];\n    const mesh = this.object;\n    if (mesh.rotationQuaternion) {\n      if (adjustRotation) {\n        const tempQuat = PhysicsImpostor._TmpQuat;\n        mesh.rotationQuaternion.multiplyToRef(adjustRotation, tempQuat);\n        bone.setRotationQuaternion(tempQuat, Space.WORLD, boneMesh);\n      } else {\n        bone.setRotationQuaternion(mesh.rotationQuaternion, Space.WORLD, boneMesh);\n      }\n    }\n    tempVec.x = 0;\n    tempVec.y = 0;\n    tempVec.z = 0;\n    if (jointPivot) {\n      tempVec.x = jointPivot.x;\n      tempVec.y = jointPivot.y;\n      tempVec.z = jointPivot.z;\n      bone.getDirectionToRef(tempVec, boneMesh, tempVec);\n      if (distToJoint === undefined || distToJoint === null) {\n        distToJoint = jointPivot.length();\n      }\n      tempVec.x *= distToJoint;\n      tempVec.y *= distToJoint;\n      tempVec.z *= distToJoint;\n    }\n    if (bone.getParent()) {\n      tempVec.addInPlace(mesh.getAbsolutePosition());\n      bone.setAbsolutePosition(tempVec, boneMesh);\n    } else {\n      boneMesh.setAbsolutePosition(mesh.getAbsolutePosition());\n      boneMesh.position.x -= tempVec.x;\n      boneMesh.position.y -= tempVec.y;\n      boneMesh.position.z -= tempVec.z;\n    }\n  }\n  /**\n   * Sync impostor to a bone\n   * @param bone The bone that the impostor will be synced to.\n   * @param boneMesh The mesh that the bone is influencing.\n   * @param jointPivot The pivot of the joint / bone in local space.\n   * @param distToJoint Optional distance from the impostor to the joint.\n   * @param adjustRotation Optional quaternion for adjusting the local rotation of the bone.\n   * @param boneAxis Optional vector3 axis the bone is aligned with\n   */\n  syncImpostorWithBone(bone, boneMesh, jointPivot, distToJoint, adjustRotation, boneAxis) {\n    const mesh = this.object;\n    if (mesh.rotationQuaternion) {\n      if (adjustRotation) {\n        const tempQuat = PhysicsImpostor._TmpQuat;\n        bone.getRotationQuaternionToRef(Space.WORLD, boneMesh, tempQuat);\n        tempQuat.multiplyToRef(adjustRotation, mesh.rotationQuaternion);\n      } else {\n        bone.getRotationQuaternionToRef(Space.WORLD, boneMesh, mesh.rotationQuaternion);\n      }\n    }\n    const pos = PhysicsImpostor._TmpVecs[0];\n    const boneDir = PhysicsImpostor._TmpVecs[1];\n    if (!boneAxis) {\n      boneAxis = PhysicsImpostor._TmpVecs[2];\n      boneAxis.x = 0;\n      boneAxis.y = 1;\n      boneAxis.z = 0;\n    }\n    bone.getDirectionToRef(boneAxis, boneMesh, boneDir);\n    bone.getAbsolutePositionToRef(boneMesh, pos);\n    if ((distToJoint === undefined || distToJoint === null) && jointPivot) {\n      distToJoint = jointPivot.length();\n    }\n    if (distToJoint !== undefined && distToJoint !== null) {\n      pos.x += boneDir.x * distToJoint;\n      pos.y += boneDir.y * distToJoint;\n      pos.z += boneDir.z * distToJoint;\n    }\n    mesh.setAbsolutePosition(pos);\n  }\n}\n/**\n * The default object size of the imposter\n */\nPhysicsImpostor.DEFAULT_OBJECT_SIZE = new Vector3(1, 1, 1);\n/**\n * The identity quaternion of the imposter\n */\nPhysicsImpostor.IDENTITY_QUATERNION = Quaternion.Identity();\nPhysicsImpostor._TmpVecs = ArrayTools.BuildArray(3, Vector3.Zero);\nPhysicsImpostor._TmpQuat = Quaternion.Identity();\n//Impostor types\n/**\n * No-Imposter type\n */\nPhysicsImpostor.NoImpostor = 0;\n/**\n * Sphere-Imposter type\n */\nPhysicsImpostor.SphereImpostor = 1;\n/**\n * Box-Imposter type\n */\nPhysicsImpostor.BoxImpostor = 2;\n/**\n * Plane-Imposter type\n */\nPhysicsImpostor.PlaneImpostor = 3;\n/**\n * Mesh-imposter type (Only available to objects with vertices data)\n */\nPhysicsImpostor.MeshImpostor = 4;\n/**\n * Capsule-Impostor type (Ammo.js plugin only)\n */\nPhysicsImpostor.CapsuleImpostor = 6;\n/**\n * Cylinder-Imposter type\n */\nPhysicsImpostor.CylinderImpostor = 7;\n/**\n * Particle-Imposter type\n */\nPhysicsImpostor.ParticleImpostor = 8;\n/**\n * Heightmap-Imposter type\n */\nPhysicsImpostor.HeightmapImpostor = 9;\n/**\n * ConvexHull-Impostor type (Ammo.js plugin only)\n */\nPhysicsImpostor.ConvexHullImpostor = 10;\n/**\n * Custom-Imposter type (Ammo.js plugin only)\n */\nPhysicsImpostor.CustomImpostor = 100;\n/**\n * Rope-Imposter type\n */\nPhysicsImpostor.RopeImpostor = 101;\n/**\n * Cloth-Imposter type\n */\nPhysicsImpostor.ClothImpostor = 102;\n/**\n * Softbody-Imposter type\n */\nPhysicsImpostor.SoftbodyImpostor = 103;","map":{"version":3,"mappings":"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","names":["Logger","ArrayTools","Vector3","Quaternion","AbstractMesh","Mesh","PhysicsJoint","Space","_PhysicsImpostorParser","scene","physicObject","jsonObject","PhysicsImpostor","physicsImpostor","mass","physicsMass","friction","physicsFriction","restitution","physicsRestitution","constructor","object","type","_options","_scene","Array","Zero","_physicsEngine","translate","_deltaPosition","_deltaRotationConjugated","rotationQuaternion","multiplyToRef","computeWorldMatrix","parent","getParentsRotation","_tmpQuat","copyFrom","disableBidirectionalTransformation","getPhysicsPlugin","setPhysicsBodyTransformation","getAbsolutePosition","_onBeforePhysicsStepCallbacks","forEach","func","_onAfterPhysicsStepCallbacks","setTransformationFromPhysicsBody","conjugateInPlace","setAbsolutePosition","position","_deltaRotation","applyRotationQuaternionToRef","_TmpVecs","e","_onPhysicsCollideCallbacks","length","onCollideEvent","otherImpostor","getImpostorWithPhysicsBody","body","filter","obj","otherImpostors","indexOf","callback","point","distance","impulse","normal","Error","Warn","getScene","soft","getPhysicsEngine","rotation","RotationYawPitchRoll","y","x","z","pressure","stiffness","velocityIterations","positionIterations","fixedPoints","margin","damping","path","shape","_joints","ignoreParent","_init","isDisposed","_isDisposed","getBodyMass","value","setMass","getBodyFriction","setBodyFriction","getBodyRestitution","setBodyRestitution","plugin","setBodyPressure","getBodyPressure","getBodyStiffness","setBodyStiffness","getBodyVelocityIterations","setBodyVelocityIterations","getBodyPositionIterations","setBodyPositionIterations","removeImpostor","physicsBody","_parent","_getPhysicsParent","addImpostor","parentMesh","isBodyInitRequired","_bodyUpdateRequired","_physicsBody","setScalingUpdated","forceUpdate","removePhysicsBody","resetUpdateFlags","getObjectExtents","getBoundingInfo","q","scaling","clone","IDENTITY_QUATERNION","worldMatrix","decompose","undefined","boundingInfo","size","boundingBox","extendSize","scale","multiplyInPlace","Math","abs","DEFAULT_OBJECT_SIZE","getObjectCenter","centerWorld","getParam","paramName","setParam","setBodyMass","getLinearVelocity","setLinearVelocity","velocity","getAngularVelocity","setAngularVelocity","executeNativeFunction","world","registerBeforePhysicsStep","push","unregisterBeforePhysicsStep","index","splice","registerAfterPhysicsStep","unregisterAfterPhysicsStep","registerOnPhysicsCollide","collideAgainst","collidedAgainstList","unregisterOnPhysicsCollide","found","some","cbDef","idx","sameList","every","impostor","copyFromFloats","_tmpQuat2","RotationYawPitchRollToRef","applyForce","force","contactPoint","applyImpulse","createJoint","jointType","jointData","joint","addJoint","addAnchor","width","height","influence","noCollisionBetweenLinkedBodies","appendAnchor","addHook","appendHook","sleep","sleepBody","wakeUp","wakeUpBody","newObject","dispose","j","removeJoint","setDeltaPosition","setDeltaRotation","conjugate","getBoxSizeToRef","result","getRadius","syncBoneWithImpostor","bone","boneMesh","jointPivot","distToJoint","adjustRotation","tempVec","mesh","tempQuat","_TmpQuat","setRotationQuaternion","WORLD","getDirectionToRef","getParent","addInPlace","syncImpostorWithBone","boneAxis","getRotationQuaternionToRef","pos","boneDir","getAbsolutePositionToRef","Identity","BuildArray"],"sourceRoot":"","sources":["../../../../../lts/core/generated/Physics/v1/physicsImpostor.ts"],"sourcesContent":["import type { Nullable, IndicesArray } from \"../../types\";\r\nimport { Logger } from \"../../Misc/logger\";\r\nimport { ArrayTools } from \"../../Misc/arrayTools\";\r\nimport type { Matrix } from \"../../Maths/math.vector\";\r\nimport { Vector3, Quaternion } from \"../../Maths/math.vector\";\r\nimport type { TransformNode } from \"../../Meshes/transformNode\";\r\nimport { AbstractMesh } from \"../../Meshes/abstractMesh\";\r\nimport { Mesh } from \"../../Meshes/mesh\";\r\nimport type { Scene } from \"../../scene\";\r\nimport type { Bone } from \"../../Bones/bone\";\r\nimport type { BoundingInfo } from \"../../Culling/boundingInfo\";\r\nimport type { PhysicsEngine as PhysicsEngineV1 } from \"./physicsEngine\";\r\n\r\nimport type { PhysicsJointData } from \"./physicsJoint\";\r\nimport { PhysicsJoint } from \"./physicsJoint\";\r\nimport { Space } from \"../../Maths/math.axis\";\r\n\r\n/**\r\n * The interface for the physics imposter parameters\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/physics/usingPhysicsEngine\r\n */\r\nexport interface PhysicsImpostorParameters {\r\n    /**\r\n     * The mass of the physics imposter\r\n     */\r\n    mass: number;\r\n    /**\r\n     * The friction of the physics imposter\r\n     */\r\n    friction?: number;\r\n    /**\r\n     * The coefficient of restitution of the physics imposter\r\n     */\r\n    restitution?: number;\r\n    /**\r\n     * The native options of the physics imposter\r\n     */\r\n    nativeOptions?: any;\r\n    /**\r\n     * Specifies if the parent should be ignored\r\n     */\r\n    ignoreParent?: boolean;\r\n    /**\r\n     * Specifies if bi-directional transformations should be disabled\r\n     */\r\n    disableBidirectionalTransformation?: boolean;\r\n    /**\r\n     * The pressure inside the physics imposter, soft object only\r\n     */\r\n    pressure?: number;\r\n    /**\r\n     * The stiffness the physics imposter, soft object only\r\n     */\r\n    stiffness?: number;\r\n    /**\r\n     * The number of iterations used in maintaining consistent vertex velocities, soft object only\r\n     */\r\n    velocityIterations?: number;\r\n    /**\r\n     * The number of iterations used in maintaining consistent vertex positions, soft object only\r\n     */\r\n    positionIterations?: number;\r\n    /**\r\n     * The number used to fix points on a cloth (0, 1, 2, 4, 8) or rope (0, 1, 2) only\r\n     * 0 None, 1, back left or top, 2, back right or bottom, 4, front left, 8, front right\r\n     * Add to fix multiple points\r\n     */\r\n    fixedPoints?: number;\r\n    /**\r\n     * The collision margin around a soft object\r\n     */\r\n    margin?: number;\r\n    /**\r\n     * The collision margin around a soft object\r\n     */\r\n    damping?: number;\r\n    /**\r\n     * The path for a rope based on an extrusion\r\n     */\r\n    path?: any;\r\n    /**\r\n     * The shape of an extrusion used for a rope based on an extrusion\r\n     */\r\n    shape?: any;\r\n}\r\n\r\n/**\r\n * Interface for a physics-enabled object\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/physics/usingPhysicsEngine\r\n */\r\nexport interface IPhysicsEnabledObject {\r\n    /**\r\n     * The position of the physics-enabled object\r\n     */\r\n    position: Vector3;\r\n    /**\r\n     * The rotation of the physics-enabled object\r\n     */\r\n    rotationQuaternion: Nullable<Quaternion>;\r\n    /**\r\n     * The scale of the physics-enabled object\r\n     */\r\n    scaling: Vector3;\r\n    /**\r\n     * The rotation of the physics-enabled object\r\n     */\r\n    rotation?: Vector3;\r\n    /**\r\n     * The parent of the physics-enabled object\r\n     */\r\n    parent?: any;\r\n    /**\r\n     * The bounding info of the physics-enabled object\r\n     * @returns The bounding info of the physics-enabled object\r\n     */\r\n    getBoundingInfo(): BoundingInfo;\r\n    /**\r\n     * Computes the world matrix\r\n     * @param force Specifies if the world matrix should be computed by force\r\n     * @returns A world matrix\r\n     */\r\n    computeWorldMatrix(force: boolean): Matrix;\r\n    /**\r\n     * Gets the world matrix\r\n     * @returns A world matrix\r\n     */\r\n    getWorldMatrix?(): Matrix;\r\n    /**\r\n     * Gets the child meshes\r\n     * @param directDescendantsOnly Specifies if only direct-descendants should be obtained\r\n     * @returns An array of abstract meshes\r\n     */\r\n    getChildMeshes?(directDescendantsOnly?: boolean): Array<AbstractMesh>;\r\n    /**\r\n     * Gets the vertex data\r\n     * @param kind The type of vertex data\r\n     * @returns A nullable array of numbers, or a float32 array\r\n     */\r\n    getVerticesData(kind: string): Nullable<Array<number> | Float32Array>;\r\n    /**\r\n     * Gets the indices from the mesh\r\n     * @returns A nullable array of index arrays\r\n     */\r\n    getIndices?(): Nullable<IndicesArray>;\r\n    /**\r\n     * Gets the scene from the mesh\r\n     * @returns the indices array or null\r\n     */\r\n    getScene?(): Scene;\r\n    /**\r\n     * Gets the absolute position from the mesh\r\n     * @returns the absolute position\r\n     */\r\n    getAbsolutePosition(): Vector3;\r\n    /**\r\n     * Gets the absolute pivot point from the mesh\r\n     * @returns the absolute pivot point\r\n     */\r\n    getAbsolutePivotPoint(): Vector3;\r\n    /**\r\n     * Rotates the mesh\r\n     * @param axis The axis of rotation\r\n     * @param amount The amount of rotation\r\n     * @param space The space of the rotation\r\n     * @returns The rotation transform node\r\n     */\r\n    rotate(axis: Vector3, amount: number, space?: Space): TransformNode;\r\n    /**\r\n     * Translates the mesh\r\n     * @param axis The axis of translation\r\n     * @param distance The distance of translation\r\n     * @param space The space of the translation\r\n     * @returns The transform node\r\n     */\r\n    translate(axis: Vector3, distance: number, space?: Space): TransformNode;\r\n    /**\r\n     * Sets the absolute position of the mesh\r\n     * @param absolutePosition The absolute position of the mesh\r\n     * @returns The transform node\r\n     */\r\n    setAbsolutePosition(absolutePosition: Vector3): TransformNode;\r\n    /**\r\n     * Gets the class name of the mesh\r\n     * @returns The class name\r\n     */\r\n    getClassName(): string;\r\n}\r\n\r\nMesh._PhysicsImpostorParser = function (scene: Scene, physicObject: IPhysicsEnabledObject, jsonObject: any): PhysicsImpostor {\r\n    return new PhysicsImpostor(\r\n        physicObject,\r\n        jsonObject.physicsImpostor,\r\n        {\r\n            mass: jsonObject.physicsMass,\r\n            friction: jsonObject.physicsFriction,\r\n            restitution: jsonObject.physicsRestitution,\r\n        },\r\n        scene\r\n    );\r\n};\r\n\r\n/**\r\n * Represents a physics imposter\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/physics/usingPhysicsEngine\r\n */\r\nexport class PhysicsImpostor {\r\n    /**\r\n     * The default object size of the imposter\r\n     */\r\n    public static DEFAULT_OBJECT_SIZE: Vector3 = new Vector3(1, 1, 1);\r\n\r\n    /**\r\n     * The identity quaternion of the imposter\r\n     */\r\n    public static IDENTITY_QUATERNION = Quaternion.Identity();\r\n\r\n    /** @internal */\r\n    public _pluginData: any = {};\r\n\r\n    private _physicsEngine: Nullable<PhysicsEngineV1>;\r\n    //The native cannon/oimo/energy physics body object.\r\n    private _physicsBody: any;\r\n    private _bodyUpdateRequired: boolean = false;\r\n\r\n    private _onBeforePhysicsStepCallbacks = new Array<(impostor: PhysicsImpostor) => void>();\r\n    private _onAfterPhysicsStepCallbacks = new Array<(impostor: PhysicsImpostor) => void>();\r\n    /** @internal */\r\n    public _onPhysicsCollideCallbacks: Array<{\r\n        callback: (collider: PhysicsImpostor, collidedAgainst: PhysicsImpostor, point: Nullable<Vector3>, distance: number, impulse: number, normal: Nullable<Vector3>) => void;\r\n        otherImpostors: Array<PhysicsImpostor>;\r\n    }> = [];\r\n\r\n    private _deltaPosition: Vector3 = Vector3.Zero();\r\n    private _deltaRotation: Quaternion;\r\n    private _deltaRotationConjugated: Quaternion;\r\n\r\n    /** @internal */\r\n    public _isFromLine: boolean;\r\n\r\n    //If set, this is this impostor's parent\r\n    private _parent: Nullable<PhysicsImpostor>;\r\n\r\n    private _isDisposed = false;\r\n\r\n    private static _TmpVecs: Vector3[] = ArrayTools.BuildArray(3, Vector3.Zero);\r\n    private static _TmpQuat: Quaternion = Quaternion.Identity();\r\n\r\n    /**\r\n     * Specifies if the physics imposter is disposed\r\n     */\r\n    get isDisposed(): boolean {\r\n        return this._isDisposed;\r\n    }\r\n\r\n    /**\r\n     * Gets the mass of the physics imposter\r\n     */\r\n    get mass(): number {\r\n        return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getBodyMass(this) : 0;\r\n    }\r\n\r\n    set mass(value: number) {\r\n        this.setMass(value);\r\n    }\r\n\r\n    /**\r\n     * Gets the coefficient of friction\r\n     */\r\n    get friction(): number {\r\n        return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getBodyFriction(this) : 0;\r\n    }\r\n\r\n    /**\r\n     * Sets the coefficient of friction\r\n     */\r\n    set friction(value: number) {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        this._physicsEngine.getPhysicsPlugin().setBodyFriction(this, value);\r\n    }\r\n\r\n    /**\r\n     * Gets the coefficient of restitution\r\n     */\r\n    get restitution(): number {\r\n        return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this) : 0;\r\n    }\r\n\r\n    /**\r\n     * Sets the coefficient of restitution\r\n     */\r\n    set restitution(value: number) {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this, value);\r\n    }\r\n\r\n    /**\r\n     * Gets the pressure of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    get pressure(): number {\r\n        if (!this._physicsEngine) {\r\n            return 0;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.setBodyPressure) {\r\n            return 0;\r\n        }\r\n        return plugin.getBodyPressure!(this);\r\n    }\r\n\r\n    /**\r\n     * Sets the pressure of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    set pressure(value: number) {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.setBodyPressure) {\r\n            return;\r\n        }\r\n        plugin.setBodyPressure!(this, value);\r\n    }\r\n\r\n    /**\r\n     * Gets the stiffness of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    get stiffness(): number {\r\n        if (!this._physicsEngine) {\r\n            return 0;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.getBodyStiffness) {\r\n            return 0;\r\n        }\r\n        return plugin.getBodyStiffness!(this);\r\n    }\r\n\r\n    /**\r\n     * Sets the stiffness of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    set stiffness(value: number) {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.setBodyStiffness) {\r\n            return;\r\n        }\r\n        plugin.setBodyStiffness!(this, value);\r\n    }\r\n\r\n    /**\r\n     * Gets the velocityIterations of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    get velocityIterations(): number {\r\n        if (!this._physicsEngine) {\r\n            return 0;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.getBodyVelocityIterations) {\r\n            return 0;\r\n        }\r\n        return plugin.getBodyVelocityIterations!(this);\r\n    }\r\n\r\n    /**\r\n     * Sets the velocityIterations of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    set velocityIterations(value: number) {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.setBodyVelocityIterations) {\r\n            return;\r\n        }\r\n        plugin.setBodyVelocityIterations!(this, value);\r\n    }\r\n\r\n    /**\r\n     * Gets the positionIterations of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    get positionIterations(): number {\r\n        if (!this._physicsEngine) {\r\n            return 0;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.getBodyPositionIterations) {\r\n            return 0;\r\n        }\r\n        return plugin.getBodyPositionIterations!(this);\r\n    }\r\n\r\n    /**\r\n     * Sets the positionIterations of a soft body; only supported by the AmmoJSPlugin\r\n     */\r\n    set positionIterations(value: number) {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.setBodyPositionIterations) {\r\n            return;\r\n        }\r\n        plugin.setBodyPositionIterations!(this, value);\r\n    }\r\n\r\n    /**\r\n     * The unique id of the physics imposter\r\n     * set by the physics engine when adding this impostor to the array\r\n     */\r\n    public uniqueId: number;\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public soft: boolean = false;\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public segments: number = 0;\r\n\r\n    private _joints: Array<{\r\n        joint: PhysicsJoint;\r\n        otherImpostor: PhysicsImpostor;\r\n    }>;\r\n\r\n    /**\r\n     * Initializes the physics imposter\r\n     * @param object The physics-enabled object used as the physics imposter\r\n     * @param type The type of the physics imposter. Types are available as static members of this class.\r\n     * @param _options The options for the physics imposter\r\n     * @param _scene The Babylon scene\r\n     */\r\n    constructor(\r\n        /**\r\n         * The physics-enabled object used as the physics imposter\r\n         */\r\n        public object: IPhysicsEnabledObject,\r\n        /**\r\n         * The type of the physics imposter\r\n         */\r\n        public type: number,\r\n        private _options: PhysicsImpostorParameters = { mass: 0 },\r\n        private _scene?: Scene\r\n    ) {\r\n        //sanity check!\r\n        if (!this.object) {\r\n            Logger.Error(\"No object was provided. A physics object is obligatory\");\r\n            return;\r\n        }\r\n        if (this.object.parent && _options.mass !== 0) {\r\n            Logger.Warn(\"A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur.\");\r\n        }\r\n\r\n        // Legacy support for old syntax.\r\n        if (!this._scene && object.getScene) {\r\n            this._scene = object.getScene();\r\n        }\r\n\r\n        if (!this._scene) {\r\n            return;\r\n        }\r\n\r\n        if (this.type > 100) {\r\n            this.soft = true;\r\n        }\r\n\r\n        this._physicsEngine = this._scene.getPhysicsEngine() as any;\r\n        if (!this._physicsEngine) {\r\n            Logger.Error(\"Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.\");\r\n        } else {\r\n            //set the object's quaternion, if not set\r\n            if (!this.object.rotationQuaternion) {\r\n                if (this.object.rotation) {\r\n                    this.object.rotationQuaternion = Quaternion.RotationYawPitchRoll(this.object.rotation.y, this.object.rotation.x, this.object.rotation.z);\r\n                } else {\r\n                    this.object.rotationQuaternion = new Quaternion();\r\n                }\r\n            }\r\n            //default options params\r\n            this._options.mass = _options.mass === void 0 ? 0 : _options.mass;\r\n            this._options.friction = _options.friction === void 0 ? 0.2 : _options.friction;\r\n            this._options.restitution = _options.restitution === void 0 ? 0.2 : _options.restitution;\r\n            if (this.soft) {\r\n                //softbody mass must be above 0;\r\n                this._options.mass = this._options.mass > 0 ? this._options.mass : 1;\r\n                this._options.pressure = _options.pressure === void 0 ? 200 : _options.pressure;\r\n                this._options.stiffness = _options.stiffness === void 0 ? 1 : _options.stiffness;\r\n                this._options.velocityIterations = _options.velocityIterations === void 0 ? 20 : _options.velocityIterations;\r\n                this._options.positionIterations = _options.positionIterations === void 0 ? 20 : _options.positionIterations;\r\n                this._options.fixedPoints = _options.fixedPoints === void 0 ? 0 : _options.fixedPoints;\r\n                this._options.margin = _options.margin === void 0 ? 0 : _options.margin;\r\n                this._options.damping = _options.damping === void 0 ? 0 : _options.damping;\r\n                this._options.path = _options.path === void 0 ? null : _options.path;\r\n                this._options.shape = _options.shape === void 0 ? null : _options.shape;\r\n            }\r\n            this._joints = [];\r\n            //If the mesh has a parent, don't initialize the physicsBody. Instead wait for the parent to do that.\r\n            if (!this.object.parent || this._options.ignoreParent) {\r\n                this._init();\r\n            } else if (this.object.parent.physicsImpostor) {\r\n                Logger.Warn(\"You must affect impostors to children before affecting impostor to parent.\");\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * This function will completely initialize this impostor.\r\n     * It will create a new body - but only if this mesh has no parent.\r\n     * If it has, this impostor will not be used other than to define the impostor\r\n     * of the child mesh.\r\n     * @internal\r\n     */\r\n    public _init() {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n\r\n        this._physicsEngine.removeImpostor(this);\r\n        this.physicsBody = null;\r\n        this._parent = this._parent || this._getPhysicsParent();\r\n        if (!this._isDisposed && (!this.parent || this._options.ignoreParent)) {\r\n            this._physicsEngine.addImpostor(this);\r\n        }\r\n    }\r\n\r\n    private _getPhysicsParent(): Nullable<PhysicsImpostor> {\r\n        if (this.object.parent instanceof AbstractMesh) {\r\n            const parentMesh: AbstractMesh = <AbstractMesh>this.object.parent;\r\n            return parentMesh.physicsImpostor;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Should a new body be generated.\r\n     * @returns boolean specifying if body initialization is required\r\n     */\r\n    public isBodyInitRequired(): boolean {\r\n        return this._bodyUpdateRequired || (!this._physicsBody && (!this._parent || !!this._options.ignoreParent));\r\n    }\r\n\r\n    /**\r\n     * Sets the updated scaling\r\n     */\r\n    public setScalingUpdated() {\r\n        this.forceUpdate();\r\n    }\r\n\r\n    /**\r\n     * Force a regeneration of this or the parent's impostor's body.\r\n     * Use with caution - This will remove all previously-instantiated joints.\r\n     */\r\n    public forceUpdate() {\r\n        this._init();\r\n        if (this.parent && !this._options.ignoreParent) {\r\n            this.parent.forceUpdate();\r\n        }\r\n    }\r\n\r\n    /*public get mesh(): AbstractMesh {\r\n        return this._mesh;\r\n    }*/\r\n\r\n    /**\r\n     * Gets the body that holds this impostor. Either its own, or its parent.\r\n     */\r\n    public get physicsBody(): any {\r\n        return this._parent && !this._options.ignoreParent ? this._parent.physicsBody : this._physicsBody;\r\n    }\r\n\r\n    /**\r\n     * Get the parent of the physics imposter\r\n     * @returns Physics imposter or null\r\n     */\r\n    public get parent(): Nullable<PhysicsImpostor> {\r\n        return !this._options.ignoreParent && this._parent ? this._parent : null;\r\n    }\r\n\r\n    /**\r\n     * Sets the parent of the physics imposter\r\n     */\r\n    public set parent(value: Nullable<PhysicsImpostor>) {\r\n        this._parent = value;\r\n    }\r\n\r\n    /**\r\n     * Set the physics body. Used mainly by the physics engine/plugin\r\n     */\r\n    public set physicsBody(physicsBody: any) {\r\n        if (this._physicsBody && this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this);\r\n        }\r\n        this._physicsBody = physicsBody;\r\n        this.resetUpdateFlags();\r\n    }\r\n\r\n    /**\r\n     * Resets the update flags\r\n     */\r\n    public resetUpdateFlags() {\r\n        this._bodyUpdateRequired = false;\r\n    }\r\n\r\n    /**\r\n     * Gets the object extents\r\n     * @returns the object extents\r\n     */\r\n    public getObjectExtents(): Vector3 {\r\n        if (this.object.getBoundingInfo) {\r\n            const q = this.object.rotationQuaternion;\r\n            const scaling = this.object.scaling.clone();\r\n            //reset rotation\r\n            this.object.rotationQuaternion = PhysicsImpostor.IDENTITY_QUATERNION;\r\n            //calculate the world matrix with no rotation\r\n            const worldMatrix = this.object.computeWorldMatrix && this.object.computeWorldMatrix(true);\r\n            if (worldMatrix) {\r\n                worldMatrix.decompose(scaling, undefined, undefined);\r\n            }\r\n            const boundingInfo = this.object.getBoundingInfo();\r\n            // get the global scaling of the object\r\n            const size = boundingInfo.boundingBox.extendSize.scale(2).multiplyInPlace(scaling);\r\n            size.x = Math.abs(size.x);\r\n            size.y = Math.abs(size.y);\r\n            size.z = Math.abs(size.z);\r\n            //bring back the rotation\r\n            this.object.rotationQuaternion = q;\r\n            //calculate the world matrix with the new rotation\r\n            this.object.computeWorldMatrix && this.object.computeWorldMatrix(true);\r\n            return size;\r\n        } else {\r\n            return PhysicsImpostor.DEFAULT_OBJECT_SIZE;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the object center\r\n     * @returns The object center\r\n     */\r\n    public getObjectCenter(): Vector3 {\r\n        if (this.object.getBoundingInfo) {\r\n            const boundingInfo = this.object.getBoundingInfo();\r\n            return boundingInfo.boundingBox.centerWorld;\r\n        } else {\r\n            return this.object.position;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get a specific parameter from the options parameters\r\n     * @param paramName The object parameter name\r\n     * @returns The object parameter\r\n     */\r\n    public getParam(paramName: string): any {\r\n        return (<any>this._options)[paramName];\r\n    }\r\n\r\n    /**\r\n     * Sets a specific parameter in the options given to the physics plugin\r\n     * @param paramName The parameter name\r\n     * @param value The value of the parameter\r\n     */\r\n    public setParam(paramName: string, value: number) {\r\n        (<any>this._options)[paramName] = value;\r\n        this._bodyUpdateRequired = true;\r\n    }\r\n\r\n    /**\r\n     * Specifically change the body's mass. Won't recreate the physics body object\r\n     * @param mass The mass of the physics imposter\r\n     */\r\n    public setMass(mass: number) {\r\n        if (this.getParam(\"mass\") !== mass) {\r\n            this.setParam(\"mass\", mass);\r\n        }\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().setBodyMass(this, mass);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the linear velocity\r\n     * @returns  linear velocity or null\r\n     */\r\n    public getLinearVelocity(): Nullable<Vector3> {\r\n        return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this) : Vector3.Zero();\r\n    }\r\n\r\n    /**\r\n     * Sets the linear velocity\r\n     * @param velocity  linear velocity or null\r\n     */\r\n    public setLinearVelocity(velocity: Nullable<Vector3>) {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this, velocity);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the angular velocity\r\n     * @returns angular velocity or null\r\n     */\r\n    public getAngularVelocity(): Nullable<Vector3> {\r\n        return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this) : Vector3.Zero();\r\n    }\r\n\r\n    /**\r\n     * Sets the angular velocity\r\n     * @param velocity The velocity or null\r\n     */\r\n    public setAngularVelocity(velocity: Nullable<Vector3>) {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this, velocity);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Execute a function with the physics plugin native code\r\n     * Provide a function the will have two variables - the world object and the physics body object\r\n     * @param func The function to execute with the physics plugin native code\r\n     */\r\n    public executeNativeFunction(func: (world: any, physicsBody: any) => void) {\r\n        if (this._physicsEngine) {\r\n            func(this._physicsEngine.getPhysicsPlugin().world, this.physicsBody);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Register a function that will be executed before the physics world is stepping forward\r\n     * @param func The function to execute before the physics world is stepped forward\r\n     */\r\n    public registerBeforePhysicsStep(func: (impostor: PhysicsImpostor) => void): void {\r\n        this._onBeforePhysicsStepCallbacks.push(func);\r\n    }\r\n\r\n    /**\r\n     * Unregister a function that will be executed before the physics world is stepping forward\r\n     * @param func The function to execute before the physics world is stepped forward\r\n     */\r\n    public unregisterBeforePhysicsStep(func: (impostor: PhysicsImpostor) => void): void {\r\n        const index = this._onBeforePhysicsStepCallbacks.indexOf(func);\r\n\r\n        if (index > -1) {\r\n            this._onBeforePhysicsStepCallbacks.splice(index, 1);\r\n        } else {\r\n            Logger.Warn(\"Function to remove was not found\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Register a function that will be executed after the physics step\r\n     * @param func The function to execute after physics step\r\n     */\r\n    public registerAfterPhysicsStep(func: (impostor: PhysicsImpostor) => void): void {\r\n        this._onAfterPhysicsStepCallbacks.push(func);\r\n    }\r\n\r\n    /**\r\n     * Unregisters a function that will be executed after the physics step\r\n     * @param func The function to execute after physics step\r\n     */\r\n    public unregisterAfterPhysicsStep(func: (impostor: PhysicsImpostor) => void): void {\r\n        const index = this._onAfterPhysicsStepCallbacks.indexOf(func);\r\n\r\n        if (index > -1) {\r\n            this._onAfterPhysicsStepCallbacks.splice(index, 1);\r\n        } else {\r\n            Logger.Warn(\"Function to remove was not found\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * register a function that will be executed when this impostor collides against a different body\r\n     * @param collideAgainst Physics imposter, or array of physics imposters to collide against\r\n     * @param func Callback that is executed on collision\r\n     */\r\n    public registerOnPhysicsCollide(\r\n        collideAgainst: PhysicsImpostor | Array<PhysicsImpostor>,\r\n        func: (collider: PhysicsImpostor, collidedAgainst: PhysicsImpostor, point: Nullable<Vector3>) => void\r\n    ): void {\r\n        const collidedAgainstList: Array<PhysicsImpostor> = collideAgainst instanceof Array ? <Array<PhysicsImpostor>>collideAgainst : [<PhysicsImpostor>collideAgainst];\r\n        this._onPhysicsCollideCallbacks.push({ callback: func, otherImpostors: collidedAgainstList });\r\n    }\r\n\r\n    /**\r\n     * Unregisters the physics imposter's collision callback\r\n     * @param collideAgainst The physics object to collide against\r\n     * @param func Callback to execute on collision\r\n     */\r\n    public unregisterOnPhysicsCollide(\r\n        collideAgainst: PhysicsImpostor | Array<PhysicsImpostor>,\r\n        func: (collider: PhysicsImpostor, collidedAgainst: PhysicsImpostor | Array<PhysicsImpostor>, point: Nullable<Vector3>) => void\r\n    ): void {\r\n        const collidedAgainstList: Array<PhysicsImpostor> = collideAgainst instanceof Array ? <Array<PhysicsImpostor>>collideAgainst : [<PhysicsImpostor>collideAgainst];\r\n        let index = -1;\r\n        const found = this._onPhysicsCollideCallbacks.some((cbDef, idx) => {\r\n            if (cbDef.callback === func && cbDef.otherImpostors.length === collidedAgainstList.length) {\r\n                // chcek the arrays match\r\n                const sameList = cbDef.otherImpostors.every((impostor) => {\r\n                    return collidedAgainstList.indexOf(impostor) > -1;\r\n                });\r\n                if (sameList) {\r\n                    index = idx;\r\n                }\r\n                return sameList;\r\n            }\r\n            return false;\r\n        });\r\n\r\n        if (found) {\r\n            this._onPhysicsCollideCallbacks.splice(index, 1);\r\n        } else {\r\n            Logger.Warn(\"Function to remove was not found\");\r\n        }\r\n    }\r\n\r\n    //temp variables for parent rotation calculations\r\n    //private _mats: Array<Matrix> = [new Matrix(), new Matrix()];\r\n    private _tmpQuat: Quaternion = new Quaternion();\r\n    private _tmpQuat2: Quaternion = new Quaternion();\r\n\r\n    /**\r\n     * Get the parent rotation\r\n     * @returns The parent rotation\r\n     */\r\n    public getParentsRotation(): Quaternion {\r\n        let parent = this.object.parent;\r\n        this._tmpQuat.copyFromFloats(0, 0, 0, 1);\r\n        while (parent) {\r\n            if (parent.rotationQuaternion) {\r\n                this._tmpQuat2.copyFrom(parent.rotationQuaternion);\r\n            } else {\r\n                Quaternion.RotationYawPitchRollToRef(parent.rotation.y, parent.rotation.x, parent.rotation.z, this._tmpQuat2);\r\n            }\r\n            this._tmpQuat.multiplyToRef(this._tmpQuat2, this._tmpQuat);\r\n            parent = parent.parent;\r\n        }\r\n        return this._tmpQuat;\r\n    }\r\n\r\n    /**\r\n     * this function is executed by the physics engine.\r\n     */\r\n    public beforeStep = () => {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n\r\n        this.object.translate(this._deltaPosition, -1);\r\n        this._deltaRotationConjugated &&\r\n            this.object.rotationQuaternion &&\r\n            this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated, this.object.rotationQuaternion);\r\n        this.object.computeWorldMatrix(false);\r\n        if (this.object.parent && this.object.rotationQuaternion) {\r\n            this.getParentsRotation();\r\n            this._tmpQuat.multiplyToRef(this.object.rotationQuaternion, this._tmpQuat);\r\n        } else {\r\n            this._tmpQuat.copyFrom(this.object.rotationQuaternion || new Quaternion());\r\n        }\r\n        if (!this._options.disableBidirectionalTransformation) {\r\n            this.object.rotationQuaternion &&\r\n                this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this, /*bInfo.boundingBox.centerWorld*/ this.object.getAbsolutePosition(), this._tmpQuat);\r\n        }\r\n\r\n        this._onBeforePhysicsStepCallbacks.forEach((func) => {\r\n            func(this);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * this function is executed by the physics engine\r\n     */\r\n    public afterStep = () => {\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n\r\n        this._onAfterPhysicsStepCallbacks.forEach((func) => {\r\n            func(this);\r\n        });\r\n\r\n        this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this);\r\n        // object has now its world rotation. needs to be converted to local.\r\n        if (this.object.parent && this.object.rotationQuaternion) {\r\n            this.getParentsRotation();\r\n            this._tmpQuat.conjugateInPlace();\r\n            this._tmpQuat.multiplyToRef(this.object.rotationQuaternion, this.object.rotationQuaternion);\r\n        }\r\n        // take the position set and make it the absolute position of this object.\r\n        this.object.setAbsolutePosition(this.object.position);\r\n        if (this._deltaRotation) {\r\n            this.object.rotationQuaternion && this.object.rotationQuaternion.multiplyToRef(this._deltaRotation, this.object.rotationQuaternion);\r\n            this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation, PhysicsImpostor._TmpVecs[0]);\r\n            this.object.translate(PhysicsImpostor._TmpVecs[0], 1);\r\n        } else {\r\n            this.object.translate(this._deltaPosition, 1);\r\n        }\r\n        this.object.computeWorldMatrix(true);\r\n    };\r\n\r\n    /**\r\n     * Legacy collision detection event support\r\n     */\r\n    public onCollideEvent: Nullable<(collider: PhysicsImpostor, collidedWith: PhysicsImpostor) => void> = null;\r\n\r\n    /**\r\n     *\r\n     * @param e\r\n     * @returns\r\n     */\r\n    public onCollide = (e: { body: any; point: Nullable<Vector3>; distance: number; impulse: number; normal: Nullable<Vector3> }) => {\r\n        if (!this._onPhysicsCollideCallbacks.length && !this.onCollideEvent) {\r\n            return;\r\n        }\r\n\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n        const otherImpostor = this._physicsEngine.getImpostorWithPhysicsBody(e.body);\r\n        if (otherImpostor) {\r\n            // Legacy collision detection event support\r\n            if (this.onCollideEvent) {\r\n                this.onCollideEvent(this, otherImpostor);\r\n            }\r\n            this._onPhysicsCollideCallbacks\r\n                .filter((obj) => {\r\n                    return obj.otherImpostors.indexOf(<PhysicsImpostor>otherImpostor) !== -1;\r\n                })\r\n                .forEach((obj) => {\r\n                    obj.callback(this, <PhysicsImpostor>otherImpostor, e.point, e.distance, e.impulse, e.normal);\r\n                });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Apply a force\r\n     * @param force The force to apply\r\n     * @param contactPoint The contact point for the force\r\n     * @returns The physics imposter\r\n     */\r\n    public applyForce(force: Vector3, contactPoint: Vector3): PhysicsImpostor {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().applyForce(this, force, contactPoint);\r\n        }\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Apply an impulse\r\n     * @param force The impulse force\r\n     * @param contactPoint The contact point for the impulse force\r\n     * @returns The physics imposter\r\n     */\r\n    public applyImpulse(force: Vector3, contactPoint: Vector3): PhysicsImpostor {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().applyImpulse(this, force, contactPoint);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * A help function to create a joint\r\n     * @param otherImpostor A physics imposter used to create a joint\r\n     * @param jointType The type of joint\r\n     * @param jointData The data for the joint\r\n     * @returns The physics imposter\r\n     */\r\n    public createJoint(otherImpostor: PhysicsImpostor, jointType: number, jointData: PhysicsJointData): PhysicsImpostor {\r\n        const joint = new PhysicsJoint(jointType, jointData);\r\n        this.addJoint(otherImpostor, joint);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Add a joint to this impostor with a different impostor\r\n     * @param otherImpostor A physics imposter used to add a joint\r\n     * @param joint The joint to add\r\n     * @returns The physics imposter\r\n     */\r\n    public addJoint(otherImpostor: PhysicsImpostor, joint: PhysicsJoint): PhysicsImpostor {\r\n        this._joints.push({\r\n            otherImpostor: otherImpostor,\r\n            joint: joint,\r\n        });\r\n\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.addJoint(this, otherImpostor, joint);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Add an anchor to a cloth impostor\r\n     * @param otherImpostor rigid impostor to anchor to\r\n     * @param width ratio across width from 0 to 1\r\n     * @param height ratio up height from 0 to 1\r\n     * @param influence the elasticity between cloth impostor and anchor from 0, very stretchy to 1, little stretch\r\n     * @param noCollisionBetweenLinkedBodies when true collisions between cloth impostor and anchor are ignored; default false\r\n     * @returns impostor the soft imposter\r\n     */\r\n    public addAnchor(otherImpostor: PhysicsImpostor, width: number, height: number, influence: number, noCollisionBetweenLinkedBodies: boolean): PhysicsImpostor {\r\n        if (!this._physicsEngine) {\r\n            return this;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.appendAnchor) {\r\n            return this;\r\n        }\r\n        if (this._physicsEngine) {\r\n            plugin.appendAnchor!(this, otherImpostor, width, height, influence, noCollisionBetweenLinkedBodies);\r\n        }\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Add a hook to a rope impostor\r\n     * @param otherImpostor rigid impostor to anchor to\r\n     * @param length ratio across rope from 0 to 1\r\n     * @param influence the elasticity between rope impostor and anchor from 0, very stretchy to 1, little stretch\r\n     * @param noCollisionBetweenLinkedBodies when true collisions between soft impostor and anchor are ignored; default false\r\n     * @returns impostor the rope imposter\r\n     */\r\n    public addHook(otherImpostor: PhysicsImpostor, length: number, influence: number, noCollisionBetweenLinkedBodies: boolean): PhysicsImpostor {\r\n        if (!this._physicsEngine) {\r\n            return this;\r\n        }\r\n        const plugin = this._physicsEngine.getPhysicsPlugin();\r\n        if (!plugin.appendAnchor) {\r\n            return this;\r\n        }\r\n        if (this._physicsEngine) {\r\n            plugin.appendHook!(this, otherImpostor, length, influence, noCollisionBetweenLinkedBodies);\r\n        }\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Will keep this body still, in a sleep mode.\r\n     * @returns the physics imposter\r\n     */\r\n    public sleep(): PhysicsImpostor {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().sleepBody(this);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Wake the body up.\r\n     * @returns The physics imposter\r\n     */\r\n    public wakeUp(): PhysicsImpostor {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().wakeUpBody(this);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Clones the physics imposter\r\n     * @param newObject The physics imposter clones to this physics-enabled object\r\n     * @returns A nullable physics imposter\r\n     */\r\n    public clone(newObject: IPhysicsEnabledObject): Nullable<PhysicsImpostor> {\r\n        if (!newObject) {\r\n            return null;\r\n        }\r\n        return new PhysicsImpostor(newObject, this.type, this._options, this._scene);\r\n    }\r\n\r\n    /**\r\n     * Disposes the physics imposter\r\n     */\r\n    public dispose(/*disposeChildren: boolean = true*/) {\r\n        //no dispose if no physics engine is available.\r\n        if (!this._physicsEngine) {\r\n            return;\r\n        }\r\n\r\n        this._joints.forEach((j) => {\r\n            if (this._physicsEngine) {\r\n                this._physicsEngine.removeJoint(this, j.otherImpostor, j.joint);\r\n            }\r\n        });\r\n        //dispose the physics body\r\n        this._physicsEngine.removeImpostor(this);\r\n        if (this.parent) {\r\n            this.parent.forceUpdate();\r\n        } else {\r\n            /*this._object.getChildMeshes().forEach(function(mesh) {\r\n                if (mesh.physicsImpostor) {\r\n                    if (disposeChildren) {\r\n                        mesh.physicsImpostor.dispose();\r\n                        mesh.physicsImpostor = null;\r\n                    }\r\n                }\r\n            })*/\r\n        }\r\n\r\n        this._isDisposed = true;\r\n    }\r\n\r\n    /**\r\n     * Sets the delta position\r\n     * @param position The delta position amount\r\n     */\r\n    public setDeltaPosition(position: Vector3) {\r\n        this._deltaPosition.copyFrom(position);\r\n    }\r\n\r\n    /**\r\n     * Sets the delta rotation\r\n     * @param rotation The delta rotation amount\r\n     */\r\n    public setDeltaRotation(rotation: Quaternion) {\r\n        if (!this._deltaRotation) {\r\n            this._deltaRotation = new Quaternion();\r\n        }\r\n        this._deltaRotation.copyFrom(rotation);\r\n        this._deltaRotationConjugated = this._deltaRotation.conjugate();\r\n    }\r\n\r\n    /**\r\n     * Gets the box size of the physics imposter and stores the result in the input parameter\r\n     * @param result Stores the box size\r\n     * @returns The physics imposter\r\n     */\r\n    public getBoxSizeToRef(result: Vector3): PhysicsImpostor {\r\n        if (this._physicsEngine) {\r\n            this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this, result);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Gets the radius of the physics imposter\r\n     * @returns Radius of the physics imposter\r\n     */\r\n    public getRadius(): number {\r\n        return this._physicsEngine ? this._physicsEngine.getPhysicsPlugin().getRadius(this) : 0;\r\n    }\r\n\r\n    /**\r\n     * Sync a bone with this impostor\r\n     * @param bone The bone to sync to the impostor.\r\n     * @param boneMesh The mesh that the bone is influencing.\r\n     * @param jointPivot The pivot of the joint / bone in local space.\r\n     * @param distToJoint Optional distance from the impostor to the joint.\r\n     * @param adjustRotation Optional quaternion for adjusting the local rotation of the bone.\r\n     */\r\n    public syncBoneWithImpostor(bone: Bone, boneMesh: AbstractMesh, jointPivot: Vector3, distToJoint?: number, adjustRotation?: Quaternion) {\r\n        const tempVec = PhysicsImpostor._TmpVecs[0];\r\n        const mesh = <AbstractMesh>this.object;\r\n\r\n        if (mesh.rotationQuaternion) {\r\n            if (adjustRotation) {\r\n                const tempQuat = PhysicsImpostor._TmpQuat;\r\n                mesh.rotationQuaternion.multiplyToRef(adjustRotation, tempQuat);\r\n                bone.setRotationQuaternion(tempQuat, Space.WORLD, boneMesh);\r\n            } else {\r\n                bone.setRotationQuaternion(mesh.rotationQuaternion, Space.WORLD, boneMesh);\r\n            }\r\n        }\r\n\r\n        tempVec.x = 0;\r\n        tempVec.y = 0;\r\n        tempVec.z = 0;\r\n\r\n        if (jointPivot) {\r\n            tempVec.x = jointPivot.x;\r\n            tempVec.y = jointPivot.y;\r\n            tempVec.z = jointPivot.z;\r\n\r\n            bone.getDirectionToRef(tempVec, boneMesh, tempVec);\r\n\r\n            if (distToJoint === undefined || distToJoint === null) {\r\n                distToJoint = jointPivot.length();\r\n            }\r\n\r\n            tempVec.x *= distToJoint;\r\n            tempVec.y *= distToJoint;\r\n            tempVec.z *= distToJoint;\r\n        }\r\n\r\n        if (bone.getParent()) {\r\n            tempVec.addInPlace(mesh.getAbsolutePosition());\r\n            bone.setAbsolutePosition(tempVec, boneMesh);\r\n        } else {\r\n            boneMesh.setAbsolutePosition(mesh.getAbsolutePosition());\r\n            boneMesh.position.x -= tempVec.x;\r\n            boneMesh.position.y -= tempVec.y;\r\n            boneMesh.position.z -= tempVec.z;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sync impostor to a bone\r\n     * @param bone The bone that the impostor will be synced to.\r\n     * @param boneMesh The mesh that the bone is influencing.\r\n     * @param jointPivot The pivot of the joint / bone in local space.\r\n     * @param distToJoint Optional distance from the impostor to the joint.\r\n     * @param adjustRotation Optional quaternion for adjusting the local rotation of the bone.\r\n     * @param boneAxis Optional vector3 axis the bone is aligned with\r\n     */\r\n    public syncImpostorWithBone(bone: Bone, boneMesh: AbstractMesh, jointPivot: Vector3, distToJoint?: number, adjustRotation?: Quaternion, boneAxis?: Vector3) {\r\n        const mesh = <AbstractMesh>this.object;\r\n\r\n        if (mesh.rotationQuaternion) {\r\n            if (adjustRotation) {\r\n                const tempQuat = PhysicsImpostor._TmpQuat;\r\n                bone.getRotationQuaternionToRef(Space.WORLD, boneMesh, tempQuat);\r\n                tempQuat.multiplyToRef(adjustRotation, mesh.rotationQuaternion);\r\n            } else {\r\n                bone.getRotationQuaternionToRef(Space.WORLD, boneMesh, mesh.rotationQuaternion);\r\n            }\r\n        }\r\n\r\n        const pos = PhysicsImpostor._TmpVecs[0];\r\n        const boneDir = PhysicsImpostor._TmpVecs[1];\r\n\r\n        if (!boneAxis) {\r\n            boneAxis = PhysicsImpostor._TmpVecs[2];\r\n            boneAxis.x = 0;\r\n            boneAxis.y = 1;\r\n            boneAxis.z = 0;\r\n        }\r\n\r\n        bone.getDirectionToRef(boneAxis, boneMesh, boneDir);\r\n        bone.getAbsolutePositionToRef(boneMesh, pos);\r\n\r\n        if ((distToJoint === undefined || distToJoint === null) && jointPivot) {\r\n            distToJoint = jointPivot.length();\r\n        }\r\n\r\n        if (distToJoint !== undefined && distToJoint !== null) {\r\n            pos.x += boneDir.x * distToJoint;\r\n            pos.y += boneDir.y * distToJoint;\r\n            pos.z += boneDir.z * distToJoint;\r\n        }\r\n\r\n        mesh.setAbsolutePosition(pos);\r\n    }\r\n\r\n    //Impostor types\r\n    /**\r\n     * No-Imposter type\r\n     */\r\n    public static NoImpostor = 0;\r\n    /**\r\n     * Sphere-Imposter type\r\n     */\r\n    public static SphereImpostor = 1;\r\n    /**\r\n     * Box-Imposter type\r\n     */\r\n    public static BoxImpostor = 2;\r\n    /**\r\n     * Plane-Imposter type\r\n     */\r\n    public static PlaneImpostor = 3;\r\n    /**\r\n     * Mesh-imposter type (Only available to objects with vertices data)\r\n     */\r\n    public static MeshImpostor = 4;\r\n    /**\r\n     * Capsule-Impostor type (Ammo.js plugin only)\r\n     */\r\n    public static CapsuleImpostor = 6;\r\n    /**\r\n     * Cylinder-Imposter type\r\n     */\r\n    public static CylinderImpostor = 7;\r\n    /**\r\n     * Particle-Imposter type\r\n     */\r\n    public static ParticleImpostor = 8;\r\n    /**\r\n     * Heightmap-Imposter type\r\n     */\r\n    public static HeightmapImpostor = 9;\r\n    /**\r\n     * ConvexHull-Impostor type (Ammo.js plugin only)\r\n     */\r\n    public static ConvexHullImpostor = 10;\r\n    /**\r\n     * Custom-Imposter type (Ammo.js plugin only)\r\n     */\r\n    public static CustomImpostor = 100;\r\n    /**\r\n     * Rope-Imposter type\r\n     */\r\n    public static RopeImpostor = 101;\r\n    /**\r\n     * Cloth-Imposter type\r\n     */\r\n    public static ClothImpostor = 102;\r\n    /**\r\n     * Softbody-Imposter type\r\n     */\r\n    public static SoftbodyImpostor = 103;\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}